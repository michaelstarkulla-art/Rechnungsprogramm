<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rechnungsprogramm</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      .print-only { display: inline !important; }
      body { background: white !important; margin: 0; }
      #rechnung-druck {
        box-shadow: none !important;
        background: white !important;
        margin: 0 !important;
        padding: 25mm 20mm 45mm 25mm !important;
      }
      .page-footer {
        position: fixed !important;
        bottom: 12mm !important;
        left: 25mm !important;
        right: 20mm !important;
        height: 28mm;
        margin: 0;
        padding: 0;
        font-size: 9pt;
        color: #444;
        z-index: 100;
        background: white;
        border-top: 1px solid #ccc;
      }
      .page-content {
        padding-bottom: 50mm;
      }
      tr { page-break-inside: avoid; }
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #0d9488; border-radius: 10px; }
    textarea { overflow: hidden; resize: none; min-height: 1.5rem; }
    .print-only { display: none; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * START-MODAL - Datenschutzhinweis beim ersten Laden
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .start-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(6px);
      z-index: 999999; display: flex; align-items: center; justify-content: center;
      padding: 16px; opacity: 1; transition: opacity 0.3s ease;
    }
    .start-modal-overlay.hidden { opacity: 0; pointer-events: none; display: none !important; }
    .start-modal {
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px; max-width: 420px; width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(13, 148, 136, 0.3); overflow: hidden;
      animation: modalSlideIn 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    @keyframes modalSlideIn {
      from { transform: translateY(-20px) scale(0.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .start-modal-header {
      padding: 20px 24px 16px; text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .start-modal-header .shield-icon { font-size: 2rem; margin-bottom: 8px; }
    .start-modal-motto { margin-bottom: 10px; }
    .start-modal-motto p { color: #2dd4bf; font-size: 1rem; font-weight: 700; margin: 0; letter-spacing: 0.5px; }
    .start-modal-header h2 { color: #94a3b8; margin: 0; font-size: 0.85rem; font-weight: 500; }
    .start-modal-body { padding: 20px 24px; color: #e2e8f0; }
    .start-modal-intro { color: #94a3b8; font-size: 0.8rem; margin-bottom: 14px; line-height: 1.5; }
    .info-item {
      display: flex; gap: 10px; margin-bottom: 10px; padding: 10px;
      background: rgba(255, 255, 255, 0.02); border-radius: 6px;
      border-left: 2px solid rgba(255, 255, 255, 0.15);
    }
    .info-item.warning { border-left-color: rgba(245, 158, 11, 0.5); }
    .info-item.danger { border-left-color: rgba(239, 68, 68, 0.5); }
    .info-item.success { border-left-color: rgba(34, 197, 94, 0.5); }
    .info-item .icon { font-size: 1rem; flex-shrink: 0; opacity: 0.8; }
    .info-item .text { flex: 1; }
    .info-item .text strong { color: #cbd5e1; display: block; margin-bottom: 2px; font-size: 0.75rem; }
    .info-item .text span { color: #64748b; font-size: 0.7rem; line-height: 1.4; }
    .start-modal-features { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255, 255, 255, 0.06); }
    .feature-badges { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .feature-badge {
      background: rgba(13, 148, 136, 0.15); color: #2dd4bf;
      padding: 4px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 500;
      border: 1px solid rgba(13, 148, 136, 0.3);
    }
    .start-modal-footer { padding: 16px 24px 20px; text-align: center; }
    .start-modal-footer button {
      width: 100%; padding: 12px 24px; font-size: 0.85rem; font-weight: 600;
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
      color: white; border: none; border-radius: 8px; cursor: pointer;
      transition: all 0.2s ease; box-shadow: 0 2px 12px rgba(13, 148, 136, 0.25);
    }
    .start-modal-footer button:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(13, 148, 136, 0.35); }
    .start-modal-footer small { display: block; margin-top: 10px; color: #475569; font-size: 0.65rem; }

    /* Privacy Footer - Einfacher FuÃŸbereich */
    .privacy-footer {
      margin: 20px auto;
      padding: 1.5rem;
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 12px;
      border: 1px solid rgba(13, 148, 136, 0.2);
      text-align: center;
      max-width: 800px;
      width: 100%;
      box-sizing: border-box;
    }
    .privacy-footer-motto { font-size: 0.95rem; font-weight: 700; color: #2dd4bf; margin-bottom: 12px; letter-spacing: 0.5px; }
    .privacy-footer-motto .shield { font-size: 1.1rem; margin-right: 6px; }
    .privacy-footer-text { color: #94a3b8; font-size: 0.8rem; line-height: 1.6; max-width: 600px; margin: 0 auto 16px; }
    .privacy-footer-badges { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 12px; }
    .privacy-badge {
      display: inline-flex; align-items: center; gap: 4px;
      background: rgba(13, 148, 136, 0.1); color: #5eead4;
      padding: 6px 10px; border-radius: 16px; font-size: 0.7rem; font-weight: 500;
      border: 1px solid rgba(13, 148, 136, 0.2);
    }
    .privacy-badge.green { background: rgba(34, 197, 94, 0.1); color: #4ade80; border-color: rgba(34, 197, 94, 0.2); }
    .privacy-footer-copyright { margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.08); color: #64748b; font-size: 0.65rem; }
    
    /* Mobile: Privacy Footer Anpassungen */
    @media (max-width: 767px) {
      .privacy-footer {
        margin: 20px 10px 100px 10px;
        padding: 1rem;
      }
      .privacy-footer-badges { gap: 6px; }
      .privacy-badge { padding: 4px 8px; font-size: 0.6rem; }
      .privacy-footer-text { font-size: 0.7rem; }
      .privacy-footer-motto { font-size: 0.85rem; }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * MOBILE-FIRST RESPONSIVE LAYOUT
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Sidebar - Standard: Versteckt auf Mobile */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 45;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 44;
      backdrop-filter: blur(2px);
    }
    
    .sidebar-backdrop.open {
      display: block;
    }
    
    .main-content {
      width: 100%;
    }

    /* Desktop: Sidebar sichtbar - NUR wenn Breite >= 1024px UND HÃ¶he >= 600px */
    /* Das verhindert dass Smartphones im Querformat die Desktop-Ansicht bekommen */
    @media (min-width: 1024px) and (min-height: 600px) {
      .sidebar {
        position: relative;
        transform: translateX(0);
        z-index: 1;
        width: 24rem; /* w-96 */
        flex-shrink: 0;
      }
      
      .sidebar-backdrop {
        display: none !important;
      }
      
      .main-content {
        flex: 1;
        padding-top: 0 !important;
      }
      
      /* Action-Bar mit Sidebar-Offset nur auf echtem Desktop */
      .action-bar-mobile {
        left: 24rem !important;
      }
      
      /* Mobile Header auf echtem Desktop ausblenden */
      .mobile-header {
        display: none !important;
      }
    }
    
    /* Zwischen 768px und 1024px: Tailwind md: Klassen Ã¼berschreiben */
    @media (min-width: 768px) and (max-width: 1023px) {
      .action-bar-mobile {
        left: 0 !important;
      }
    }
    
    /* Cloud-Sync Spinner Animation */
    @keyframes cloud-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-cloud-spin {
      animation: cloud-spin 1s linear infinite;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â• HIGH-FIDELITY PREVIEW CSS â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Inputs die wie Text aussehen */
    .paper-input {
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      width: 100%;
      transition: all 0.2s;
    }
    .paper-input:hover { border-bottom-color: #ccc; }
    .paper-input:focus { 
      outline: none; 
      border-bottom: 1px solid #10b981;
      background: rgba(16, 185, 129, 0.05);
    }
    .paper-textarea {
      width: 100%;
      background: transparent;
      border: none;
      resize: vertical;
      min-height: 20px;
      border-left: 2px solid transparent;
      padding-left: 0;
    }
    .paper-textarea:hover { border-left-color: #ccc; padding-left: 5px; }
    .paper-textarea:focus { 
      outline: none; 
      border-left-color: #10b981; 
      background: rgba(16, 185, 129, 0.05);
      padding-left: 5px;
    }
    
    /* Preview Scroll Container */
    .preview-scroll-area {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }
    
    @media (max-width: 767px) {
      .preview-scroll-area {
        padding: 5px;
      }
    }
    
    /* A4 Seite */
    .a4-preview {
      width: 210mm;
      min-width: 210mm;
      min-height: 297mm;
      height: auto;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      position: relative;
      transform-origin: top left;
      transition: transform 0.2s ease;
      margin: 0 auto;
    }
    
    /* Mobile: Dokument links positionieren */
    @media (max-width: 767px) {
      .a4-preview {
        margin: 0;
        transform-origin: top left;
      }
    }
    
    /* Mobile: Dokument links ausrichten damit es beim Ã–ffnen sichtbar ist */
    @media (max-width: 767px) {
      .a4-preview {
        margin: 0; /* Links ausrichten statt zentriert */
        transform-origin: top left;
      }
    }
    
    /* Mobile: Falzmarken ausblenden */
    @media (max-width: 767px) {
      .falzmarke {
        display: none !important;
      }
    }
    
    /* Page Footer - am unteren Rand des A4-Blattes */
    .a4-preview .page-footer {
      font-size: 9pt;
      color: #444;
      border-top: 1px solid #ccc;
      padding: 3mm 20mm 15mm 25mm;
      margin-top: 15mm;
    }
    
    /* Page Content - dynamisch wachsend */
    .a4-preview .page-content {
      padding: 25mm 20mm 0 25mm;
    }
    
    /* Falzmarken */
    .falzmarke { position: absolute; left: 0; width: 8mm; height: 0; border-top: 1px solid #ccc; z-index: 5; }
    .falzmarke-1 { top: 105mm; }
    .falzmarke-2 { top: 210mm; }
    .falzmarke-3 { top: 148.5mm; width: 12mm; border-top: 1px solid #999; }
    
    /* Zoom Toolbar - auf allen GerÃ¤ten sichtbar */
    .zoom-toolbar {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      z-index: 10;
      flex-shrink: 0;
    }
    
    @media (max-width: 767px) {
      .zoom-toolbar {
        padding: 6px 10px;
      }
    }
    
    /* Querformat auf Smartphones: Zoom-Toolbar sichtbar machen */
    @media (max-height: 500px) and (orientation: landscape) {
      .zoom-toolbar {
        padding: 4px 10px;
        position: sticky;
        top: 0;
      }
      
      .main-content {
        padding-top: 56px !important; /* Platz fÃ¼r mobile-header */
      }
    }
  </style>
</head>
<body class="bg-slate-100 font-sans antialiased">

<!-- Start-Modal - Datenschutz & Sicherheitshinweis -->
<div id="start-modal-overlay" class="start-modal-overlay">
  <div class="start-modal">
    <div class="start-modal-header">
      <div class="shield-icon">ğŸ›¡ï¸</div>
      <div class="start-modal-motto">
        <p>Wir speichern nichts. Wir sehen nichts.</p>
      </div>
      <h2>Lokale Browser-Anwendung Â· Rechnungsprogramm</h2>
    </div>
    <div class="start-modal-body">
      <p class="start-modal-intro">
        Deine Daten werden lokal in deinem Browser gespeichert (IndexedDB) â€“ niemals auf externen Servern.
      </p>
      <div class="info-item success">
        <span class="icon">ğŸ’¾</span>
        <div class="text">
          <strong>Lokale Speicherung</strong>
          <span>Deine Daten bleiben auch nach dem SchlieÃŸen des Browsers erhalten. Aber: Bei Browser-LÃ¶schung oder GerÃ¤tewechsel gehen sie verloren!</span>
        </div>
      </div>
      <div class="info-item warning">
        <span class="icon">ğŸ“¤</span>
        <div class="text">
          <strong>RegelmÃ¤ÃŸige Backups</strong>
          <span>Erstelle regelmÃ¤ÃŸig verschlÃ¼sselte Backups, um deine Daten zu sichern und auf andere GerÃ¤te zu Ã¼bertragen.</span>
        </div>
      </div>
      <div class="info-item danger">
        <span class="icon">ğŸ”‘</span>
        <div class="text">
          <strong>Passwort</strong>
          <span>Es gibt keine Wiederherstellung. Ohne Passwort ist dein Backup wertlos â€“ merke es dir gut!</span>
        </div>
      </div>
      <div class="info-item">
        <span class="icon">âš–ï¸</span>
        <div class="text">
          <strong>Haftung</strong>
          <span>Nutzung auf eigene Verantwortung. Keine Haftung fÃ¼r Datenverlust oder SchÃ¤den.</span>
        </div>
      </div>
      <div class="start-modal-features">
        <div class="feature-badges">
          <span class="feature-badge">ğŸ”’ AES-256-GCM</span>
          <span class="feature-badge">ğŸš« Keine Server</span>
          <span class="feature-badge">ğŸ’¾ 5MB Fixed-Size</span>
          <span class="feature-badge">ğŸ‘ï¸ Zero-Knowledge</span>
          <span class="feature-badge">ğŸ”§ Web Worker</span>
        </div>
      </div>
    </div>
    <div class="start-modal-footer">
      <button onclick="closeStartModal()">âœ“ Ich habe alles verstanden</button>
      <small>Deine Zustimmung wird lokal fÃ¼r diese Sitzung gespeichert</small>
    </div>
  </div>
</div>

<script>
function closeStartModal() {
  const overlay = document.getElementById('start-modal-overlay');
  overlay.classList.add('hidden');
  setTimeout(() => { overlay.style.display = 'none'; }, 300);
  sessionStorage.setItem('rechnungsprogrammfast_modal_accepted', 'true');
}
// Nur verstecken wenn User explizit akzeptiert hat
if (sessionStorage.getItem('rechnungsprogrammfast_modal_accepted') === 'true') {
  document.getElementById('start-modal-overlay').style.display = 'none';
}
</script>

<div id="root"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIGH-SECURITY VAULT - Single-Blob mit Privacy Padding
// AES-256-GCM + Web Worker + 5MB Privacy-Preserving Architecture
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VAULT_CONFIG = {
  algorithm: 'AES-GCM',
  keyLength: 256,
  ivLength: 12,
  saltLength: 16,
  iterations: 310000, // OWASP 2023 Empfehlung
  tagLength: 128,
  FIXED_SIZE: 5 * 1024 * 1024, // 5 MB Fixed-Size zur Verschleierung der tatsÃ¤chlichen Datenmenge (Privacy Padding)
  DB_NAME: 'SecureVaultDB',
  STORE_NAME: 'secure_vault',
  KEY_NAME: 'current_state',
  DEBOUNCE_MS: 2000 // 2 Sekunden Debounce
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB WORKER (Inline als Blob-URL) - VerschlÃ¼sselung im Hintergrund
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const workerCode = `
// Worker fÃ¼r rechenintensive VerschlÃ¼sselung
const VAULT_CONFIG = {
  algorithm: 'AES-GCM',
  keyLength: 256,
  ivLength: 12,
  saltLength: 16,
  iterations: 310000,
  tagLength: 128,
  FIXED_SIZE: 5 * 1024 * 1024,
  MAX_RANDOM_CHUNK: 65536 // crypto.getRandomValues() Limit
};

function generateRandomBytes(length) {
  // FÃ¼r kleine LÃ¤ngen direkt generieren
  if (length <= VAULT_CONFIG.MAX_RANDOM_CHUNK) {
    return crypto.getRandomValues(new Uint8Array(length));
  }
  
  // FÃ¼r groÃŸe LÃ¤ngen in Chunks aufteilen
  const result = new Uint8Array(length);
  let offset = 0;
  while (offset < length) {
    const chunkSize = Math.min(VAULT_CONFIG.MAX_RANDOM_CHUNK, length - offset);
    const chunk = crypto.getRandomValues(new Uint8Array(chunkSize));
    result.set(chunk, offset);
    offset += chunkSize;
  }
  return result;
}

async function deriveKey(password, salt) {
  const encoder = new TextEncoder();
  const passwordBuffer = encoder.encode(password);
  const baseKey = await crypto.subtle.importKey('raw', passwordBuffer, 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: VAULT_CONFIG.iterations, hash: 'SHA-256' },
    baseKey,
    { name: VAULT_CONFIG.algorithm, length: VAULT_CONFIG.keyLength },
    true, ['encrypt', 'decrypt']
  );
}

// Fixed-Size Padding: FÃ¼gt kryptografisches Rauschen hinzu bis exakt 5MB erreicht sind
function padToFixedSize(dataBuffer, targetSize) {
  const dataLength = dataBuffer.byteLength;
  // 4 Bytes fÃ¼r LÃ¤ngenfeld + Daten + Padding
  const paddingNeeded = targetSize - 4 - dataLength;
  
  if (paddingNeeded < 0) {
    throw new Error('Daten zu groÃŸ fÃ¼r Fixed-Size Container (' + dataLength + ' Bytes > ' + (targetSize - 4) + ' max)');
  }
  
  const result = new Uint8Array(targetSize);
  const view = new DataView(result.buffer);
  
  // Erste 4 Bytes: tatsÃ¤chliche DatenlÃ¤nge (Big-Endian)
  view.setUint32(0, dataLength, false);
  
  // Daten kopieren
  result.set(new Uint8Array(dataBuffer), 4);
  
  // Rest mit kryptografischem Zufallsrauschen fÃ¼llen (in Chunks)
  const padding = generateRandomBytes(paddingNeeded);
  result.set(padding, 4 + dataLength);
  
  return result;
}

// Fixed-Size Unpadding: Extrahiert die echten Daten aus dem 5MB Block
function unpadFromFixedSize(paddedBuffer) {
  const view = new DataView(paddedBuffer);
  const dataLength = view.getUint32(0, false);
  
  if (dataLength > paddedBuffer.byteLength - 4) {
    throw new Error('UngÃ¼ltige DatenlÃ¤nge im Header');
  }
  
  return paddedBuffer.slice(4, 4 + dataLength);
}

// VerschlÃ¼sselung mit Fixed-Size Padding
async function encryptWithPadding(data, password, useFixedSize = true) {
  const jsonString = JSON.stringify(data);
  const encoder = new TextEncoder();
  let dataBuffer = encoder.encode(jsonString);
  
  // Fixed-Size Padding anwenden wenn gewÃ¼nscht
  if (useFixedSize) {
    dataBuffer = padToFixedSize(dataBuffer, VAULT_CONFIG.FIXED_SIZE - VAULT_CONFIG.saltLength - VAULT_CONFIG.ivLength - 16);
  }
  
  const salt = generateRandomBytes(VAULT_CONFIG.saltLength);
  const iv = generateRandomBytes(VAULT_CONFIG.ivLength);
  const key = await deriveKey(password, salt);
  
  const encryptedData = await crypto.subtle.encrypt(
    { name: VAULT_CONFIG.algorithm, iv: iv, tagLength: VAULT_CONFIG.tagLength },
    key, dataBuffer
  );
  
  const result = new Uint8Array(VAULT_CONFIG.saltLength + VAULT_CONFIG.ivLength + encryptedData.byteLength);
  result.set(salt, 0);
  result.set(iv, VAULT_CONFIG.saltLength);
  result.set(new Uint8Array(encryptedData), VAULT_CONFIG.saltLength + VAULT_CONFIG.ivLength);
  
  return result.buffer;
}

// EntschlÃ¼sselung mit Fixed-Size Unpadding
async function decryptWithPadding(encryptedBuffer, password, useFixedSize = true) {
  const encryptedArray = new Uint8Array(encryptedBuffer);
  const salt = encryptedArray.slice(0, VAULT_CONFIG.saltLength);
  const iv = encryptedArray.slice(VAULT_CONFIG.saltLength, VAULT_CONFIG.saltLength + VAULT_CONFIG.ivLength);
  const ciphertext = encryptedArray.slice(VAULT_CONFIG.saltLength + VAULT_CONFIG.ivLength);
  
  const key = await deriveKey(password, salt);
  
  let decryptedBuffer = await crypto.subtle.decrypt(
    { name: VAULT_CONFIG.algorithm, iv: iv, tagLength: VAULT_CONFIG.tagLength },
    key, ciphertext
  );
  
  // Fixed-Size Unpadding wenn gewÃ¼nscht
  if (useFixedSize) {
    decryptedBuffer = unpadFromFixedSize(decryptedBuffer);
  }
  
  const decoder = new TextDecoder();
  return JSON.parse(decoder.decode(decryptedBuffer));
}

// Worker Message Handler
self.onmessage = async (e) => {
  const { type, data, password, useFixedSize, id } = e.data;
  
  try {
    if (type === 'encrypt') {
      const encrypted = await encryptWithPadding(data, password, useFixedSize);
      self.postMessage({ type: 'encrypted', data: encrypted, id, success: true });
    } else if (type === 'decrypt') {
      const decrypted = await decryptWithPadding(data, password, useFixedSize);
      self.postMessage({ type: 'decrypted', data: decrypted, id, success: true });
    }
  } catch (error) {
    self.postMessage({ type: 'error', error: error.message, id, success: false });
  }
};
`;

// Worker als Blob-URL erstellen (funktioniert lokal ohne Server)
const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
const workerUrl = URL.createObjectURL(workerBlob);
let cryptoWorker = null;
let workerCallbacks = new Map();
let workerIdCounter = 0;

function getCryptoWorker() {
  if (!cryptoWorker) {
    console.log('ğŸ”§ Initialisiere Crypto-Worker...');
    cryptoWorker = new Worker(workerUrl);
    cryptoWorker.onmessage = (e) => {
      const { id, success, data, error, type } = e.data;
      console.log('ğŸ“¬ Worker-Nachricht empfangen:', { id, success, type });
      const callback = workerCallbacks.get(id);
      if (callback) {
        workerCallbacks.delete(id);
        if (success) {
          callback.resolve(data);
        } else {
          callback.reject(new Error(error));
        }
      } else {
        console.warn('âš ï¸ Kein Callback fÃ¼r Worker-ID:', id);
      }
    };
    cryptoWorker.onerror = (e) => {
      console.error('âŒ Worker Error:', e);
      // Bei Worker-Fehler alle wartenden Callbacks ablehnen
      for (const [id, callback] of workerCallbacks) {
        callback.reject(new Error('Worker-Fehler: ' + e.message));
      }
      workerCallbacks.clear();
    };
    console.log('âœ“ Crypto-Worker initialisiert');
  }
  return cryptoWorker;
}

// Promise-basierte Worker-Kommunikation
function workerEncrypt(data, password, useFixedSize = true) {
  return new Promise((resolve, reject) => {
    console.log('â³ Worker-VerschlÃ¼sselung gestartet...');
    const id = ++workerIdCounter;
    workerCallbacks.set(id, { 
      resolve: (result) => {
        console.log('âœ“ Worker-VerschlÃ¼sselung erfolgreich');
        resolve(result);
      }, 
      reject: (err) => {
        console.error('âœ— Worker-VerschlÃ¼sselung fehlgeschlagen:', err);
        reject(err);
      }
    });
    getCryptoWorker().postMessage({ type: 'encrypt', data, password, useFixedSize, id });
  });
}

function workerDecrypt(data, password, useFixedSize = true) {
  return new Promise((resolve, reject) => {
    console.log('â³ Worker-EntschlÃ¼sselung gestartet...');
    const id = ++workerIdCounter;
    workerCallbacks.set(id, { 
      resolve: (result) => {
        console.log('âœ“ Worker-EntschlÃ¼sselung erfolgreich');
        resolve(result);
      }, 
      reject: (err) => {
        console.error('âœ— Worker-EntschlÃ¼sselung fehlgeschlagen:', err);
        reject(err);
      }
    });
    getCryptoWorker().postMessage({ type: 'decrypt', data, password, useFixedSize, id });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURE VAULT - Single-Blob IndexedDB Architektur
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SecureVault = {
  db: null,
  encryptionKey: null, // Wird im RAM gehalten, NIEMALS persistiert
  
  async openDB() {
    if (this.db) return this.db;
    
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(VAULT_CONFIG.DB_NAME, 1);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => {
        this.db = req.result;
        resolve(this.db);
      };
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        // Nur ein einziger Store fÃ¼r den verschlÃ¼sselten Blob
        if (!db.objectStoreNames.contains(VAULT_CONFIG.STORE_NAME)) {
          db.createObjectStore(VAULT_CONFIG.STORE_NAME);
        }
      };
    });
  },
  
  // PrÃ¼ft ob bereits Daten existieren
  async hasData() {
    const db = await this.openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(VAULT_CONFIG.STORE_NAME, 'readonly');
      const store = tx.objectStore(VAULT_CONFIG.STORE_NAME);
      const req = store.get(VAULT_CONFIG.KEY_NAME);
      req.onsuccess = () => resolve(req.result !== undefined);
      req.onerror = () => reject(req.error);
    });
  },
  
  // LÃ¤dt und entschlÃ¼sselt den Vault
  async load(password) {
    const db = await this.openDB();
    
    return new Promise(async (resolve, reject) => {
      const tx = db.transaction(VAULT_CONFIG.STORE_NAME, 'readonly');
      const store = tx.objectStore(VAULT_CONFIG.STORE_NAME);
      const req = store.get(VAULT_CONFIG.KEY_NAME);
      
      req.onsuccess = async () => {
        if (!req.result) {
          // Keine Daten vorhanden - leeren State zurÃ¼ckgeben
          this.encryptionKey = password;
          resolve(null);
          return;
        }
        
        try {
          const decrypted = await workerDecrypt(req.result, password, true);
          this.encryptionKey = password;
          resolve(decrypted);
        } catch (err) {
          reject(new Error('Falsches Passwort oder beschÃ¤digte Daten'));
        }
      };
      req.onerror = () => reject(req.error);
    });
  },
  
  // VerschlÃ¼sselt und speichert den Vault (Full Overwrite)
  async save(data) {
    if (!this.encryptionKey) {
      throw new Error('Vault nicht entsperrt');
    }
    
    const db = await this.openDB();
    const encrypted = await workerEncrypt(data, this.encryptionKey, true);
    
    // PrÃ¼fe dass die GrÃ¶ÃŸe exakt 5MB ist
    console.log('Vault-GrÃ¶ÃŸe:', encrypted.byteLength, 'Bytes (erwartet:', VAULT_CONFIG.FIXED_SIZE, ')');
    
    return new Promise((resolve, reject) => {
      const tx = db.transaction(VAULT_CONFIG.STORE_NAME, 'readwrite');
      const store = tx.objectStore(VAULT_CONFIG.STORE_NAME);
      const req = store.put(encrypted, VAULT_CONFIG.KEY_NAME);
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  
  // Initialisiert einen neuen Vault mit Passwort
  async initialize(password, initialData) {
    try {
      // Erst Datenbank Ã¶ffnen
      await this.openDB();
      // Dann Key setzen
      this.encryptionKey = password;
      // Dann speichern
      await this.save(initialData);
      console.log('âœ“ Vault erfolgreich initialisiert');
    } catch (err) {
      console.error('Vault-Initialisierung fehlgeschlagen:', err);
      this.encryptionKey = null;
      throw err;
    }
  },
  
  // PANIK-BUTTON: LÃ¶scht den Key aus dem RAM
  emergencyWipe() {
    if (this.encryptionKey) {
      // Ãœberschreibe den Key im Speicher
      this.encryptionKey = crypto.getRandomValues(new Uint8Array(64)).toString();
      this.encryptionKey = null;
    }
    // Worker terminieren
    if (cryptoWorker) {
      cryptoWorker.terminate();
      cryptoWorker = null;
    }
    workerCallbacks.clear();
    console.log('ğŸš¨ NOTFALL-WIPE: Encryption Key aus RAM gelÃ¶scht');
    return true;
  },
  
  // Ã„ndert das Passwort
  async changePassword(currentPassword, newPassword, data) {
    // Verifiziere altes Passwort
    if (currentPassword !== this.encryptionKey) {
      throw new Error('Aktuelles Passwort falsch');
    }
    this.encryptionKey = newPassword;
    await this.save(data);
  },
  
  // LÃ¶scht die gesamte Datenbank
  async destroyVault() {
    this.emergencyWipe();
    return new Promise((resolve, reject) => {
      const req = indexedDB.deleteDatabase(VAULT_CONFIG.DB_NAME);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEGACY ENCRYPTION (fÃ¼r Backup-Export ohne Fixed-Size)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CRYPTO_CONFIG = {
  algorithm: 'AES-GCM',
  keyLength: 256,
  ivLength: 12,
  saltLength: 16,
  iterations: 310000,
  tagLength: 128
};

function generateRandomBytes(length) {
  return crypto.getRandomValues(new Uint8Array(length));
}

async function deriveKey(password, salt) {
  const encoder = new TextEncoder();
  const passwordBuffer = encoder.encode(password);
  const baseKey = await crypto.subtle.importKey('raw', passwordBuffer, 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: CRYPTO_CONFIG.iterations, hash: 'SHA-256' },
    baseKey,
    { name: CRYPTO_CONFIG.algorithm, length: CRYPTO_CONFIG.keyLength },
    false, ['encrypt', 'decrypt']
  );
}

// Normale VerschlÃ¼sselung (ohne Fixed-Size, fÃ¼r Backup-Export)
async function encryptData(data, password) {
  const jsonString = JSON.stringify(data);
  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(jsonString);
  const salt = generateRandomBytes(CRYPTO_CONFIG.saltLength);
  const iv = generateRandomBytes(CRYPTO_CONFIG.ivLength);
  const key = await deriveKey(password, salt);
  const encryptedData = await crypto.subtle.encrypt(
    { name: CRYPTO_CONFIG.algorithm, iv: iv, tagLength: CRYPTO_CONFIG.tagLength },
    key, dataBuffer
  );
  const result = new Uint8Array(CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength + encryptedData.byteLength);
  result.set(salt, 0);
  result.set(iv, CRYPTO_CONFIG.saltLength);
  result.set(new Uint8Array(encryptedData), CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength);
  return result.buffer;
}

async function decryptData(encryptedBuffer, password) {
  const encryptedArray = new Uint8Array(encryptedBuffer);
  const salt = encryptedArray.slice(0, CRYPTO_CONFIG.saltLength);
  const iv = encryptedArray.slice(CRYPTO_CONFIG.saltLength, CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength);
  const ciphertext = encryptedArray.slice(CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength);
  const key = await deriveKey(password, salt);
  const decryptedBuffer = await crypto.subtle.decrypt(
    { name: CRYPTO_CONFIG.algorithm, iv: iv, tagLength: CRYPTO_CONFIG.tagLength },
    key, ciphertext
  );
  const decoder = new TextDecoder();
  return JSON.parse(decoder.decode(decryptedBuffer));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LADE-DIALOG FÃœR LANGE OPERATIONEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showLoadingDialog(message = 'Verarbeite...') {
  const overlay = document.createElement('div');
  overlay.className = 'loading-overlay';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); display: flex; align-items: center;
    justify-content: center; z-index: 999999; flex-direction: column;
  `;
  overlay.innerHTML = `
    <div style="text-align: center; color: white;">
      <div style="font-size: 48px; margin-bottom: 20px; animation: spin 1s linear infinite;">âš™ï¸</div>
      <p style="font-size: 18px; font-weight: 600; margin: 0 0 10px 0;" id="loading-message">${message}</p>
      <p style="font-size: 12px; color: #94a3b8; margin: 0;">Dies kann einige Sekunden dauern...</p>
      <div style="margin-top: 20px; width: 200px; height: 4px; background: #334155; border-radius: 2px; overflow: hidden;">
        <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #0d9488, #10b981); animation: loading-bar 1.5s ease-in-out infinite;"></div>
      </div>
    </div>
    <style>
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes loading-bar { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
    </style>
  `;
  document.body.appendChild(overlay);
  
  return {
    updateMessage: (msg) => {
      const el = document.getElementById('loading-message');
      if (el) el.textContent = msg;
    },
    close: () => overlay.remove()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XSS-SCHUTZ: Sanitize Text-Input
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function sanitizeText(text) {
  if (typeof text !== 'string') return '';
  return text
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;')
    .replace(/javascript:/gi, '')
    .replace(/on\w+=/gi, '')
    .trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV-IMPORT: Parser fÃ¼r externe Tools
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseCSV(csvText) {
  // Automatische Trennzeichen-Erkennung
  const firstLine = csvText.split('\n')[0] || '';
  const delimiter = firstLine.includes(';') ? ';' : ',';
  
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) return { headers: [], rows: [] };
  
  // Header parsen
  const headers = lines[0].split(delimiter).map(h => 
    sanitizeText(h.replace(/^["']|["']$/g, '').trim().toLowerCase())
  );
  
  // Datenzeilen parsen
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Einfaches CSV-Parsing (berÃ¼cksichtigt AnfÃ¼hrungszeichen)
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      if (char === '"' || char === "'") {
        inQuotes = !inQuotes;
      } else if (char === delimiter && !inQuotes) {
        values.push(sanitizeText(current.trim()));
        current = '';
      } else {
        current += char;
      }
    }
    values.push(sanitizeText(current.trim()));
    
    if (values.some(v => v)) {
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] || '';
      });
      rows.push(row);
    }
  }
  
  return { headers, rows, delimiter };
}

function detectCSVType(headers) {
  const headerStr = headers.join(' ').toLowerCase();
  
  // Kunden-Keywords
  const kundenKeywords = ['kunde', 'customer', 'firma', 'company', 'anrede', 'nachname', 'vorname', 'kundennummer', 'kunden nr', 'anschrift'];
  const isKunden = kundenKeywords.some(k => headerStr.includes(k));
  
  // Material-Keywords
  const materialKeywords = ['artikel', 'product', 'material', 'preis', 'price', 'vk', 'ek', 'einheit', 'unit', 'beschreibung', 'artikelnummer'];
  const isMaterial = materialKeywords.some(k => headerStr.includes(k));
  
  // Rechnungs-Keywords
  const rechnungsKeywords = ['rechnung', 'invoice', 'beleg', 'rechnungsnummer'];
  const isRechnung = rechnungsKeywords.some(k => headerStr.includes(k));
  
  if (isKunden && !isMaterial) return 'kunden';
  if (isMaterial && !isKunden) return 'material';
  if (isRechnung) return 'rechnungen';
  
  // Fallback: Wenn "preis" vorkommt, ist es Material
  if (headerStr.includes('preis') || headerStr.includes('price')) return 'material';
  
  return 'unknown';
}

function mapCSVToKunden(rows, headers) {
  // Spalten-Mapping fÃ¼r gÃ¤ngige Formate
  const nameFields = ['name', 'firma', 'company', 'organisation', 'nachname', 'kunde'];
  const vornameFields = ['vorname', 'first name', 'firstname'];
  const strasseFields = ['strasse', 'straÃŸe', 'address', 'anschrift', 'str'];
  const plzFields = ['plz', 'postleitzahl', 'zip', 'postal'];
  const ortFields = ['ort', 'stadt', 'city', 'wohnort'];
  const anredeFields = ['anrede', 'title', 'salutation'];
  const emailFields = ['email', 'e-mail', 'mail'];
  const telefonFields = ['telefon', 'phone', 'tel', 'fon'];
  
  const findField = (row, fields) => {
    for (const f of fields) {
      const key = Object.keys(row).find(k => k.includes(f));
      if (key && row[key]) return row[key];
    }
    return '';
  };
  
  return rows.map((row, idx) => {
    const vorname = findField(row, vornameFields);
    const nachname = findField(row, nameFields);
    const name = vorname ? `${vorname} ${nachname}`.trim() : nachname;
    
    return {
      id: Date.now() + idx,
      anrede: findField(row, anredeFields) || 'Organisation',
      name: sanitizeText(name),
      strasse: sanitizeText(findField(row, strasseFields)),
      plz: sanitizeText(findField(row, plzFields)),
      ort: sanitizeText(findField(row, ortFields)),
      email: sanitizeText(findField(row, emailFields)),
      telefon: sanitizeText(findField(row, telefonFields))
    };
  }).filter(k => k.name);
}

function mapCSVToMaterial(rows, headers) {
  // Spalten-Mapping fÃ¼r gÃ¤ngige Formate
  const nameFields = ['name', 'bezeichnung', 'beschreibung', 'artikel', 'product', 'artikelname'];
  const preisFields = ['preis', 'price', 'vk', 'verkaufspreis', 'bruttopreis', 'nettopreis', 'einzelpreis'];
  const einheitFields = ['einheit', 'unit', 'me', 'mengeneinheit'];
  const nummerFields = ['nummer', 'artikelnummer', 'art.nr', 'artnr', 'id'];
  
  const findField = (row, fields) => {
    for (const f of fields) {
      const key = Object.keys(row).find(k => k.includes(f));
      if (key && row[key]) return row[key];
    }
    return '';
  };
  
  return rows.map((row, idx) => {
    let preis = findField(row, preisFields);
    // Preis-Format normalisieren (12.50 oder 12,50 -> "12,50")
    if (preis) {
      preis = preis.toString().replace('.', ',').replace(/[^0-9,]/g, '');
      if (!preis.includes(',')) preis += ',00';
    }
    
    return {
      id: Date.now() + idx,
      name: sanitizeText(findField(row, nameFields)),
      einheit: sanitizeText(findField(row, einheitFields)) || 'Stk',
      preis: preis || '0,00'
    };
  }).filter(m => m.name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIGH-SECURITY 5MB FIXED-SIZE EXPORT (Base64 fÃ¼r Android-KompatibilitÃ¤t)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Neutrale Dateinamen zum Schutz der PrivatsphÃ¤re (.txt fÃ¼r Android Share)
function getRandomNeutralFilename() {
  const timestamp = Date.now().toString(36); // Kompakter Zeitstempel
  const prefixes = ['system_log', 'app_cache', 'debug_dump', 'config_data', 'user_prefs', 'storage_log'];
  const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
  return `${prefix}_${timestamp}.txt`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZUGFeRD XML GENERATOR (Optimiert fÃ¼r Abschlags- & Schlussrechnungen)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateZUGFeRDXML(dok, firmenDaten) {
  // ISO-Datum Format
  const now = new Date();
  const isoDate = now.toISOString().split('T')[0].replace(/-/g, '');
  
  // 1. Dokumenten-Typ bestimmen (Code 386 fÃ¼r Abschlagsrechnung!)
  let typeCode = '380'; // Standard: Handelsrechnung
  if (dok.typ === 'ANGEBOT') typeCode = '310';
  else if (dok.typ === 'ABSCHLAGSRECHNUNG') typeCode = '386'; // Prepayment invoice
  
  // 2. Summen berechnen
  let nettoGesamt = 0;
  let mwstGesamt = 0;
  
  const positionen = (dok.positionen || []).map((pos, idx) => {
    // Nur echte Positionen (keine Ãœberschriften)
    if (pos.isUeberschrift) return '';
    
    const menge = parseFloat(String(pos.menge || 0).replace(',', '.')) || 0;
    const preis = parseFloat(String(pos.preis || 0).replace(',', '.')) || 0;
    
    // Bei Angeboten/optionalen Positionen nicht zur Summe zÃ¤hlen (XML Logik)
    // Hier vereinfacht: Wir nehmen an, alles was auf der Rechnung steht, zÃ¤hlt.
    if (pos.isOptional && dok.typ === 'ANGEBOT') return ''; // Optionale im XML weglassen oder speziell markieren (hier weglassen)

    const netto = menge * preis;
    const mwst = netto * 0.19; // 19% Hardcoded (kÃ¶nnte man konfigurierbar machen)
    
    if (!pos.isOptional) {
      nettoGesamt += netto;
      mwstGesamt += mwst;
    }
    
    return `
      <ram:IncludedSupplyChainTradeLineItem>
        <ram:AssociatedDocumentLineDocument>
          <ram:LineID>${idx + 1}</ram:LineID>
        </ram:AssociatedDocumentLineDocument>
        <ram:SpecifiedTradeProduct>
          <ram:Name>${escapeXML(pos.name || 'Position')}</ram:Name>
        </ram:SpecifiedTradeProduct>
        <ram:SpecifiedLineTradeAgreement>
          <ram:NetPriceProductTradePrice>
            <ram:ChargeAmount>${preis.toFixed(2)}</ram:ChargeAmount>
          </ram:NetPriceProductTradePrice>
        </ram:SpecifiedLineTradeAgreement>
        <ram:SpecifiedLineTradeDelivery>
          <ram:BilledQuantity unitCode="${escapeXML(pos.einheit === 'Stk' ? 'H87' : 'C62')}">${menge.toFixed(2)}</ram:BilledQuantity>
        </ram:SpecifiedLineTradeDelivery>
        <ram:SpecifiedLineTradeSettlement>
          <ram:ApplicableTradeTax>
            <ram:TypeCode>VAT</ram:TypeCode>
            <ram:CategoryCode>S</ram:CategoryCode>
            <ram:RateApplicablePercent>19.00</ram:RateApplicablePercent>
          </ram:ApplicableTradeTax>
          <ram:SpecifiedTradeSettlementLineMonetarySummation>
            <ram:LineTotalAmount>${netto.toFixed(2)}</ram:LineTotalAmount>
          </ram:SpecifiedTradeSettlementLineMonetarySummation>
        </ram:SpecifiedLineTradeSettlement>
      </ram:IncludedSupplyChainTradeLineItem>`;
  }).join('');
  
  // Rabatte abziehen (falls globaler Rabatt existiert)
  const rabattBetrag = parseFloat(String(dok.rabatt || 0).replace(',', '.')) || 0;
  const nettoNachRabatt = nettoGesamt - rabattBetrag;
  // MwSt neu berechnen auf Basis des rabattierten Nettos
  const mwstNachRabatt = nettoNachRabatt * 0.19;
  const bruttoGesamt = nettoNachRabatt + mwstNachRabatt;
  
  // 3. Bereits gezahlte BetrÃ¤ge (AbschlÃ¤ge) fÃ¼r Schlussrechnung
  // Wenn es eine normale RECHNUNG ist, aber AbschlÃ¤ge abgezogen werden
  let prepaidAmount = 0;
  if (dok.typ === 'RECHNUNG' && dok.abschlagsrechnungBetrag) {
      prepaidAmount = parseFloat(String(dok.abschlagsrechnungBetrag).replace(',', '.')) || 0;
  }
  
  // Der tatsÃ¤chlich zu zahlende Restbetrag
  const duePayableAmount = bruttoGesamt - prepaidAmount;

  // Kunde aufbereiten
  const kunde = dok.kunde || {};
  
  // ZUGFeRD XML nach EN 16931 BASIC Profil
  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<rsm:CrossIndustryInvoice xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
    xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
    xmlns:qdt="urn:un:unece:uncefact:data:standard:QualifiedDataType:100"
    xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">
  <rsm:ExchangedDocumentContext>
    <ram:GuidelineSpecifiedDocumentContextParameter>
      <ram:ID>urn:cen.eu:en16931:2017#compliant#urn:factur-x.eu:1p0:basic</ram:ID>
    </ram:GuidelineSpecifiedDocumentContextParameter>
  </rsm:ExchangedDocumentContext>
  <rsm:ExchangedDocument>
    <ram:ID>${escapeXML(dok.nummer || 'DRAFT')}</ram:ID>
    <ram:TypeCode>${typeCode}</ram:TypeCode>
    <ram:IssueDateTime>
      <udt:DateTimeString format="102">${isoDate}</udt:DateTimeString>
    </ram:IssueDateTime>
    <ram:IncludedNote>
      <ram:Content>${escapeXML(dok.betreff || 'Rechnung')}</ram:Content>
    </ram:IncludedNote>
  </rsm:ExchangedDocument>
  <rsm:SupplyChainTradeTransaction>
    <ram:ApplicableHeaderTradeAgreement>
      <ram:SellerTradeParty>
        <ram:Name>${escapeXML(firmenDaten.firmenname || 'Firma')}</ram:Name>
        <ram:PostalTradeAddress>
          <ram:LineOne>${escapeXML(firmenDaten.strasse || '')}</ram:LineOne>
          <ram:PostcodeCode>${escapeXML(firmenDaten.plz || '')}</ram:PostcodeCode>
          <ram:CityName>${escapeXML(firmenDaten.ort || '')}</ram:CityName>
          <ram:CountryID>${escapeXML(firmenDaten.land === 'Deutschland' ? 'DE' : 'DE')}</ram:CountryID>
        </ram:PostalTradeAddress>
        <ram:SpecifiedTaxRegistration>
          <ram:ID schemeID="VA">${escapeXML(firmenDaten.ustid || '')}</ram:ID>
        </ram:SpecifiedTaxRegistration>
      </ram:SellerTradeParty>
      <ram:BuyerTradeParty>
        <ram:Name>${escapeXML(kunde.name || 'Kunde')}</ram:Name>
        <ram:PostalTradeAddress>
          <ram:LineOne>${escapeXML(kunde.strasse || '')}</ram:LineOne>
          <ram:PostcodeCode>${escapeXML(kunde.plz || '')}</ram:PostcodeCode>
          <ram:CityName>${escapeXML(kunde.ort || '')}</ram:CityName>
          <ram:CountryID>DE</ram:CountryID>
        </ram:PostalTradeAddress>
      </ram:BuyerTradeParty>
    </ram:ApplicableHeaderTradeAgreement>
    <ram:ApplicableHeaderTradeDelivery>
      <ram:ActualDeliverySupplyChainEvent>
        <ram:OccurrenceDateTime>
          <udt:DateTimeString format="102">${isoDate}</udt:DateTimeString>
        </ram:OccurrenceDateTime>
      </ram:ActualDeliverySupplyChainEvent>
    </ram:ApplicableHeaderTradeDelivery>
    <ram:ApplicableHeaderTradeSettlement>
      <ram:InvoiceCurrencyCode>EUR</ram:InvoiceCurrencyCode>
      <ram:SpecifiedTradePaymentTerms>
        <ram:Description>Zahlbar innerhalb von ${firmenDaten.zahlungsziel || 14} Tagen</ram:Description>
      </ram:SpecifiedTradePaymentTerms>
      <ram:ApplicableTradeTax>
        <ram:CalculatedAmount>${mwstNachRabatt.toFixed(2)}</ram:CalculatedAmount>
        <ram:TypeCode>VAT</ram:TypeCode>
        <ram:BasisAmount>${nettoNachRabatt.toFixed(2)}</ram:BasisAmount>
        <ram:CategoryCode>S</ram:CategoryCode>
        <ram:RateApplicablePercent>19.00</ram:RateApplicablePercent>
      </ram:ApplicableTradeTax>
      <ram:SpecifiedTradeSettlementHeaderMonetarySummation>
        <ram:LineTotalAmount>${nettoNachRabatt.toFixed(2)}</ram:LineTotalAmount>
        <ram:TaxBasisTotalAmount>${nettoNachRabatt.toFixed(2)}</ram:TaxBasisTotalAmount>
        <ram:TaxTotalAmount currencyID="EUR">${mwstNachRabatt.toFixed(2)}</ram:TaxTotalAmount>
        <ram:GrandTotalAmount>${bruttoGesamt.toFixed(2)}</ram:GrandTotalAmount>
        ${prepaidAmount > 0 ? `<ram:TotalPrepaidAmount>${prepaidAmount.toFixed(2)}</ram:TotalPrepaidAmount>` : ''}
        <ram:DuePayableAmount>${duePayableAmount.toFixed(2)}</ram:DuePayableAmount>
      </ram:SpecifiedTradeSettlementHeaderMonetarySummation>
    </ram:ApplicableHeaderTradeSettlement>
    ${positionen}
  </rsm:SupplyChainTradeTransaction>
</rsm:CrossIndustryInvoice>`;
  
  return xml;
}

// XML-Escape Helper
function escapeXML(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRI-HYBRID PDF WORKFLOW - E-Rechnung, RAM-Druck, Sicheres Archiv
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Button A: E-Rechnung (PDF/A-3 mit eingebettetem ZUGFeRD-XML)
async function createEInvoicePDF(dok, firmenDaten, jsPDFInstance) {
  const loading = showLoadingDialog('ğŸ“„ Generiere E-Rechnung...');
  
  try {
    // PDF generieren (verwendet bestehende createPDF Logik)
    loading.updateMessage('ğŸ“ Erstelle PDF...');
    const pdfBlob = jsPDFInstance.output('blob');
    
    // ZUGFeRD-XML im RAM generieren
    loading.updateMessage('ğŸ“‹ Generiere ZUGFeRD-XML...');
    const zugferdXML = generateZUGFeRDXML(dok, firmenDaten);
    
    // PDF/A-3 mit eingebettetem XML erstellen
    loading.updateMessage('ğŸ“¦ Bette XML in PDF ein...');
    
    // FÃ¼r echtes PDF/A-3 mÃ¼sste man eine Library wie pdf-lib verwenden
    // Hier: Workaround - XML als Anhang im PDF-Blob
    const xmlBlob = new Blob([zugferdXML], { type: 'application/xml' });
    
    // Kombiniertes Archiv erstellen (PDF + XML separat)
    const fullName = dok.kunde?.name || 'Unbekannt';
    const cleanName = fullName.replace(/^(Herr|Herrn|Frau|FrÃ¤ulein)\s+/i, '').trim();
    const lastName = cleanName.split(' ').pop().replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼ÃŸ-]/g, '');
    const baseFileName = `${dok.nummer || 'DRAFT'}-${lastName}`;
    
    loading.close();
    
    // Warnung anzeigen
    const proceed = confirm(
      'âš ï¸ WICHTIGER HINWEIS âš ï¸\n\n' +
      'Die E-Rechnung wird UNVERSCHLÃœSSELT heruntergeladen!\n\n' +
      'â€¢ Geeignet fÃ¼r: Versand an Kunden, Finanzamt\n' +
      'â€¢ Nach Versand: Datei sicher lÃ¶schen!\n' +
      'â€¢ FÃ¼r interne Archivierung: "ğŸ”’ Sicher archivieren" nutzen\n\n' +
      'Fortfahren?'
    );
    
    if (!proceed) return null;
    
    // PDF herunterladen
    const pdfUrl = URL.createObjectURL(pdfBlob);
    const pdfLink = document.createElement('a');
    pdfLink.href = pdfUrl;
    pdfLink.download = `${baseFileName}.pdf`;
    pdfLink.click();
    URL.revokeObjectURL(pdfUrl);
    
    // XML separat herunterladen (fÃ¼r manuelle Einbettung oder Mailanhang)
    const xmlUrl = URL.createObjectURL(xmlBlob);
    const xmlLink = document.createElement('a');
    xmlLink.href = xmlUrl;
    xmlLink.download = `${baseFileName}-factur-x.xml`;
    xmlLink.click();
    URL.revokeObjectURL(xmlUrl);
    
    alert('âœ… E-Rechnung erstellt!\n\n' +
      '2 Dateien wurden heruntergeladen:\n' +
      `â€¢ ${baseFileName}.pdf (Rechnung)\n` +
      `â€¢ ${baseFileName}-factur-x.xml (ZUGFeRD-Daten)\n\n` +
      'âš ï¸ Bitte nach Versand sicher lÃ¶schen!');
    
    return { pdfBlob, xmlBlob };
    
  } catch (err) {
    loading.close();
    console.error('E-Rechnung Fehler:', err);
    alert('Fehler bei E-Rechnung: ' + err.message);
    return null;
  }
}

// Button B: Direkt drucken (RAM-to-Paper, spurenlos)
async function printRAMtoPaper(jsPDFInstance) {
  const loading = showLoadingDialog('ğŸ–¨ï¸ Bereite Druck vor...');
  
  try {
    loading.updateMessage('ğŸ“„ Generiere PDF im RAM...');
    
    // PDF als Blob im RAM
    const pdfBlob = jsPDFInstance.output('blob');
    const blobUrl = URL.createObjectURL(pdfBlob);
    
    loading.updateMessage('ğŸ–¨ï¸ Ã–ffne Druckdialog...');
    
    // Verstecktes iframe fÃ¼r Druck
    const printFrame = document.createElement('iframe');
    printFrame.style.cssText = 'position: fixed; top: -10000px; left: -10000px; width: 1px; height: 1px;';
    document.body.appendChild(printFrame);
    
    printFrame.src = blobUrl;
    
    printFrame.onload = () => {
      loading.close();
      
      try {
        printFrame.contentWindow.focus();
        printFrame.contentWindow.print();
      } catch (e) {
        // Fallback: Neues Fenster Ã¶ffnen
        const printWindow = window.open(blobUrl, '_blank');
        if (printWindow) {
          printWindow.onload = () => {
            printWindow.print();
            // Fenster nach Druck schlieÃŸen
            printWindow.onafterprint = () => printWindow.close();
          };
        }
      }
      
      // Sofort aufrÃ¤umen - Blob aus RAM lÃ¶schen
      setTimeout(() => {
        URL.revokeObjectURL(blobUrl);
        if (printFrame.parentNode) {
          document.body.removeChild(printFrame);
        }
        console.log('âœ“ RAM-Druck: Blob-URL revoked, keine Spuren auf Festplatte');
      }, 1000);
    };
    
    printFrame.onerror = () => {
      loading.close();
      URL.revokeObjectURL(blobUrl);
      if (printFrame.parentNode) {
        document.body.removeChild(printFrame);
      }
      alert('Druckfehler - bitte erneut versuchen');
    };
    
  } catch (err) {
    loading.close();
    console.error('RAM-Druck Fehler:', err);
    alert('Druckfehler: ' + err.message);
  }
}

// Button C: Sicher archivieren (verschlÃ¼sselt mit Padding)
async function createSecureArchive(dok, firmenDaten, jsPDFInstance, vaultPassword) {
  const loading = showLoadingDialog('ğŸ”’ Erstelle sicheres Archiv...');
  
  try {
    loading.updateMessage('ğŸ“„ Generiere PDF im RAM...');
    const pdfArrayBuffer = jsPDFInstance.output('arraybuffer');
    
    loading.updateMessage('ğŸ“‹ Generiere ZUGFeRD-XML...');
    const zugferdXML = generateZUGFeRDXML(dok, firmenDaten);
    const xmlBytes = new TextEncoder().encode(zugferdXML);
    
    loading.updateMessage('ğŸ“¦ Kombiniere Daten...');
    
    // Struktur: [4 Bytes PDF-LÃ¤nge][PDF-Daten][4 Bytes XML-LÃ¤nge][XML-Daten][Padding]
    const pdfLength = pdfArrayBuffer.byteLength;
    const xmlLength = xmlBytes.length;
    const headerSize = 8; // 4 Bytes PDF-LÃ¤nge + 4 Bytes XML-LÃ¤nge
    const dataSize = headerSize + pdfLength + xmlLength;
    
    // Auf 512 KB aufrunden (Privacy Padding)
    const PADDING_BLOCK = 512 * 1024; // 512 KB
    const paddedSize = Math.ceil(dataSize / PADDING_BLOCK) * PADDING_BLOCK;
    const paddingSize = paddedSize - dataSize;
    
    loading.updateMessage(`ğŸ” FÃ¼ge ${Math.round(paddingSize / 1024)} KB Privacy-Padding hinzu...`);
    
    // Buffer erstellen
    const combinedBuffer = new ArrayBuffer(paddedSize);
    const view = new DataView(combinedBuffer);
    const bytes = new Uint8Array(combinedBuffer);
    
    // Header: PDF-LÃ¤nge (4 Bytes, Little-Endian)
    view.setUint32(0, pdfLength, true);
    // Header: XML-LÃ¤nge (4 Bytes, Little-Endian)
    view.setUint32(4, xmlLength, true);
    
    // PDF-Daten
    bytes.set(new Uint8Array(pdfArrayBuffer), headerSize);
    
    // XML-Daten
    bytes.set(xmlBytes, headerSize + pdfLength);
    
    // ZufÃ¤lliges Padding generieren (in Chunks wegen 64KB Limit)
    loading.updateMessage('ğŸ² Generiere kryptografisches Padding...');
    const paddingStart = headerSize + pdfLength + xmlLength;
    const chunkSize = 65536;
    for (let i = 0; i < paddingSize; i += chunkSize) {
      const size = Math.min(chunkSize, paddingSize - i);
      const randomChunk = new Uint8Array(size);
      crypto.getRandomValues(randomChunk);
      bytes.set(randomChunk, paddingStart + i);
    }
    
    loading.updateMessage('ğŸ” VerschlÃ¼ssele mit AES-256-GCM...');
    
    // VerschlÃ¼sseln mit dem Vault-Passwort
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      new TextEncoder().encode(vaultPassword),
      'PBKDF2',
      false,
      ['deriveBits', 'deriveKey']
    );
    
    const key = await crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt']
    );
    
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv, tagLength: 128 },
      key,
      combinedBuffer
    );
    
    // Finales Format: [16 Bytes Salt][12 Bytes IV][Encrypted Data]
    const finalBuffer = new ArrayBuffer(16 + 12 + encrypted.byteLength);
    const finalBytes = new Uint8Array(finalBuffer);
    finalBytes.set(salt, 0);
    finalBytes.set(iv, 16);
    finalBytes.set(new Uint8Array(encrypted), 28);
    
    loading.updateMessage('ğŸ’¾ Bereite Download vor...');
    
    // Download als .dat Datei
    const blob = new Blob([finalBuffer], { type: 'application/octet-stream' });
    const filename = `archiv_${Date.now().toString(36)}.dat`;
    
    loading.close();
    
    await saveFile(blob, filename);
    
    alert(`âœ… Sicheres Archiv erstellt!\n\n` +
      `ğŸ“¦ Datei: ${filename}\n` +
      `ğŸ“Š GrÃ¶ÃŸe: ${Math.round(finalBuffer.byteLength / 1024)} KB (mit Padding)\n` +
      `ğŸ” VerschlÃ¼sselt: AES-256-GCM\n\n` +
      `Zum Ã–ffnen: .dat Datei in die Dropzone ziehen`);
    
    return true;
    
  } catch (err) {
    loading.close();
    console.error('Archiv-Fehler:', err);
    alert('Fehler beim Archivieren: ' + err.message);
    return false;
  }
}

// EntschlÃ¼sseln und Anzeigen einer .dat Archivdatei
async function decryptAndViewArchive(file, vaultPassword) {
  const loading = showLoadingDialog('ğŸ”“ EntschlÃ¼ssele Archiv...');
  
  try {
    const arrayBuffer = await file.arrayBuffer();
    const bytes = new Uint8Array(arrayBuffer);
    
    if (bytes.length < 28) {
      throw new Error('UngÃ¼ltige Archivdatei');
    }
    
    loading.updateMessage('ğŸ”‘ Extrahiere SchlÃ¼sselparameter...');
    
    // Salt und IV extrahieren
    const salt = bytes.slice(0, 16);
    const iv = bytes.slice(16, 28);
    const encryptedData = bytes.slice(28);
    
    // SchlÃ¼ssel ableiten
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      new TextEncoder().encode(vaultPassword),
      'PBKDF2',
      false,
      ['deriveBits', 'deriveKey']
    );
    
    const key = await crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['decrypt']
    );
    
    loading.updateMessage('ğŸ”“ EntschlÃ¼ssele Daten...');
    
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv, tagLength: 128 },
      key,
      encryptedData
    );
    
    const decryptedBytes = new Uint8Array(decrypted);
    const view = new DataView(decrypted);
    
    // Header lesen
    const pdfLength = view.getUint32(0, true);
    const xmlLength = view.getUint32(4, true);
    
    loading.updateMessage('ğŸ“„ Extrahiere PDF...');
    
    // PDF extrahieren (ohne Padding)
    const pdfData = decryptedBytes.slice(8, 8 + pdfLength);
    const pdfBlob = new Blob([pdfData], { type: 'application/pdf' });
    
    // XML extrahieren
    const xmlData = decryptedBytes.slice(8 + pdfLength, 8 + pdfLength + xmlLength);
    const xmlString = new TextDecoder().decode(xmlData);
    
    loading.close();
    
    // PDF in neuem Tab anzeigen
    const pdfUrl = URL.createObjectURL(pdfBlob);
    window.open(pdfUrl, '_blank');
    
    // URL nach einer Weile revoken
    setTimeout(() => URL.revokeObjectURL(pdfUrl), 60000);
    
    return { pdfBlob, xmlString };
    
  } catch (err) {
    loading.close();
    console.error('EntschlÃ¼sselungsfehler:', err);
    
    if (err.name === 'OperationError') {
      alert('âŒ Falsches Passwort oder beschÃ¤digte Datei');
    } else {
      alert('Fehler beim EntschlÃ¼sseln: ' + err.message);
    }
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BASE64 KONVERTIERUNG (performant fÃ¼r groÃŸe Daten)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ArrayBuffer zu Base64 - optimiert fÃ¼r 5MB Daten
function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  const chunkSize = 32768; // 32KB Chunks fÃ¼r Performance
  let binary = '';
  
  for (let i = 0; i < bytes.length; i += chunkSize) {
    const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.length));
    binary += String.fromCharCode.apply(null, chunk);
  }
  
  return btoa(binary);
}

// Base64 zu ArrayBuffer
function base64ToArrayBuffer(base64) {
  // Entferne mÃ¶gliche Whitespaces/ZeilenumbrÃ¼che
  const cleanBase64 = base64.replace(/[\s\n\r]/g, '');
  const binary = atob(cleanBase64);
  const bytes = new Uint8Array(binary.length);
  
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  
  return bytes.buffer;
}

// PrÃ¼ft ob ein String gÃ¼ltiges Base64 mit unserem Header ist
function isBase64Backup(text) {
  return typeof text === 'string' && text.startsWith('VAULT5MB:');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT/IMPORT FUNKTIONEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Export mit exakt 5 MB Fixed-Size â†’ Base64 Text fÃ¼r Android
async function exportFixedSizeBackup(data, password) {
  // Backup-Objekt erstellen (ohne Datum fÃ¼r Metadaten-Schutz)
  const backup = {
    v: 5,
    f: 'fsb', // fixed-size-backup
    d: data
  };
  
  // Worker fÃ¼r 5MB Fixed-Size VerschlÃ¼sselung
  const encrypted = await workerEncrypt(backup, password, true);
  
  // Verifiziere exakte GrÃ¶ÃŸe (5MB binÃ¤r)
  if (encrypted.byteLength !== VAULT_CONFIG.FIXED_SIZE) {
    throw new Error(`GrÃ¶ÃŸenfehler: ${encrypted.byteLength} statt ${VAULT_CONFIG.FIXED_SIZE} Bytes`);
  }
  
  // In Base64 konvertieren fÃ¼r Android-KompatibilitÃ¤t
  // Header: "VAULT5MB:" fÃ¼r Erkennung beim Import
  const base64 = arrayBufferToBase64(encrypted);
  return 'VAULT5MB:' + base64;
}

// Import von 5MB Fixed-Size Backup (Base64-Text oder Legacy-Binary)
async function importFixedSizeBackup(input, password) {
  let encryptedBuffer;
  
  // PrÃ¼fe ob es Base64-Text mit Header ist
  if (typeof input === 'string') {
    if (!input.startsWith('VAULT5MB:')) {
      throw new Error('UngÃ¼ltiges Backup-Format (Header fehlt)');
    }
    // Header entfernen und Base64 dekodieren
    const base64Data = input.substring(9);
    encryptedBuffer = base64ToArrayBuffer(base64Data);
  } else {
    // Binary ArrayBuffer (Legacy-UnterstÃ¼tzung)
    encryptedBuffer = input;
  }
  
  // GrÃ¶ÃŸe prÃ¼fen (muss exakt 5MB sein)
  if (encryptedBuffer.byteLength !== VAULT_CONFIG.FIXED_SIZE) {
    throw new Error(`UngÃ¼ltige GrÃ¶ÃŸe: ${encryptedBuffer.byteLength} Bytes (erwartet: ${VAULT_CONFIG.FIXED_SIZE})`);
  }
  
  // Worker fÃ¼r EntschlÃ¼sselung nutzen
  const decrypted = await workerDecrypt(encryptedBuffer, password, true);
  
  // Format prÃ¼fen
  if (!decrypted.f || decrypted.f !== 'fsb') {
    throw new Error('UngÃ¼ltiges Backup-Format');
  }
  
  return decrypted.d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAMMDATEN EXPORT/IMPORT (ohne Rechnungen/Angebote)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function exportStammdaten(appState, password) {
  const stammdaten = {
    version: 5,
    format: 'stammdaten-encrypted',
    date: new Date().toISOString(),
    kundenListe: appState.kunden || [],
    materialListe: appState.material || [],
    firmenDaten: appState.firmenDaten || {},
    einstellungen: {
      zahlungsziel: appState.firmenDaten?.zahlungsziel,
      angebotsgueltigkeit: appState.firmenDaten?.angebotsgueltigkeit,
      stundensatz: appState.firmenDaten?.stundensatz,
      mwstSatz: 19
    }
    // WICHTIG: rechnungen und angebote werden NICHT exportiert
  };
  
  // VerschlÃ¼sseln OHNE Fixed-Size Padding (temporÃ¤re Transfer-Datei)
  const encrypted = await workerEncrypt(stammdaten, password, false);
  return encrypted;
}

async function importStammdaten(encryptedBuffer, password) {
  // EntschlÃ¼sseln OHNE Fixed-Size Padding
  const stammdaten = await workerDecrypt(encryptedBuffer, password, false);
  
  if (!stammdaten.kundenListe && !stammdaten.materialListe) {
    throw new Error('UngÃ¼ltiges Stammdaten-Format');
  }
  
  return stammdaten;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATEI-EXPORT HILFSFUNKTION - Native Share auf Mobile, Download auf Desktop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handleFileExport(blob, filename) {
  let mimeType = blob.type || 'application/octet-stream';
  
  if (filename.endsWith('.txt')) {
    mimeType = 'text/plain';
  } else if (filename.endsWith('.pdf')) {
    mimeType = 'application/pdf';
  }
  
  const file = new File([blob], filename, { type: mimeType });
  
  const hasShare = typeof navigator.share === 'function';
  let canShareFiles = false;
  if (navigator.canShare) {
    try { canShareFiles = navigator.canShare({ files: [file] }); } catch(e) {}
  }

  const doDownload = () => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  if (hasShare && canShareFiles) {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
      overlay.innerHTML = `
        <div style="background:#1e293b;padding:30px;border-radius:15px;text-align:center;max-width:90%;color:white;">
          <h3 style="margin:0 0 10px 0;">ğŸ“„ ${filename}</h3>
          <p style="margin:0 0 20px 0;color:#94a3b8;font-size:14px;">Wie mÃ¶chten Sie die Datei speichern?</p>
          <button id="shareBtn" style="background:#22c55e;color:white;border:none;padding:15px 40px;border-radius:10px;font-size:18px;cursor:pointer;margin:5px;min-width:140px;">ğŸ“¤ Teilen</button>
          <button id="downloadBtn" style="background:#3b82f6;color:white;border:none;padding:15px 40px;border-radius:10px;font-size:18px;cursor:pointer;margin:5px;min-width:140px;">ğŸ’¾ Download</button>
          <br><button id="cancelBtn" style="background:#64748b;color:white;border:none;padding:10px 30px;border-radius:8px;font-size:14px;cursor:pointer;margin-top:15px;">Abbrechen</button>
        </div>
      `;
      document.body.appendChild(overlay);

      overlay.querySelector('#shareBtn').onclick = async () => {
        overlay.remove();
        try {
          await navigator.share({ files: [file], title: filename });
        } catch (err) {
          if (err.name !== 'AbortError') {
            doDownload();
          }
        }
        resolve(true);
      };

      overlay.querySelector('#downloadBtn').onclick = () => {
        overlay.remove();
        doDownload();
        resolve(true);
      };

      overlay.querySelector('#cancelBtn').onclick = () => {
        overlay.remove();
        resolve(false);
      };
    });
  }
  
  doDownload();
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSWORT-STÃ„RKE PRÃœFUNG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function checkPasswordStrength(password) {
  let score = 0;
  if (password.length >= 8) score += 2;
  if (password.length >= 12) score += 2;
  if (password.length >= 16) score += 1;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 2;
  if (/[0-9]/.test(password)) score += 2;
  if (/[^A-Za-z0-9]/.test(password)) score += 2;
  return { score, isStrong: score >= 6 };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSWORT-DIALOGE (maskierte Eingabe)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showVaultPasswordDialog(isNewVault = false, allowStammdatenImport = false) {
  return new Promise((resolve) => {
    // Entferne mÃ¶glicherweise existierende alte Overlays
    const existingOverlay = document.querySelector('.vault-overlay');
    if (existingOverlay) existingOverlay.remove();
    
    const dialogId = 'vault-' + Date.now();
    const overlay = document.createElement('div');
    overlay.className = 'vault-overlay';
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95); display: flex; align-items: center;
      justify-content: center; z-index: 99999;
    `;
    overlay.innerHTML = `
      <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #0d9488; border-radius: 16px; padding: 32px;
        max-width: 450px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 50px; margin-bottom: 12px;">ğŸ”</div>
          <h2 style="color: #f8fafc; margin: 0 0 8px 0; font-size: 22px;">
            ${isNewVault ? 'Neuen Tresor erstellen' : 'Tresor entsperren'}
          </h2>
          <p style="color: #94a3b8; margin: 0; font-size: 13px;">
            ${isNewVault 
              ? 'Vergeben Sie ein sicheres Master-Passwort. Dieses Passwort schÃ¼tzt alle Ihre Daten.' 
              : 'Geben Sie Ihr Master-Passwort ein, um auf Ihre Daten zuzugreifen.'}
          </p>
        </div>
        <div style="background: #334155; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <label style="display: block; color: #e2e8f0; font-size: 12px; margin-bottom: 6px; font-weight: 600;">
            ${isNewVault ? 'Neues Master-Passwort:' : 'Master-Passwort:'}
          </label>
          <input type="password" id="${dialogId}-pw" placeholder="Mindestens 8 Zeichen..."
            style="width: 100%; padding: 12px 14px; border: 2px solid #475569; border-radius: 8px;
              background: #1e293b; color: #f8fafc; font-size: 16px; box-sizing: border-box; outline: none;" />
          <div id="${dialogId}-strength" style="margin-top: 6px; font-size: 11px; color: #94a3b8;"></div>
          ${isNewVault ? `
            <label style="display: block; color: #e2e8f0; font-size: 12px; margin: 12px 0 6px 0; font-weight: 600;">BestÃ¤tigen:</label>
            <input type="password" id="${dialogId}-confirm" placeholder="Passwort wiederholen..."
              style="width: 100%; padding: 12px 14px; border: 2px solid #475569; border-radius: 8px;
                background: #1e293b; color: #f8fafc; font-size: 16px; box-sizing: border-box; outline: none;" />
            <div id="${dialogId}-match" style="margin-top: 6px; font-size: 11px; color: #94a3b8;"></div>
          ` : ''}
        </div>
        ${allowStammdatenImport ? `
          <div style="background: #1e3a5f; border-radius: 8px; padding: 12px; margin-bottom: 16px; border: 1px solid #3b82f6;">
            <p style="color: #93c5fd; font-size: 11px; margin: 0 0 8px 0;">
              ğŸ“¦ Stammdaten von anderem GerÃ¤t importieren?
            </p>
            <label style="display: inline-block; background: #3b82f6; padding: 8px 16px; border-radius: 6px; cursor: pointer; color: white; font-size: 12px; font-weight: 600;">
              ğŸ“¥ .stammdaten.enc importieren
              <input type="file" id="${dialogId}-import" accept=".enc" style="display: none;" />
            </label>
          </div>
        ` : ''}
        <div style="display: flex; gap: 10px;">
          <button id="${dialogId}-btn" ${isNewVault ? 'disabled' : ''} style="flex: 2; padding: 14px;
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); border: none; border-radius: 8px;
            color: white; font-size: 14px; font-weight: 600; cursor: pointer; opacity: ${isNewVault ? '0.5' : '1'};">
            ${isNewVault ? 'ğŸ”’ Tresor erstellen' : 'ğŸ”“ Entsperren'}
          </button>
        </div>
        <div style="text-align: center; margin-top: 16px;">
          <p style="color: #64748b; font-size: 10px; margin: 0;">
            ğŸ›¡ï¸ AES-256-GCM
          </p>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    const pwInput = document.getElementById(`${dialogId}-pw`);
    const confirmInput = document.getElementById(`${dialogId}-confirm`);
    const strengthDiv = document.getElementById(`${dialogId}-strength`);
    const matchDiv = document.getElementById(`${dialogId}-match`);
    const confirmBtn = document.getElementById(`${dialogId}-btn`);
    const stammdatenInput = document.getElementById(`${dialogId}-import`);
    
    const validate = () => {
      const pw = pwInput.value;
      const confirm = confirmInput?.value || '';
      const strength = checkPasswordStrength(pw);
      
      if (pw.length > 0) {
        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981'];
        const labels = ['Sehr schwach', 'Schwach', 'Mittel', 'Stark', 'Sehr stark'];
        const idx = Math.min(Math.floor(strength.score / 2), 4);
        strengthDiv.innerHTML = '<span style="color: ' + colors[idx] + ';">â— ' + labels[idx] + '</span>';
      } else { 
        strengthDiv.innerHTML = ''; 
      }
      
      if (isNewVault && confirm.length > 0) {
        matchDiv.innerHTML = pw === confirm 
          ? '<span style="color: #22c55e;">âœ“ PasswÃ¶rter stimmen Ã¼berein</span>'
          : '<span style="color: #ef4444;">âœ— PasswÃ¶rter stimmen nicht Ã¼berein</span>';
      }
      
      const valid = isNewVault 
        ? (pw.length >= 8 && pw === confirm)
        : (pw.length > 0);
      confirmBtn.disabled = !valid;
      confirmBtn.style.opacity = valid ? '1' : '0.5';
    };
    
    pwInput.addEventListener('input', validate);
    if (confirmInput) confirmInput.addEventListener('input', validate);
    setTimeout(() => pwInput.focus(), 100);
    
    const handleKey = (e) => { 
      if (e.key === 'Enter' && !confirmBtn.disabled) confirmBtn.click(); 
    };
    pwInput.addEventListener('keydown', handleKey);
    if (confirmInput) confirmInput.addEventListener('keydown', handleKey);
    
    // Stammdaten Import Handler
    if (stammdatenInput) {
      stammdatenInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const importPw = prompt('Passwort fÃ¼r die Stammdaten-Datei:');
        if (!importPw) return;
        
        try {
          const buffer = await file.arrayBuffer();
          const stammdaten = await importStammdaten(buffer, importPw);
          overlay.remove();
          resolve({ type: 'stammdaten', data: stammdaten, password: pwInput.value || importPw });
        } catch (err) {
          alert('Import fehlgeschlagen: ' + err.message);
        }
      });
    }
    
    confirmBtn.addEventListener('click', () => { 
      overlay.remove(); 
      resolve({ type: 'password', password: pwInput.value }); 
    });
  });
}

function showExportPasswordDialog() {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); display: flex; align-items: center;
      justify-content: center; z-index: 99999;
    `;
    overlay.innerHTML = `
      <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #0d9488; border-radius: 16px; padding: 32px;
        max-width: 450px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 40px; margin-bottom: 12px;">ğŸ”</div>
          <h2 style="color: #f8fafc; margin: 0 0 8px 0; font-size: 20px;">VerschlÃ¼sselter Export</h2>
          <p style="color: #94a3b8; margin: 0; font-size: 13px;">Vergeben Sie ein sicheres Passwort fÃ¼r die Backup-Datei.</p>
        </div>
        <div style="background: #334155; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <label style="display: block; color: #e2e8f0; font-size: 12px; margin-bottom: 6px; font-weight: 600;">Passwort:</label>
          <input type="password" id="export-pw" placeholder="Mindestens 8 Zeichen..."
            style="width: 100%; padding: 10px 14px; border: 2px solid #475569; border-radius: 8px;
              background: #1e293b; color: #f8fafc; font-size: 15px; box-sizing: border-box; outline: none;" />
          <div id="pw-strength" style="margin-top: 6px; font-size: 11px; color: #94a3b8;"></div>
          <label style="display: block; color: #e2e8f0; font-size: 12px; margin: 12px 0 6px 0; font-weight: 600;">BestÃ¤tigen:</label>
          <input type="password" id="export-pw-confirm" placeholder="Passwort wiederholen..."
            style="width: 100%; padding: 10px 14px; border: 2px solid #475569; border-radius: 8px;
              background: #1e293b; color: #f8fafc; font-size: 15px; box-sizing: border-box; outline: none;" />
          <div id="pw-match" style="margin-top: 6px; font-size: 11px; color: #94a3b8;"></div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="export-cancel" style="flex: 1; padding: 12px; background: #475569; border: none;
            border-radius: 8px; color: #e2e8f0; font-size: 13px; font-weight: 600; cursor: pointer;">Abbrechen</button>
          <button id="export-confirm" disabled style="flex: 2; padding: 12px;
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); border: none; border-radius: 8px;
            color: white; font-size: 13px; font-weight: 600; cursor: pointer; opacity: 0.5;">ğŸ”’ Exportieren</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    const pwInput = document.getElementById('export-pw');
    const confirmInput = document.getElementById('export-pw-confirm');
    const strengthDiv = document.getElementById('pw-strength');
    const matchDiv = document.getElementById('pw-match');
    const confirmBtn = document.getElementById('export-confirm');
    const cancelBtn = document.getElementById('export-cancel');
    
    const validate = () => {
      const pw = pwInput.value;
      const confirm = confirmInput.value;
      const strength = checkPasswordStrength(pw);
      if (pw.length > 0) {
        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981'];
        const labels = ['Sehr schwach', 'Schwach', 'Mittel', 'Stark', 'Sehr stark'];
        const idx = Math.min(Math.floor(strength.score / 2), 4);
        strengthDiv.innerHTML = '<span style="color: ' + colors[idx] + ';">â— ' + labels[idx] + '</span>';
      } else { strengthDiv.innerHTML = ''; }
      if (confirm.length > 0) {
        matchDiv.innerHTML = pw === confirm 
          ? '<span style="color: #22c55e;">âœ“ PasswÃ¶rter stimmen Ã¼berein</span>'
          : '<span style="color: #ef4444;">âœ— PasswÃ¶rter stimmen nicht Ã¼berein</span>';
      } else { matchDiv.innerHTML = ''; }
      const valid = pw.length >= 8 && pw === confirm;
      confirmBtn.disabled = !valid;
      confirmBtn.style.opacity = valid ? '1' : '0.5';
    };
    pwInput.addEventListener('input', validate);
    confirmInput.addEventListener('input', validate);
    setTimeout(() => pwInput.focus(), 100);
    
    const handleKey = (e) => { 
      if (e.key === 'Enter' && !confirmBtn.disabled) confirmBtn.click(); 
      else if (e.key === 'Escape') cancelBtn.click(); 
    };
    pwInput.addEventListener('keydown', handleKey);
    confirmInput.addEventListener('keydown', handleKey);
    
    confirmBtn.addEventListener('click', () => { overlay.remove(); resolve(pwInput.value); });
    cancelBtn.addEventListener('click', () => { overlay.remove(); resolve(null); });
  });
}

function showImportPasswordDialog() {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); display: flex; align-items: center;
      justify-content: center; z-index: 99999;
    `;
    overlay.innerHTML = `
      <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #3b82f6; border-radius: 16px; padding: 32px;
        max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 40px; margin-bottom: 12px;">ğŸ”“</div>
          <h2 style="color: #f8fafc; margin: 0 0 8px 0; font-size: 20px;">Backup entschlÃ¼sseln</h2>
          <p style="color: #94a3b8; margin: 0; font-size: 13px;">Geben Sie das Passwort fÃ¼r die Backup-Datei ein.</p>
        </div>
        <div style="background: #334155; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <input type="password" id="import-pw" placeholder="Passwort eingeben..."
            style="width: 100%; padding: 12px 14px; border: 2px solid #475569; border-radius: 8px;
              background: #1e293b; color: #f8fafc; font-size: 15px; box-sizing: border-box; outline: none;" />
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="import-cancel" style="flex: 1; padding: 12px; background: #475569; border: none;
            border-radius: 8px; color: #e2e8f0; font-size: 13px; font-weight: 600; cursor: pointer;">Abbrechen</button>
          <button id="import-confirm" style="flex: 2; padding: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px;
            color: white; font-size: 13px; font-weight: 600; cursor: pointer;">ğŸ”“ EntschlÃ¼sseln</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    const pwInput = document.getElementById('import-pw');
    const confirmBtn = document.getElementById('import-confirm');
    const cancelBtn = document.getElementById('import-cancel');
    
    setTimeout(() => pwInput.focus(), 100);
    
    pwInput.addEventListener('keydown', (e) => { 
      if (e.key === 'Enter') confirmBtn.click(); 
      else if (e.key === 'Escape') cancelBtn.click(); 
    });
    
    confirmBtn.addEventListener('click', () => { overlay.remove(); resolve(pwInput.value || null); });
    cancelBtn.addEventListener('click', () => { overlay.remove(); resolve(null); });
  });
}
</script>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VAULT CONTEXT - Zentraler State mit VerschlÃ¼sselung
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VaultContext = createContext(null);

const DEFAULT_STATE = {
  kunden: [],
  material: [],
  rechnungen: [],
  angebote: [],
  entwuerfe: [], // Liste aller EntwÃ¼rfe in Bearbeitung
  zeiterfassung: {
    projekte: [],
    mitarbeiter: [], // Namen als Strings
    monatsListe: [], // Separate Monats-Stunden (unabhÃ¤ngig von Projekten)
    einstellungen: {
      pauseStart: "12:00",
      pauseEnde: "12:30",
      pauseAktiv: true,
      stundenlohn: 50
    }
  },
  firmenDaten: {
    id: 1,
    firmenname: "Musterfirma GmbH",
    logo: "",
    logoPosition: "links",
    logoBreite: 40,
    logoHoehe: 15,
    inhaberName: "Max Mustermann",
    strasse: "MusterstraÃŸe 1",
    plz: "12345",
    ort: "Musterstadt",
    land: "Deutschland",
    telefon: "+49 123 456789",
    email: "info@musterfirma.de",
    website: "www.musterfirma.de",
    steuernummer: "123/456/78901",
    bankName: "Musterbank",
    iban: "DE12345678901234567890",
    bic: "MUSTDEFF",
    primaerFarbe: "#006666",
    briefkopfFarbe: "#444444",
    briefkopfAbsender: "inhaber",
    zahlungsziel: 10,
    angebotsgueltigkeit: 30,
    stundensatz: 59,
    angebotHinweis: "Unvorhergesehene Arbeiten werden mit {stundensatz},- â‚¬/Std. abgerechnet."
  },
  meta: {
    version: 5,
    created: new Date().toISOString(),
    lastModified: new Date().toISOString()
  }
};

function VaultProvider({ children }) {
  const [isUnlocked, setIsUnlocked] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [hasExistingVault, setHasExistingVault] = useState(false);
  const [appState, setAppState] = useState(DEFAULT_STATE);
  const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'pending', 'saving', 'error'
  const [lastSaved, setLastSaved] = useState(null);
  
  // Cloud-Sync State
  const HARDCODED_WORKER_URL = 'https://tight-wind-6426.michael-starkulla.workers.dev';
  
  const [cloudConfig, setCloudConfig] = useState(() => {
    // Lade cloudConfig aus localStorage (nicht verschlÃ¼sselt, da nur Lizenzkey)
    // Worker-URL ist fest eingebaut und wird immer Ã¼berschrieben
    try {
      const saved = localStorage.getItem('vault_cloud_config');
      const parsed = saved ? JSON.parse(saved) : { licenseKey: '', enabled: false };
      return { ...parsed, workerUrl: HARDCODED_WORKER_URL };
    } catch {
      return { licenseKey: '', enabled: false, workerUrl: HARDCODED_WORKER_URL };
    }
  });
  const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'uploading', 'success', 'error'
  const [lastSyncError, setLastSyncError] = useState(null);
  
  // Speichere cloudConfig in localStorage wenn es sich Ã¤ndert
  useEffect(() => {
    localStorage.setItem('vault_cloud_config', JSON.stringify(cloudConfig));
  }, [cloudConfig]);
  
  const debounceTimerRef = useRef(null);
  const pendingStateRef = useRef(null);
  const hasCheckedCloud = useRef(false);
  
  // PrÃ¼fe beim Start ob ein Vault existiert
  useEffect(() => {
    (async () => {
      try {
        const exists = await SecureVault.hasData();
        setHasExistingVault(exists);
      } catch (err) {
        console.error('Vault-Check fehlgeschlagen:', err);
      }
      setIsLoading(false);
    })();
  }, []);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLOUD-SYNC FUNKTION - Upload zu Cloudflare R2 via Worker
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const syncToCloud = useCallback(async (encryptedBlob) => {
    // PrÃ¼fe ob Cloud-Sync aktiviert ist
    if (!cloudConfig.enabled || !cloudConfig.licenseKey || !cloudConfig.workerUrl) {
      console.log('â˜ï¸ Cloud-Sync deaktiviert oder nicht konfiguriert');
      return;
    }
    
    setSyncStatus('uploading');
    setLastSyncError(null);
    
    try {
      console.log('â˜ï¸ Starte Cloud-Sync...');
      
      // Schritt A: Authentifizierung und Presigned URL holen
      const authResponse = await fetch(`${cloudConfig.workerUrl}/auth`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ licenseKey: cloudConfig.licenseKey }),
      });
      
      if (!authResponse.ok) {
        const errorData = await authResponse.json().catch(() => ({}));
        throw new Error(errorData.error || `Auth fehlgeschlagen: ${authResponse.status}`);
      }
      
      const { uploadUrl, downloadUrl, objectKey } = await authResponse.json();
      console.log('â˜ï¸ Presigned URL erhalten fÃ¼r:', objectKey);
      
      // Schritt B: Blob direkt zur Presigned URL hochladen
      const uploadResponse = await fetch(uploadUrl, {
        method: 'PUT',
        body: encryptedBlob,
        headers: {
          'Content-Type': 'application/octet-stream',
        },
      });
      
      if (!uploadResponse.ok) {
        throw new Error(`Upload fehlgeschlagen: ${uploadResponse.status}`);
      }
      
      console.log('â˜ï¸ Cloud-Sync erfolgreich!');
      setSyncStatus('success');
      
      // Status nach 3 Sekunden auf idle zurÃ¼cksetzen
      setTimeout(() => setSyncStatus('idle'), 3000);
      
    } catch (err) {
      console.error('â˜ï¸ Cloud-Sync Fehler:', err);
      setSyncStatus('error');
      setLastSyncError(err.message);
      
      // Status nach 5 Sekunden auf idle zurÃ¼cksetzen
      setTimeout(() => setSyncStatus('idle'), 5000);
    }
  }, [cloudConfig]);
  
  // Debounced Save Funktion
  const saveToVault = useCallback(async (stateToSave) => {
    if (!SecureVault.encryptionKey) return;
    
    setSaveStatus('saving');
    try {
      const stateWithMeta = {
        ...stateToSave,
        meta: {
          ...stateToSave.meta,
          lastModified: new Date().toISOString()
        }
      };
      
      // VerschlÃ¼ssele die Daten (wird auch fÃ¼r Cloud-Sync benÃ¶tigt)
      const encrypted = await workerEncrypt(stateWithMeta, SecureVault.encryptionKey, true);
      
      // Lokales Speichern in IndexedDB (blockierend)
      const db = await SecureVault.openDB();
      await new Promise((resolve, reject) => {
        const tx = db.transaction(VAULT_CONFIG.STORE_NAME, 'readwrite');
        const store = tx.objectStore(VAULT_CONFIG.STORE_NAME);
        const req = store.put(encrypted, VAULT_CONFIG.KEY_NAME);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
      
      setSaveStatus('saved');
      setLastSaved(new Date());
      console.log('âœ“ Vault gespeichert (5MB Fixed-Size)');
      
      // Fire-and-Forget: Cloud-Sync NACH erfolgreichem lokalen Speichern
      // Kein await - UI blockiert nicht
      if (cloudConfig.enabled) {
        const blob = new Blob([encrypted], { type: 'application/octet-stream' });
        syncToCloud(blob);
      }
      
    } catch (err) {
      console.error('Speichern fehlgeschlagen:', err);
      setSaveStatus('error');
    }
  }, [cloudConfig.enabled, syncToCloud]);
  
  // Debouncing: Speichert erst nach 2 Sekunden InaktivitÃ¤t
  const queueSave = useCallback((newState) => {
    pendingStateRef.current = newState;
    setSaveStatus('pending');
    
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }
    
    debounceTimerRef.current = setTimeout(() => {
      if (pendingStateRef.current) {
        saveToVault(pendingStateRef.current);
        pendingStateRef.current = null;
      }
    }, VAULT_CONFIG.DEBOUNCE_MS);
  }, [saveToVault]);
  
  // State-Update mit automatischem Debounced Save
  const updateState = useCallback((updater) => {
    setAppState(prev => {
      const newState = typeof updater === 'function' ? updater(prev) : { ...prev, ...updater };
      queueSave(newState);
      return newState;
    });
  }, [queueSave]);
  
  // Sofortiges Speichern (z.B. beim Klick auf "Speichern")
  const forceSave = useCallback(async () => {
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
      debounceTimerRef.current = null;
    }
    const stateToSave = pendingStateRef.current || appState;
    pendingStateRef.current = null;
    await saveToVault(stateToSave);
  }, [appState, saveToVault]);
  
  // Vault entsperren
  const unlockVault = useCallback(async (password) => {
    try {
      setIsLoading(true);
      const data = await SecureVault.load(password);
      if (data) {
        setAppState(data);
      }
      setIsUnlocked(true);
      setIsLoading(false);
      return true;
    } catch (err) {
      setIsLoading(false);
      throw err;
    }
  }, []);
  
  // Neuen Vault erstellen
  const createVault = useCallback(async (password, initialData = DEFAULT_STATE) => {
    try {
      setIsLoading(true);
      await SecureVault.initialize(password, initialData);
      setAppState(initialData);
      setIsUnlocked(true);
      setHasExistingVault(true);
      setIsLoading(false);
      return true;
    } catch (err) {
      setIsLoading(false);
      throw err;
    }
  }, []);
  
  // Vault mit Stammdaten initialisieren
  const initializeWithStammdaten = useCallback(async (password, stammdaten) => {
    const newState = {
      ...DEFAULT_STATE,
      kunden: stammdaten.kundenListe || [],
      material: stammdaten.materialListe || [],
      firmenDaten: { ...DEFAULT_STATE.firmenDaten, ...stammdaten.firmenDaten },
      rechnungen: [], // WICHTIG: Keine alten Rechnungen
      angebote: [], // WICHTIG: Keine alten Angebote
      meta: {
        version: 5,
        created: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        importedFrom: stammdaten.date
      }
    };
    return createVault(password, newState);
  }, [createVault]);
  
  // Sauberes Sperren des Vaults (Logout)
  const lockVault = useCallback(async () => {
    // Erst ausstehende Ã„nderungen speichern
    if (pendingStateRef.current || saveStatus === 'pending') {
      await forceSave();
    }
    // Dann sauber sperren
    SecureVault.emergencyWipe();
    setIsUnlocked(false);
    setAppState(DEFAULT_STATE);
    setSaveStatus('saved');
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }
    pendingStateRef.current = null;
  }, [forceSave, saveStatus]);
  
  // Stammdaten exportieren
  const exportStammdatenFile = useCallback(async () => {
    const password = await showExportPasswordDialog();
    if (!password) return;
    
    try {
      const encrypted = await exportStammdaten(appState, password);
      const blob = new Blob([encrypted], { type: 'application/octet-stream' });
      const filename = `stammdaten-${new Date().toISOString().slice(0,10)}.stammdaten.enc`;
      await handleFileExport(blob, filename);
    } catch (err) {
      alert('Export fehlgeschlagen: ' + err.message);
    }
  }, [appState]);
  
  // VollstÃ¤ndiges Backup exportieren (5MB Fixed-Size â†’ Base64 Text fÃ¼r Android)
  const exportFullBackup = useCallback(async () => {
    const password = await showExportPasswordDialog();
    if (!password) return;
    
    const loading = showLoadingDialog('ğŸ” VerschlÃ¼ssele Backup...');
    
    try {
      loading.updateMessage('âš™ï¸ Generiere 5MB Privacy-Padding...');
      
      // Kryptografisch anonymisierte 5MB Fixed-Size VerschlÃ¼sselung â†’ Base64
      const base64Text = await exportFixedSizeBackup(appState, password);
      
      loading.updateMessage('ğŸ“¦ Konvertiere fÃ¼r Android...');
      
      // Base64 Text (ca. 7MB durch Base64-Overhead)
      console.log(`âœ“ Export-GrÃ¶ÃŸe: ${base64Text.length} Zeichen (Base64)`);
      console.log(`âœ“ BinÃ¤r-Ã„quivalent: ${VAULT_CONFIG.FIXED_SIZE} Bytes (5 MB)`);
      
      // Als Text-Datei fÃ¼r Android Share-KompatibilitÃ¤t
      const blob = new Blob([base64Text], { type: 'text/plain;charset=utf-8' });
      
      // Neutraler Dateiname (.txt fÃ¼r Android)
      const filename = getRandomNeutralFilename();
      
      loading.close();
      await handleFileExport(blob, filename);
      
    } catch (err) {
      loading.close();
      console.error('Export-Fehler:', err);
      alert('Export fehlgeschlagen: ' + err.message);
    }
  }, [appState]);
  
  // Backup importieren (unterstÃ¼tzt Base64-Text, Fixed-Size und Legacy-Format)
  const importBackupFile = useCallback(async (file) => {
    const isEncrypted = file.name.endsWith('.txt') || file.name.endsWith('.enc') || 
                        file.name.endsWith('.dat') || file.name.endsWith('.bin') ||
                        file.name.endsWith('.tmp') || file.name.endsWith('.sys');
    
    if (isEncrypted) {
      const password = await showImportPasswordDialog();
      if (!password) return;
      
      const loading = showLoadingDialog('ğŸ”“ EntschlÃ¼ssele Backup...');
      
      try {
        let data;
        
        // Erst als Text lesen um Base64-Format zu prÃ¼fen
        const textContent = await file.text();
        
        if (isBase64Backup(textContent)) {
          // Neues Base64-Format (5MB Fixed-Size als Text)
          loading.updateMessage('ğŸ“¦ Dekodiere Base64-Backup...');
          console.log('âœ“ Base64-Backup erkannt, LÃ¤nge:', textContent.length);
          data = await importFixedSizeBackup(textContent, password);
          
        } else {
          // Binary-Format (Legacy oder altes Fixed-Size)
          loading.updateMessage('ğŸ“¦ Verarbeite Binary-Backup...');
          const buffer = await file.arrayBuffer();
          
          if (buffer.byteLength === VAULT_CONFIG.FIXED_SIZE) {
            // Legacy 5MB Fixed-Size Binary
            data = await importFixedSizeBackup(buffer, password);
          } else {
            // Altes Legacy-Format
            data = await decryptData(buffer, password);
          }
        }
        
        loading.close();
        
        if (!data.kunden && !data.material && !data.zeiterfassung) throw new Error('UngÃ¼ltiges Format');
        
        if (!confirm('Aktuelle Daten Ã¼berschreiben? Alle lokalen Ã„nderungen gehen verloren!')) return;
        
        const newState = {
          ...DEFAULT_STATE,
          kunden: data.kunden || [],
          material: data.material || [],
          rechnungen: data.rechnungen || [],
          angebote: data.angebote || [],
          entwuerfe: data.entwuerfe || [],
          zeiterfassung: data.zeiterfassung || DEFAULT_STATE.zeiterfassung,
          firmenDaten: { ...DEFAULT_STATE.firmenDaten, ...(data.firmenDaten || data.einstellungen?.[0] || {}) },
          meta: {
            version: 5,
            created: data.meta?.created || new Date().toISOString(),
            lastModified: new Date().toISOString(),
            importedFrom: 'backup-import'
          }
        };
        
        updateState(newState);
        await forceSave();
        alert('Import erfolgreich!');
      } catch (err) {
        loading.close();
        alert('Import fehlgeschlagen: ' + err.message);
      }
    }
  }, [updateState, forceSave]);
  
  // Cloud-Config aktualisieren
  const updateCloudConfig = useCallback((newConfig) => {
    setCloudConfig(prev => ({ ...prev, ...newConfig }));
  }, []);
  
  // Manueller Cloud-Sync auslÃ¶sen
  const triggerCloudSync = useCallback(async () => {
    if (!SecureVault.encryptionKey) {
      console.warn('Vault nicht entsperrt');
      return;
    }
    
    try {
      const encrypted = await workerEncrypt(appState, SecureVault.encryptionKey, true);
      const blob = new Blob([encrypted], { type: 'application/octet-stream' });
      await syncToCloud(blob);
    } catch (err) {
      console.error('Manueller Sync fehlgeschlagen:', err);
    }
  }, [appState, syncToCloud]);
  
  // Cloud-Restore: Backup aus Cloud wiederherstellen
  const restoreFromCloud = useCallback(async () => {
    if (!cloudConfig.enabled || !cloudConfig.licenseKey || !cloudConfig.workerUrl) {
      alert('Cloud-Sync ist nicht konfiguriert.');
      return;
    }
    
    if (!SecureVault.encryptionKey) {
      alert('Vault nicht entsperrt.');
      return;
    }
    
    // Benutzer wÃ¤hlt Modus: Merge oder Ãœberschreiben
    const userChoice = prompt(
      'â˜ï¸ Cloud-Backup laden\n\n' +
      'WÃ¤hlen Sie den Modus:\n\n' +
      '1 = ZUSAMMENFÃœHREN (empfohlen)\n' +
      '    â†’ Lokale Daten bleiben erhalten\n' +
      '    â†’ Neue Cloud-Daten werden hinzugefÃ¼gt\n\n' +
      '2 = VOLLSTÃ„NDIG ERSETZEN\n' +
      '    â†’ ALLE lokalen Daten werden gelÃ¶scht\n' +
      '    â†’ Nur Cloud-Daten bleiben\n\n' +
      'Geben Sie 1 oder 2 ein:'
    );
    
    if (!userChoice || (userChoice !== '1' && userChoice !== '2')) {
      return;
    }
    
    const useFullReplace = userChoice === '2';
    
    if (useFullReplace && !confirm('âš ï¸ WARNUNG!\n\nALLE lokalen Daten werden UNWIDERRUFLICH gelÃ¶scht!\n\nSind Sie absolut sicher?')) {
      return;
    }
    
    setSyncStatus('downloading');
    setLastSyncError(null);
    const loading = showLoadingDialog('â˜ï¸ Lade Backup aus Cloud...');
    
    try {
      // 1. URL holen
      const authResponse = await fetch(`${cloudConfig.workerUrl}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ licenseKey: cloudConfig.licenseKey }),
      });
      
      if (!authResponse.ok) throw new Error('Authentifizierung fehlgeschlagen');
      const { downloadUrl } = await authResponse.json();

      // 2. Datei herunterladen
      loading.updateMessage('ğŸ“¥ Lade Daten...');
      const fileResponse = await fetch(downloadUrl);
      if (!fileResponse.ok) throw new Error('Download fehlgeschlagen');
      
      // Als ArrayBuffer lesen (wichtig fÃ¼r BinÃ¤rdaten!)
      const encryptedBuffer = await fileResponse.arrayBuffer();

      // 3. DIREKT entschlÃ¼sseln (Umgeht importFixedSizeBackup!)
      loading.updateMessage('ğŸ”“ EntschlÃ¼ssele...');
      let cloudData = await workerDecrypt(encryptedBuffer, SecureVault.encryptionKey, true);

      // 4. PrÃ¼fen ob es vielleicht doch ein Export-Container ist (Wrapper entfernen)
      if (cloudData && cloudData.f === 'fsb' && cloudData.d) {
        cloudData = cloudData.d;
      }

      // 5. Inhalt prÃ¼fen
      if (!cloudData || (!cloudData.kunden && !cloudData.material)) {
        throw new Error('EntschlÃ¼sselte Daten sind leer oder ungÃ¼ltig');
      }

      // 6. State wiederherstellen
      loading.updateMessage('ğŸ’¾ Speichere...');
      
      let newState;
      let resultMessage;
      
      if (useFullReplace) {
        // MODUS 2: VollstÃ¤ndig ersetzen
        newState = {
          ...DEFAULT_STATE,
          kunden: cloudData.kunden || [],
          material: cloudData.material || [],
          rechnungen: cloudData.rechnungen || [],
          angebote: cloudData.angebote || [],
          entwuerfe: cloudData.entwuerfe || [],
          zeiterfassung: cloudData.zeiterfassung || DEFAULT_STATE.zeiterfassung,
          firmenDaten: { ...DEFAULT_STATE.firmenDaten, ...(cloudData.firmenDaten || {}) },
          meta: { ...cloudData.meta, restoredFrom: 'cloud-full-restore' }
        };
        resultMessage = 'âœ… Cloud-Backup vollstÃ¤ndig wiederhergestellt!\n\nAlle lokalen Daten wurden ersetzt.';
      } else {
        // MODUS 1: Smart Merge
        const { mergedData, stats } = mergeAllData(appState, cloudData);
        
        newState = {
          ...DEFAULT_STATE,
          kunden: mergedData.kunden,
          material: mergedData.material,
          rechnungen: mergedData.rechnungen,
          angebote: mergedData.angebote,
          entwuerfe: mergedData.entwuerfe,
          zeiterfassung: mergedData.zeiterfassung,
          firmenDaten: { ...DEFAULT_STATE.firmenDaten, ...(appState.firmenDaten || {}), ...(cloudData.firmenDaten || {}) },
          meta: { 
            ...appState.meta,
            lastModified: new Date().toISOString(),
            lastMerge: new Date().toISOString(),
            mergeSource: 'cloud-manual-restore'
          }
        };
        resultMessage = `âœ… Cloud-Sync abgeschlossen!\n\n${stats.totalAdded} EintrÃ¤ge hinzugefÃ¼gt\n${stats.totalUpdated} EintrÃ¤ge aktualisiert\n\nLokale Daten wurden beibehalten.`;
      }

      updateState(newState);
      await forceSave();
      
      loading.close();
      setSyncStatus('success');
      setTimeout(() => setSyncStatus('idle'), 3000);
      alert(resultMessage);

    } catch (err) {
      loading.close();
      console.error(err);
      setSyncStatus('error');
      
      if (err.name === 'OperationError' || err.message.includes('Check failed')) {
         alert('âŒ EntschlÃ¼sselung fehlgeschlagen.\nFalsches Passwort oder Datei beschÃ¤digt.');
      } else {
         alert('Fehler: ' + err.message);
      }
    }
  }, [cloudConfig, appState, updateState, forceSave, mergeAllData]);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SMART MERGE - Intelligentes ZusammenfÃ¼hren von Daten ohne Datenverlust
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  /**
   * FÃ¼hrt zwei Listen anhand ihrer ID zusammen
   * - Elemente die nur lokal existieren â†’ behalten
   * - Elemente die nur in Cloud existieren â†’ hinzufÃ¼gen
   * - Elemente die in beiden existieren â†’ neueres behalten (lastModified)
   * @returns {merged: Array, stats: {added: number, updated: number, unchanged: number}}
   */
  const mergeLists = useCallback((localList = [], cloudList = [], idField = 'id') => {
    const localMap = new Map();
    const stats = { added: 0, updated: 0, unchanged: 0 };
    
    // Alle lokalen EintrÃ¤ge in Map
    localList.forEach(item => {
      if (item && item[idField]) {
        localMap.set(item[idField], item);
      }
    });
    
    // Cloud-EintrÃ¤ge durchgehen
    cloudList.forEach(cloudItem => {
      if (!cloudItem || !cloudItem[idField]) return;
      
      const localItem = localMap.get(cloudItem[idField]);
      
      if (!localItem) {
        // Element existiert nur in Cloud â†’ hinzufÃ¼gen
        localMap.set(cloudItem[idField], cloudItem);
        stats.added++;
      } else {
        // Element existiert in beiden â†’ vergleiche Zeitstempel
        const cloudTime = cloudItem.lastModified || cloudItem.datum || 0;
        const localTime = localItem.lastModified || localItem.datum || 0;
        
        const cloudDate = new Date(cloudTime).getTime() || 0;
        const localDate = new Date(localTime).getTime() || 0;
        
        if (cloudDate > localDate) {
          // Cloud ist neuer â†’ Ã¼bernehmen
          localMap.set(cloudItem[idField], cloudItem);
          stats.updated++;
        } else {
          stats.unchanged++;
        }
      }
    });
    
    return {
      merged: Array.from(localMap.values()),
      stats
    };
  }, []);
  
  /**
   * FÃ¼hrt alle Datenlisten zusammen und liefert Statistiken
   */
  const mergeAllData = useCallback((localData, cloudData) => {
    const results = {
      kunden: mergeLists(localData.kunden, cloudData.kunden, 'id'),
      material: mergeLists(localData.material, cloudData.material, 'id'),
      rechnungen: mergeLists(localData.rechnungen, cloudData.rechnungen, 'id'),
      angebote: mergeLists(localData.angebote, cloudData.angebote, 'id'),
      entwuerfe: mergeLists(localData.entwuerfe, cloudData.entwuerfe, 'entwurfId'),
    };
    
    // Zeiterfassung separat mergen (hat verschachtelte Struktur)
    const localZeit = localData.zeiterfassung || DEFAULT_STATE.zeiterfassung;
    const cloudZeit = cloudData.zeiterfassung || DEFAULT_STATE.zeiterfassung;
    const mergedZeiterfassung = {
      projekte: mergeLists(localZeit.projekte || [], cloudZeit.projekte || [], 'id').merged,
      monatsListe: mergeLists(localZeit.monatsListe || [], cloudZeit.monatsListe || [], 'id').merged,
      mitarbeiter: [...new Set([...(localZeit.mitarbeiter || []), ...(cloudZeit.mitarbeiter || [])])].sort(),
      einstellungen: { ...(localZeit.einstellungen || {}), ...(cloudZeit.einstellungen || {}) },
      aktiv: localZeit.aktiv || cloudZeit.aktiv || null
    };
    
    // Gesamtstatistik
    const totalAdded = Object.values(results).reduce((sum, r) => sum + r.stats.added, 0);
    const totalUpdated = Object.values(results).reduce((sum, r) => sum + r.stats.updated, 0);
    
    return {
      mergedData: {
        kunden: results.kunden.merged,
        material: results.material.merged,
        rechnungen: results.rechnungen.merged,
        angebote: results.angebote.merged,
        entwuerfe: results.entwuerfe.merged,
        zeiterfassung: mergedZeiterfassung,
      },
      stats: {
        kunden: results.kunden.stats,
        material: results.material.stats,
        rechnungen: results.rechnungen.stats,
        angebote: results.angebote.stats,
        entwuerfe: results.entwuerfe.stats,
        totalAdded,
        totalUpdated
      }
    };
  }, [mergeLists]);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLOUD-UPDATE CHECK - PrÃ¼ft beim Start ob neuere Daten in der Cloud sind
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const checkCloudUpdate = useCallback(async () => {
    // Nur prÃ¼fen wenn Cloud konfiguriert ist
    if (!cloudConfig.enabled || !cloudConfig.licenseKey || !cloudConfig.workerUrl) {
      return;
    }
    
    if (!SecureVault.encryptionKey) {
      return;
    }
    
    try {
      console.log('â˜ï¸ PrÃ¼fe auf Cloud-Updates...');
      
      // 1. Download-URL holen
      const authResponse = await fetch(`${cloudConfig.workerUrl}/auth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ licenseKey: cloudConfig.licenseKey }),
      });
      
      if (!authResponse.ok) {
        console.log('â˜ï¸ Auth fehlgeschlagen, Ã¼berspringe Cloud-Check');
        return;
      }
      
      const { downloadUrl } = await authResponse.json();
      
      // 2. Cloud-Daten herunterladen
      const fileResponse = await fetch(downloadUrl);
      
      if (!fileResponse.ok) {
        if (fileResponse.status === 404) {
          console.log('â˜ï¸ Kein Cloud-Backup vorhanden');
          return;
        }
        console.log('â˜ï¸ Download fehlgeschlagen:', fileResponse.status);
        return;
      }
      
      const encryptedBuffer = await fileResponse.arrayBuffer();
      
      // 3. EntschlÃ¼sseln
      let cloudData = await workerDecrypt(encryptedBuffer, SecureVault.encryptionKey, true);
      
      // Falls Export-Container, entpacken
      if (cloudData && cloudData.f === 'fsb' && cloudData.d) {
        cloudData = cloudData.d;
      }
      
      // 4. Validieren
      if (!cloudData || (!cloudData.kunden && !cloudData.material)) {
        console.log('â˜ï¸ Cloud-Daten ungÃ¼ltig oder leer');
        return;
      }
      
      // 5. Zeitstempel fÃ¼r Anzeige holen
      const cloudModified = cloudData.meta?.lastModified ? new Date(cloudData.meta.lastModified) : null;
      const localModified = appState.meta?.lastModified ? new Date(appState.meta.lastModified) : null;
      
      // 6. Benutzer fragen
      const cloudDateStr = cloudModified ? cloudModified.toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'unbekannt';
      
      const localDateStr = localModified ? localModified.toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'unbekannt';
      
      // 7. SMART MERGE - Daten zusammenfÃ¼hren statt Ã¼berschreiben
      const { mergedData, stats } = mergeAllData(appState, cloudData);
      
      // PrÃ¼fen ob Ã¼berhaupt etwas zu mergen ist
      if (stats.totalAdded === 0 && stats.totalUpdated === 0) {
        console.log('â˜ï¸ Keine neuen Daten in der Cloud');
        return;
      }
      
      // Merge-Zusammenfassung erstellen
      const summaryParts = [];
      if (stats.kunden.added > 0) summaryParts.push(`${stats.kunden.added} neue Kunden`);
      if (stats.kunden.updated > 0) summaryParts.push(`${stats.kunden.updated} aktualisierte Kunden`);
      if (stats.material.added > 0) summaryParts.push(`${stats.material.added} neue Materialien`);
      if (stats.material.updated > 0) summaryParts.push(`${stats.material.updated} aktualisierte Materialien`);
      if (stats.rechnungen.added > 0) summaryParts.push(`${stats.rechnungen.added} neue Rechnungen`);
      if (stats.rechnungen.updated > 0) summaryParts.push(`${stats.rechnungen.updated} aktualisierte Rechnungen`);
      if (stats.angebote.added > 0) summaryParts.push(`${stats.angebote.added} neue Angebote`);
      if (stats.angebote.updated > 0) summaryParts.push(`${stats.angebote.updated} aktualisierte Angebote`);
      if (stats.entwuerfe.added > 0) summaryParts.push(`${stats.entwuerfe.added} neue EntwÃ¼rfe`);
      if (stats.entwuerfe.updated > 0) summaryParts.push(`${stats.entwuerfe.updated} aktualisierte EntwÃ¼rfe`);
      
      const summaryText = summaryParts.join('\nâ€¢ ');
      
      const shouldMerge = confirm(
        `â˜ï¸ Cloud-Backup gefunden!\n\n` +
        `Cloud: ${cloudDateStr}\n` +
        `Lokal: ${localDateStr}\n\n` +
        `Folgende Daten werden zusammengefÃ¼hrt:\nâ€¢ ${summaryText}\n\n` +
        `MÃ¶chten Sie die Daten zusammenfÃ¼hren?\n` +
        `(Lokale Daten bleiben erhalten, neue werden hinzugefÃ¼gt)`
      );
      
      if (!shouldMerge) {
        console.log('â˜ï¸ Benutzer hat Cloud-Merge abgelehnt');
        return;
      }
      
      // 7. Gemergte Daten Ã¼bernehmen
      const newState = {
        ...DEFAULT_STATE,
        kunden: mergedData.kunden,
        material: mergedData.material,
        rechnungen: mergedData.rechnungen,
        angebote: mergedData.angebote,
        entwuerfe: mergedData.entwuerfe,
        zeiterfassung: mergedData.zeiterfassung,
        firmenDaten: { ...DEFAULT_STATE.firmenDaten, ...(cloudData.firmenDaten || {}), ...(appState.firmenDaten || {}) },
        meta: { 
          ...appState.meta,
          lastModified: new Date().toISOString(),
          lastMerge: new Date().toISOString(),
          mergeSource: 'cloud-auto-check'
        }
      };
      
      updateState(newState);
      await forceSave();
      
      console.log('â˜ï¸ Cloud-Daten erfolgreich gemerged:', stats);
      alert(`âœ… Cloud-Sync abgeschlossen!\n\n${stats.totalAdded} EintrÃ¤ge hinzugefÃ¼gt\n${stats.totalUpdated} EintrÃ¤ge aktualisiert`);
      
    } catch (err) {
      // Silent fail - nur loggen, nicht den User stÃ¶ren
      console.error('â˜ï¸ Cloud-Check Fehler (silent):', err.message);
    }
  }, [cloudConfig, appState, updateState, forceSave, mergeAllData]);
  
  // Effect: Cloud-Check nach erfolgreichem Login
  useEffect(() => {
    if (isUnlocked && cloudConfig.enabled) {
      // Verhindere doppelten Aufruf
      if (hasCheckedCloud.current) return;
      
      hasCheckedCloud.current = true;
      checkCloudUpdate();
    } else if (!isUnlocked) {
      // Reset beim Ausloggen, damit beim nÃ¤chsten Login wieder geprÃ¼ft wird
      hasCheckedCloud.current = false;
    }
  }, [isUnlocked, cloudConfig.enabled, checkCloudUpdate]);
  
  const value = {
    isUnlocked,
    isLoading,
    hasExistingVault,
    appState,
    saveStatus,
    lastSaved,
    updateState,
    forceSave,
    unlockVault,
    createVault,
    initializeWithStammdaten,
    lockVault,
    exportStammdatenFile,
    exportFullBackup,
    importBackupFile,
    // Cloud-Sync
    cloudConfig,
    updateCloudConfig,
    syncStatus,
    lastSyncError,
    triggerCloudSync,
    restoreFromCloud
  };
  
  return (
    <VaultContext.Provider value={value}>
      {children}
    </VaultContext.Provider>
  );
}

function useVault() {
  const context = useContext(VaultContext);
  if (!context) throw new Error('useVault muss innerhalb VaultProvider verwendet werden');
  return context;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN SCREEN - Passwort-Abfrage beim Start
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function LoginScreen() {
  const { hasExistingVault, unlockVault, createVault, initializeWithStammdaten } = useVault();
  const [error, setError] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const hasStartedRef = useRef(false);
  
  useEffect(() => {
    // Verhindere mehrfache Aufrufe
    if (hasStartedRef.current) return;
    hasStartedRef.current = true;
    
    const handleLogin = async () => {
      setIsProcessing(true);
      setError('');
      
      try {
        const result = await showVaultPasswordDialog(!hasExistingVault, !hasExistingVault);
        
        if (!result || !result.password) {
          setError('Kein Passwort eingegeben');
          setIsProcessing(false);
          hasStartedRef.current = false;
          return;
        }
        
        if (result.type === 'stammdaten') {
          await initializeWithStammdaten(result.password, result.data);
        } else if (result.type === 'password') {
          if (hasExistingVault) {
            await unlockVault(result.password);
          } else {
            await createVault(result.password);
          }
        }
        // Erfolg - der VaultApp wird automatisch MainApp rendern
      } catch (err) {
        console.error('Login-Fehler:', err);
        setError(err.message || 'Unbekannter Fehler');
        setIsProcessing(false);
        hasStartedRef.current = false;
        // Bei Fehler: Button zum erneuten Versuch anzeigen
      }
    };
    
    handleLogin();
  }, []); // Keine Dependencies - nur einmal ausfÃ¼hren
  
  const retryLogin = () => {
    hasStartedRef.current = false;
    setError('');
    setIsProcessing(true);
    
    const handleRetry = async () => {
      try {
        const result = await showVaultPasswordDialog(!hasExistingVault, !hasExistingVault);
        
        if (!result || !result.password) {
          setError('Kein Passwort eingegeben');
          setIsProcessing(false);
          return;
        }
        
        if (result.type === 'stammdaten') {
          await initializeWithStammdaten(result.password, result.data);
        } else if (result.type === 'password') {
          if (hasExistingVault) {
            await unlockVault(result.password);
          } else {
            await createVault(result.password);
          }
        }
      } catch (err) {
        console.error('Login-Fehler:', err);
        setError(err.message || 'Unbekannter Fehler');
        setIsProcessing(false);
      }
    };
    
    handleRetry();
  };
  
  return (
    <div style={{
      position: 'fixed',
      top: 0, left: 0, right: 0, bottom: 0,
      background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      flexDirection: 'column',
      color: 'white'
    }}>
      <div style={{ fontSize: '60px', marginBottom: '20px' }}>ğŸ”</div>
      <h1 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '10px' }}>
        Secure Vault
      </h1>
      <p style={{ color: '#94a3b8', fontSize: '14px' }}>
        {isProcessing ? 'Verarbeite...' : 'Warte auf Eingabe...'}
      </p>
      {error && (
        <div style={{ marginTop: '20px', textAlign: 'center' }}>
          <p style={{ color: '#ef4444', fontSize: '14px', marginBottom: '15px' }}>
            âš ï¸ {error}
          </p>
          <button 
            onClick={retryLogin}
            style={{
              background: 'linear-gradient(135deg, #0d9488 0%, #0f766e 100%)',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: '600',
              cursor: 'pointer'
            }}
          >
            ğŸ”„ Erneut versuchen
          </button>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SICHERE LÃ–SCHFUNKTION - Forensisch sichere Datenvernichtung
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Generiert Zufallsstring fÃ¼r Ãœberschreibung
const generateRandomData = (length = 100) => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let result = '';
  const randomValues = new Uint32Array(length);
  crypto.getRandomValues(randomValues);
  for (let i = 0; i < length; i++) {
    result += chars[randomValues[i] % chars.length];
  }
  return result;
};

// Ãœberschreibt ein Objekt rekursiv mit Zufallsdaten
const overwriteWithRandom = (obj) => {
  if (obj === null || obj === undefined) return null;
  if (typeof obj === 'string') return generateRandomData(obj.length || 50);
  if (typeof obj === 'number') return Math.random() * 999999999;
  if (typeof obj === 'boolean') return Math.random() > 0.5;
  if (Array.isArray(obj)) return obj.map(item => overwriteWithRandom(item));
  if (typeof obj === 'object') {
    const result = {};
    for (const key in obj) {
      result[key] = overwriteWithRandom(obj[key]);
    }
    return result;
  }
  return generateRandomData(20);
};

// Sichere LÃ¶schfunktion: Ãœberschreibt Daten mehrfach bevor sie entfernt werden
const secureDelete = async (updateState, dataPath, itemId, identifierKey = 'id') => {
  return new Promise((resolve) => {
    // Schritt 1: Daten mit Zufallswerten Ã¼berschreiben (3x), aber ID behalten
    for (let pass = 0; pass < 3; pass++) {
      updateState(prev => {
        const pathParts = dataPath.split('.');
        let current = prev;
        
        // Navigiere zum Array
        for (const part of pathParts) {
          current = current?.[part];
        }
        
        if (!Array.isArray(current)) return prev;
        
        // Finde und Ã¼berschreibe das Element (aber behalte die ID!)
        const newArray = current.map(item => {
          if (item[identifierKey] === itemId) {
            const overwritten = overwriteWithRandom(item);
            // ID zurÃ¼cksetzen damit wir es spÃ¤ter noch finden kÃ¶nnen
            overwritten[identifierKey] = itemId;
            return overwritten;
          }
          return item;
        });
        
        // Rekonstruiere den State
        const reconstructState = (obj, parts, newValue) => {
          if (parts.length === 0) return newValue;
          const [first, ...rest] = parts;
          return {
            ...obj,
            [first]: reconstructState(obj?.[first] || {}, rest, newValue)
          };
        };
        
        return reconstructState(prev, pathParts, newArray);
      });
    }
    
    // Schritt 2: Element entfernen (nach kurzem Delay fÃ¼r State-Updates)
    setTimeout(() => {
      updateState(prev => {
        const pathParts = dataPath.split('.');
        let current = prev;
        
        for (const part of pathParts) {
          current = current?.[part];
        }
        
        if (!Array.isArray(current)) return prev;
        
        // Jetzt filtern - die ID ist noch intakt
        const newArray = current.filter(item => item[identifierKey] !== itemId);
        
        const reconstructState = (obj, parts, newValue) => {
          if (parts.length === 0) return newValue;
          const [first, ...rest] = parts;
          return {
            ...obj,
            [first]: reconstructState(obj?.[first] || {}, rest, newValue)
          };
        };
        
        return reconstructState(prev, pathParts, newArray);
      });
      resolve(true);
    }, 100);
  });
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZEITERFASSUNG LOGIK & KOMPONENTEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Hilfsfunktion fÃ¼r Zeitberechnung
// Helper fÃ¼r Kalenderwochen-Vergleich (Regiebericht)
const isSameWeek = (date1, date2) => {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  const onejan = new Date(d1.getFullYear(), 0, 1);
  const week1 = Math.ceil((((d1 - onejan) / 86400000) + onejan.getDay() + 1) / 7);
  const onejan2 = new Date(d2.getFullYear(), 0, 1);
  const week2 = Math.ceil((((d2 - onejan2) / 86400000) + onejan2.getDay() + 1) / 7);
  return week1 === week2 && d1.getFullYear() === d2.getFullYear();
};

const calculateNettoHours = (von, bis, pauseSettings) => {
  if (!von || !bis) return { netto: 0, pause: false, pauseText: "" };
  
  const [vh, vm] = von.split(':').map(Number);
  const [bh, bm] = bis.split(':').map(Number);
  let minutes = (bh * 60 + bm) - (vh * 60 + vm);
  
  if (minutes <= 0) return { netto: 0, pause: false, pauseText: "" };

  let netto = minutes / 60;
  let pause = false;
  let pauseText = "";

  // Automatische Pause abziehen
  if (pauseSettings?.pauseAktiv) {
    const [psh, psm] = (pauseSettings.pauseStart || "12:00").split(':').map(Number);
    const [peh, pem] = (pauseSettings.pauseEnde || "12:30").split(':').map(Number);
    
    const startMin = vh * 60 + vm;
    const endMin = bh * 60 + bm;
    const pauseStartMin = psh * 60 + psm;
    const pauseEndMin = peh * 60 + pem;
    const pauseDauer = (pauseEndMin - pauseStartMin) / 60;

    // Wenn Arbeitszeit die Pause komplett umschlieÃŸt
    if (startMin < pauseStartMin && endMin > pauseEndMin) {
      netto -= pauseDauer;
      pause = true;
      pauseText = `(inkl. ${Math.round(pauseDauer * 60)} Min. Pause)`;
    }
  }
  
  return { netto: Math.max(0, netto), pause, pauseText };
};

// Die Hauptkomponente fÃ¼r Zeiterfassung
function TimeTrackingModule({ appState, updateState, activeProjectId, onCreateInvoice, speicherInfo }) {
  // Fallback fÃ¼r alte Vaults ohne zeiterfassung
  const zeiterfassung = appState.zeiterfassung || {
    projekte: [],
    mitarbeiter: [],
    monatsListe: [],
    einstellungen: {
      pauseStart: "12:00",
      pauseEnde: "12:30",
      pauseAktiv: true,
      stundenlohn: 50
    }
  };

  // Lokaler State fÃ¼r Formulare
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  
  // Eingabe-Zeilen (Standard 5 Zeilen)
  const [rows, setRows] = useState(
    Array(5).fill(null).map(() => ({ mitarbeiter: "", typ: "F", von: "", bis: "" }))
  );
  const [material, setMaterial] = useState("");
  
  // Regiebericht State
  const [showReportModal, setShowReportModal] = useState(false);
  const [reportPeriod, setReportPeriod] = useState('today');
  const sigPadRef = React.useRef(null);       // Auftragnehmer
  const sigCanvasRef = React.useRef(null);
  const sigPadRef2 = React.useRef(null);      // Auftraggeber
  const sigCanvasRef2 = React.useRef(null);
  
  // Unterschrift-Einstellung aus Sidebar
  const druckModus = appState.zeiterfassung?.einstellungen?.unterschriftAktiv !== false;
  
  // SignaturePad initialisieren wenn Modal geÃ¶ffnet
  React.useEffect(() => {
    if (showReportModal && window.SignaturePad) {
      // Auftragnehmer Canvas
      if (sigCanvasRef.current) {
        const canvas = sigCanvasRef.current;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        sigPadRef.current = new window.SignaturePad(canvas, {
          backgroundColor: 'rgb(248, 250, 252)',
          penColor: 'rgb(0, 0, 0)'
        });
      }
      // Auftraggeber Canvas
      if (sigCanvasRef2.current) {
        const canvas2 = sigCanvasRef2.current;
        const rect2 = canvas2.parentElement.getBoundingClientRect();
        canvas2.width = rect2.width;
        canvas2.height = rect2.height;
        sigPadRef2.current = new window.SignaturePad(canvas2, {
          backgroundColor: 'rgb(248, 250, 252)',
          penColor: 'rgb(0, 0, 0)'
        });
      }
    }
    return () => {
      if (sigPadRef.current) { sigPadRef.current.off(); sigPadRef.current = null; }
      if (sigPadRef2.current) { sigPadRef2.current.off(); sigPadRef2.current = null; }
    };
  }, [showReportModal]);

  // Helper: Zeilen hinzufÃ¼gen/entfernen
  const addRow = () => setRows([...rows, { mitarbeiter: "", typ: "F", von: "", bis: "" }]);
  const removeRow = () => rows.length > 1 && setRows(rows.slice(0, -1));

  // Helper: Zeile Ã¤ndern
  const updateRow = (index, field, value) => {
    const newRows = [...rows];
    newRows[index] = { ...newRows[index], [field]: value };
    setRows(newRows);
  };

  // Helper: Tag speichern
  const saveDay = () => {
    if (!activeProjectId) return alert("Bitte erst ein Projekt in der Sidebar auswÃ¤hlen!");
    
    // Berechnen und sÃ¤ubern
    const entries = rows
      .filter(r => r.mitarbeiter && r.von && r.bis) // Nur vollstÃ¤ndige Zeilen
      .map(r => {
        const calc = calculateNettoHours(r.von, r.bis, zeiterfassung.einstellungen);
        return { ...r, ...calc };
      });

    if (entries.length === 0 && !material) return alert("Keine Daten eingegeben.");

    const daySum = entries.reduce((sum, e) => sum + e.netto, 0);
    const aktivProjekt = (zeiterfassung.projekte || []).find(p => p.id === activeProjectId);

    // In State speichern (Deep Update)
    updateState(prev => {
      const prevZeit = prev.zeiterfassung || zeiterfassung;
      const projekte = [...(prevZeit.projekte || [])];
      const projIndex = projekte.findIndex(p => p.id === activeProjectId);
      if (projIndex === -1) return prev;

      // 1. Tag im Projekt speichern
      const projekt = { ...projekte[projIndex] };
      projekt.tage = { 
        ...projekt.tage, 
        [date]: { entries, material, daySum } 
      };
      projekte[projIndex] = projekt;

      // 2. DOPPELT: Auch in separate monatsListe speichern (fÃ¼r Monatsauswertung)
      const neueMonatsEintraege = entries.map(e => ({
        ...e,
        id: Date.now() + Math.random(),
        projektName: projekt.name,
        projektId: projekt.id,
        datum: date,
        created: new Date().toISOString()
      }));

      // WICHTIG: Alte EintrÃ¤ge fÃ¼r diesen Tag+Projekt entfernen (verhindert Duplikate!)
      const bestehendeMonatsEintraege = (prevZeit.monatsListe || []).filter(
        e => !(e.datum === date && e.projektId === activeProjectId)
      );

      // Mitarbeiter-Liste aktualisieren (falls neue Namen dabei sind)
      const alleMitarbeiter = new Set([...(prevZeit.mitarbeiter || [])]);
      entries.forEach(e => alleMitarbeiter.add(e.mitarbeiter));

      return {
        ...prev,
        zeiterfassung: {
          ...prevZeit,
          projekte: projekte,
          monatsListe: [...bestehendeMonatsEintraege, ...neueMonatsEintraege],
          mitarbeiter: Array.from(alleMitarbeiter).sort()
        }
      };
    });

    alert("âœ… Daten fÃ¼r " + date + " gespeichert!");
  };

  // Aktives Projekt finden
  const activeProject = (zeiterfassung.projekte || []).find(p => p.id === activeProjectId);

  // UI RENDER
  return (
    <div className="preview-scroll-area">
      <div className="max-w-4xl mx-auto space-y-6 pb-20 p-4 md:p-8">
      
      {/* Kein Projekt ausgewÃ¤hlt */}
      {!activeProjectId ? (
        <div className="bg-white p-12 rounded-lg shadow-xl border border-slate-200 text-center">
          <div className="text-6xl mb-4">ğŸ“</div>
          <h2 className="text-2xl font-bold text-slate-700 mb-2">Kein Projekt ausgewÃ¤hlt</h2>
          <p className="text-slate-500">WÃ¤hle ein Projekt in der Sidebar aus oder erstelle ein neues.</p>
        </div>
      ) : (
        <>
        {/* Projekt-Header mit Statistiken */}
        {(() => {
          // Berechnungen fÃ¼r das aktive Projekt
          const projektTage = activeProject?.tage || {};
          const alleTage = Object.entries(projektTage);
          
          let gesamtStundenF = 0, gesamtStundenH = 0;
          const materialListe = [];
          
          alleTage.forEach(([datum, tag]) => {
            (tag.entries || []).forEach(e => {
              if (e.typ === 'F') gesamtStundenF += (e.netto || 0);
              else gesamtStundenH += (e.netto || 0);
            });
            if (tag.material) materialListe.push({ datum, material: tag.material });
          });
          
          const gesamtStunden = gesamtStundenF + gesamtStundenH;
          const einst = zeiterfassung.einstellungen || {};
          const kostenF = gesamtStundenF * (einst.stundenlohnF || 59);
          const kostenH = gesamtStundenH * (einst.stundenlohnH || 50);
          const kostenGesamt = kostenF + kostenH;
          const kostenAktiv = einst.kostenAktiv === true;
          
          return (
            <>
            {/* Projekt-Header - Professionelles Design */}
            <div className="bg-gradient-to-r from-slate-700 to-slate-800 p-5 rounded-t-lg shadow-lg text-white">
              <div className="flex flex-wrap justify-between items-start gap-4">
                <div>
                  <div className="text-xs uppercase opacity-75 tracking-wide">Aktuelles Projekt</div>
                  <div className="text-2xl font-bold mt-1">{activeProject?.name || "Unbekannt"}</div>
                  <div className="text-sm opacity-75 mt-2">{alleTage.length} Tage erfasst</div>
                </div>
                <div className="text-right">
                  <div className="text-4xl font-bold">{gesamtStunden.toFixed(1)}<span className="text-lg ml-1">h</span></div>
                  <div className="text-xs uppercase opacity-75 tracking-wide">Gesamt</div>
                  {(gesamtStundenF > 0 || gesamtStundenH > 0) && (
                    <div className="text-sm mt-2 opacity-90">
                      {gesamtStundenF > 0 && <span className="mr-3 bg-white/20 px-2 py-0.5 rounded">F: {gesamtStundenF.toFixed(1)}h</span>}
                      {gesamtStundenH > 0 && <span className="bg-white/20 px-2 py-0.5 rounded">H: {gesamtStundenH.toFixed(1)}h</span>}
                    </div>
                  )}
                </div>
              </div>
              {/* Kosten-Zeile wenn aktiviert */}
              {kostenAktiv && gesamtStunden > 0 && (
                <div className="mt-4 pt-4 border-t border-white/30 flex flex-wrap justify-between text-sm">
                  <span className="opacity-75">GeschÃ¤tzte Kosten:</span>
                  <span className="font-bold text-lg">{kostenGesamt.toFixed(2)} â‚¬</span>
                </div>
              )}
            </div>

            {/* Material-Zusammenfassung wenn vorhanden */}
            {materialListe.length > 0 && (
              <details className="bg-white rounded-b-lg shadow-lg border border-t-0 border-slate-200 group -mt-6">
                <summary className="p-4 cursor-pointer select-none flex items-center justify-between hover:bg-slate-50">
                  <div className="flex items-center gap-2">
                    <span className="font-bold text-slate-700">Material & Bemerkungen</span>
                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full ml-2">
                      {materialListe.length} EintrÃ¤ge
                    </span>
                  </div>
                  <span className="text-slate-400 group-open:rotate-180 transition-transform">â–¼</span>
                </summary>
                <div className="p-4 pt-0 border-t border-slate-100">
                  <div className="space-y-2 mt-3">
                    {materialListe.sort((a,b) => a.datum.localeCompare(b.datum)).map((item, idx) => (
                      <div key={idx} className="flex gap-3 p-2 bg-slate-50 rounded border border-slate-200">
                        <div className="text-xs font-mono text-slate-400 whitespace-nowrap">
                          {new Date(item.datum).toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' })}
                        </div>
                        <div className="text-sm text-slate-700">{item.material}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </details>
            )}
            </>
          );
        })()}

        {/* EINGABE MASKE - Papier-Design */}
        <div className="bg-white p-6 rounded-lg shadow-lg border-t-4 border-slate-600">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-slate-800">ğŸ“… Stundenerfassung</h2>
            <input 
              type="date" 
              value={date} 
              onChange={e => setDate(e.target.value)}
              className="p-2 border rounded font-mono bg-slate-50" 
            />
          </div>

          <div className="space-y-2">
            <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500 uppercase mb-2">
              <div className="col-span-5 md:col-span-4">Mitarbeiter</div>
              <div className="col-span-2 md:col-span-1 text-center">Typ</div>
              <div className="col-span-5 md:col-span-4 text-center">Zeit (Von - Bis)</div>
              <div className="hidden md:block md:col-span-3 text-right">Berechnung</div>
            </div>

            {rows.map((row, i) => {
              const calc = calculateNettoHours(row.von, row.bis, zeiterfassung.einstellungen);
              return (
                <div key={i} className="grid grid-cols-12 gap-2 items-center p-2 hover:bg-slate-50 rounded transition-colors">
                  {/* Name Input mit Datalist fÃ¼r VorschlÃ¤ge */}
                  <div className="col-span-5 md:col-span-4">
                    <input 
                      list="mitarbeiter-liste"
                      type="text" 
                      placeholder={`Mitarbeiter ${i+1}`}
                      className="w-full p-2 border rounded text-sm font-medium"
                      value={row.mitarbeiter}
                      onChange={e => updateRow(i, 'mitarbeiter', e.target.value)}
                    />
                  </div>
                  
                  {/* Typ (F/H) */}
                  <div className="col-span-2 md:col-span-1">
                    <select 
                      className="w-full p-2 border rounded text-center text-sm bg-white"
                      value={row.typ}
                      onChange={e => updateRow(i, 'typ', e.target.value)}
                    >
                      <option value="F">F</option>
                      <option value="H">H</option>
                    </select>
                  </div>

                  {/* Zeiten */}
                  <div className="col-span-5 md:col-span-4 flex gap-1">
                    <input type="time" step="900" className="w-1/2 p-2 border rounded text-sm text-center" value={row.von} onChange={e => updateRow(i, 'von', e.target.value)} />
                    <input type="time" step="900" className="w-1/2 p-2 border rounded text-sm text-center" value={row.bis} onChange={e => updateRow(i, 'bis', e.target.value)} />
                  </div>

                  {/* Live Berechnung (Nur Desktop sichtbar) */}
                  <div className="hidden md:block md:col-span-3 text-right text-sm">
                    {calc.netto > 0 ? (
                      <span className="text-emerald-600 font-bold">
                        {calc.netto.toFixed(2)} h <span className="text-xs font-normal text-slate-400">{calc.pauseText}</span>
                      </span>
                    ) : (
                      <span className="text-slate-300">â€“</span>
                    )}
                  </div>
                </div>
              );
            })}
            
            <datalist id="mitarbeiter-liste">
              {zeiterfassung.mitarbeiter.map(m => <option key={m} value={m} />)}
            </datalist>
          </div>

          <div className="flex gap-2 mt-4">
            <button onClick={addRow} className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-2 rounded">+ Zeile</button>
            <button onClick={removeRow} className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-2 rounded">- Zeile</button>
          </div>

          {/* Material / Bemerkungen mit Suchfeld */}
          <div className="mt-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">ğŸ§° Material / Bemerkungen</label>
            
            {/* Material-Suche mit Menge und Einheit */}
            <div className="flex gap-2 mb-3">
              <div className="w-16">
                <input 
                  type="number"
                  id="material-menge-input"
                  min="1"
                  defaultValue="1"
                  className="w-full p-2 border border-slate-300 rounded text-sm text-center"
                  placeholder="Menge"
                />
              </div>
              <div className="flex-1 relative">
                <input 
                  type="text"
                  id="material-suche-input"
                  list="material-vorschlaege"
                  placeholder="Material suchen..."
                  className="w-full p-2 border border-slate-300 rounded text-sm"
                  onKeyDown={e => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      const val = e.target.value.trim();
                      const menge = document.getElementById('material-menge-input').value || '1';
                      if (val) {
                        const matchedMat = appState.material?.find(m => m.Name.toLowerCase() === val.toLowerCase());
                        const einheit = matchedMat?.Einheit || '';
                        const eintrag = einheit ? `${menge} ${einheit} ${val}` : `${menge}x ${val}`;
                        setMaterial(prev => prev ? prev + ', ' + eintrag : eintrag);
                        e.target.value = '';
                        document.getElementById('material-menge-input').value = '1';
                      }
                    }
                  }}
                />
                <datalist id="material-vorschlaege">
                  {(appState.material || []).map((m, i) => (
                    <option key={i} value={m.Name}>{m.Einheit}</option>
                  ))}
                </datalist>
              </div>
              <button
                type="button"
                onClick={() => {
                  const input = document.getElementById('material-suche-input');
                  const val = input.value.trim();
                  const menge = document.getElementById('material-menge-input').value || '1';
                  if (val) {
                    const matchedMat = appState.material?.find(m => m.Name.toLowerCase() === val.toLowerCase());
                    const einheit = matchedMat?.Einheit || '';
                    const eintrag = einheit ? `${menge} ${einheit} ${val}` : `${menge}x ${val}`;
                    setMaterial(prev => prev ? prev + ', ' + eintrag : eintrag);
                    input.value = '';
                    document.getElementById('material-menge-input').value = '1';
                  }
                }}
                className="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-3 rounded text-sm"
              >
                +
              </button>
            </div>
            <div className="text-xs text-slate-400 mb-3">Menge eingeben, Material wÃ¤hlen, Enter oder + klicken</div>

            {/* Material-Liste mit Einheiten als Buttons */}
            {(appState.material || []).length > 0 && (
              <div className="bg-white border border-slate-200 rounded p-2 mb-3 max-h-32 overflow-y-auto">
                <div className="text-xs text-slate-400 mb-2">Schnellauswahl (Klick = hinzufÃ¼gen mit Menge oben):</div>
                <div className="flex flex-wrap gap-1">
                  {(appState.material || []).map((m, i) => (
                    <button
                      key={i}
                      type="button"
                      onClick={() => {
                        const menge = document.getElementById('material-menge-input').value || '1';
                        const eintrag = `${menge} ${m.Einheit} ${m.Name}`;
                        setMaterial(prev => prev ? prev + ', ' + eintrag : eintrag);
                      }}
                      className="text-xs bg-slate-50 border border-slate-300 hover:border-emerald-500 hover:bg-emerald-50 text-slate-700 px-2 py-1 rounded transition-colors"
                      title={`${m.Verkaufspreis} â‚¬ pro ${m.Einheit}`}
                    >
                      {m.Name} <span className="text-slate-400">({m.Einheit})</span>
                    </button>
                  ))}
                </div>
              </div>
            )}
            
            {/* Textarea fÃ¼r Freitext und Bemerkungen */}
            <textarea 
              className="w-full p-3 border border-slate-300 rounded text-sm h-20" 
              placeholder="AusgewÃ¤hltes Material und Bemerkungen (Wetter, besondere Vorkommnisse...)"
              value={material}
              onChange={e => setMaterial(e.target.value)}
            ></textarea>

            {/* Neues Material anlegen */}
            <details className="mt-3 group">
              <summary className="text-xs text-slate-500 cursor-pointer hover:text-emerald-600">
                â• Neues Material zur Positionsliste hinzufÃ¼gen...
              </summary>
              <div className="mt-2 p-3 bg-white border border-slate-200 rounded space-y-2">
                <input 
                  type="text" 
                  id="neues-material-name"
                  placeholder="Materialname (z.B. Bagger, Zement)"
                  className="w-full p-2 border border-slate-300 rounded text-sm"
                />
                <div className="flex gap-2">
                  <input 
                    type="text" 
                    id="neues-material-preis"
                    placeholder="Preis (â‚¬)"
                    className="w-1/2 p-2 border border-slate-300 rounded text-sm"
                  />
                  <input 
                    type="text" 
                    id="neues-material-einheit"
                    placeholder="Einheit (Stk, mÂ², h)"
                    defaultValue="Stk"
                    className="w-1/2 p-2 border border-slate-300 rounded text-sm"
                  />
                </div>
                <button
                  type="button"
                  onClick={() => {
                    const name = document.getElementById('neues-material-name').value.trim();
                    const preis = document.getElementById('neues-material-preis').value.trim() || '0,00';
                    const einheit = document.getElementById('neues-material-einheit').value.trim() || 'Stk';
                    
                    if (!name) {
                      alert('Bitte einen Materialnamen eingeben.');
                      return;
                    }
                    
                    // Zur Rechnungs-Positionsliste hinzufÃ¼gen
                    updateState(prev => ({
                      ...prev,
                      material: [
                        ...(prev.material || []),
                        { id: Date.now(), Name: name, Verkaufspreis: preis, Einheit: einheit }
                      ]
                    }));
                    
                    // Auch gleich zum aktuellen Material-Feld hinzufÃ¼gen
                    setMaterial(prev => prev ? prev + ', ' + name : name);
                    
                    // Felder leeren
                    document.getElementById('neues-material-name').value = '';
                    document.getElementById('neues-material-preis').value = '';
                    document.getElementById('neues-material-einheit').value = 'Stk';
                    
                    alert(`"${name}" wurde zur Positionsliste hinzugefÃ¼gt!`);
                  }}
                  className="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 rounded text-sm"
                >
                  Material speichern
                </button>
              </div>
            </details>
          </div>

          <div className="mt-6 flex justify-end">
            <button 
              onClick={saveDay}
              className="bg-slate-700 hover:bg-slate-800 text-white text-base font-semibold px-8 py-3 rounded shadow-md transition"
            >
              Speichern
            </button>
          </div>

        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* PROJEKT-VORSCHAU TABELLE - HAUPTBEREICH */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        
        <div className="bg-white rounded-lg shadow-lg border border-slate-200 overflow-hidden">
          <div className="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-4 font-bold flex items-center justify-between">
            <div className="flex items-center gap-3 text-base">
              <span className="uppercase tracking-wider font-semibold">Projekt-Vorschau:</span>
              <span className="bg-white/20 px-3 py-1 rounded font-medium">{activeProject?.name}</span>
            </div>
            <div className="text-sm font-medium bg-white/20 px-4 py-2 rounded">
              {Object.keys(activeProject?.tage || {}).length} Tage â€¢ {Object.values(activeProject?.tage || {}).reduce((sum, t) => sum + (t.daySum || 0), 0).toFixed(1)} h
            </div>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              {(() => {
                // PrÃ¼fe ob es verschiedene Typen (F und H) im Projekt gibt
                const alleTage = Object.values(activeProject?.tage || {});
                const alleTypen = new Set();
                alleTage.forEach(tag => {
                  (tag.entries || []).forEach(e => alleTypen.add(e.typ));
                });
                const zeigeTypSpalte = alleTypen.size > 1; // Nur wenn F UND H vorhanden
                
                return (
                  <>
                    <thead className="bg-slate-50 text-slate-600 font-bold border-b">
                      <tr>
                        <th className="p-4 text-left">Wochentag + Datum</th>
                        <th className="p-4 text-left">Mitarbeiter</th>
                        {zeigeTypSpalte && <th className="p-4 text-center">Typ</th>}
                        <th className="p-4 text-center">Uhrzeit</th>
                        <th className="p-4 text-right">Gesamt (h)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const tage = Object.entries(activeProject?.tage || {}).sort((a, b) => a[0].localeCompare(b[0]));
                        
                        if (tage.length === 0) {
                          return (
                            <tr>
                              <td colSpan={zeigeTypSpalte ? 5 : 4} className="p-8 text-center text-slate-400">
                                Noch keine Stunden erfasst. FÃ¼lle die Eingabemaske oben aus und klicke "Speichern".
                              </td>
                            </tr>
                          );
                        }
                        
                        const rows = [];
                        tage.forEach(([datum, tagData]) => {
                          const entries = tagData.entries || [];
                          const datumObj = new Date(datum);
                          const wochentag = datumObj.toLocaleDateString('de-DE', { weekday: 'long' });
                          const datumFormatiert = datumObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                          
                          if (entries.length === 0) {
                            // Tag nur mit Material
                            rows.push(
                              <tr key={datum} className="border-b hover:bg-slate-50">
                                <td className="p-4 font-medium text-slate-800">{wochentag}, {datumFormatiert}</td>
                                <td className="p-4 text-slate-400 italic" colSpan={zeigeTypSpalte ? 3 : 2}>
                                  {tagData.material ? `Material: ${tagData.material}` : 'â€“'}
                                </td>
                                <td className="p-4 text-right font-bold text-slate-400">0.00</td>
                              </tr>
                            );
                          } else {
                            entries.forEach((entry, idx) => {
                              rows.push(
                                <tr key={`${datum}-${idx}`} className="border-b hover:bg-slate-50">
                                  {idx === 0 ? (
                                    <td className="p-4 font-medium text-slate-800" rowSpan={entries.length}>
                                      {wochentag}, {datumFormatiert}
                                    </td>
                                  ) : null}
                                  <td className="p-4 text-slate-700">{entry.mitarbeiter}</td>
                                  {zeigeTypSpalte && (
                                    <td className="p-4 text-center">
                                      <span className={`px-2 py-0.5 rounded text-xs font-semibold ${entry.typ === 'F' ? 'bg-slate-200 text-slate-700' : 'bg-slate-100 text-slate-600'}`}>
                                        {entry.typ}
                                      </span>
                                    </td>
                                  )}
                                  <td className="p-4 text-center font-mono text-slate-600">
                                    {entry.von} â€“ {entry.bis}
                                    {entry.pauseText && <span className="text-xs text-slate-400 ml-1">({entry.pauseText})</span>}
                                  </td>
                                  <td className="p-4 text-right font-bold text-slate-700">{(entry.netto || 0).toFixed(2)}</td>
                                </tr>
                              );
                            });
                          }
                          
                          // Material-Zeile (separat, wenn vorhanden)
                          if (tagData.material) {
                            rows.push(
                              <tr key={`${datum}-material`} className="bg-slate-50 border-b">
                                <td colSpan={zeigeTypSpalte ? 5 : 4} className="p-3 pl-4 text-sm text-slate-700">
                                  <span className="font-medium text-slate-600">Material/Bemerkung:</span> {tagData.material}
                                </td>
                              </tr>
                            );
                          }
                          
                          // Tagessumme-Zeile
                          if (entries.length > 0) {
                            rows.push(
                              <tr key={`${datum}-sum`} className="bg-slate-100 border-b-2 border-slate-300">
                                <td colSpan={zeigeTypSpalte ? 4 : 3} className="p-3 text-right text-xs font-bold text-slate-600 uppercase">
                                  Summe {wochentag}
                                </td>
                                <td className="p-3 text-right font-bold text-slate-700">{(tagData.daySum || 0).toFixed(2)} h</td>
                              </tr>
                            );
                          }
                        });
                        
                        return rows;
                      })()}
                    </tbody>
                  </>
                );
              })()}
              {Object.keys(activeProject?.tage || {}).length > 0 && (() => {
                const projektTage = activeProject?.tage || {};
                const gesamtStunden = Object.values(projektTage).reduce((sum, t) => sum + (t.daySum || 0), 0);
                const einst = zeiterfassung.einstellungen || {};
                const kostenAktiv = einst.kostenAktiv === true;
                
                // Berechne Kosten nach Typ
                let stundenF = 0, stundenH = 0;
                Object.values(projektTage).forEach(tag => {
                  (tag.entries || []).forEach(e => {
                    if (e.typ === 'F') stundenF += (e.netto || 0);
                    else stundenH += (e.netto || 0);
                  });
                });
                const gesamtKosten = (stundenF * (einst.stundenlohnF || 59)) + (stundenH * (einst.stundenlohnH || 50));
                
                return (
                  <tfoot className="bg-gradient-to-r from-slate-700 to-slate-800 text-white font-bold">
                    <tr>
                      <td colSpan="3" className="p-4 text-right uppercase tracking-wide">Projekt-Gesamt</td>
                      <td className="p-4 text-right text-xl">
                        {gesamtStunden.toFixed(2)} h
                      </td>
                      {kostenAktiv && (
                        <td className="p-4 text-right">
                          <span className="text-xl text-emerald-300">{gesamtKosten.toFixed(2)} â‚¬</span>
                          <span className="text-xs text-slate-400 block">+ MwSt. und Material</span>
                        </td>
                      )}
                    </tr>
                  </tfoot>
                );
              })()}
            </table>
          </div>
          
          {/* â•â•â• GESAMTÃœBERSICHT FÃœR RECHNUNG â•â•â• */}
          {Object.keys(activeProject?.tage || {}).length > 0 && (() => {
            // Berechne Gesamtstunden F/H
            const projektTage = activeProject?.tage || {};
            let stundenF = 0, stundenH = 0;
            const allesMaterial = [];
            
            Object.entries(projektTage).forEach(([datum, tag]) => {
              (tag.entries || []).forEach(e => {
                if (e.typ === 'F') stundenF += (e.netto || 0);
                else stundenH += (e.netto || 0);
              });
              if (tag.material) {
                allesMaterial.push(tag.material);
              }
            });
            
            const gesamtStunden = stundenF + stundenH;
            const einst = zeiterfassung.einstellungen || {};
            
            // Material zusammenfassen (alle EintrÃ¤ge kombinieren)
            const gesamtMaterialText = allesMaterial.join(', ');
            
            return (
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 mt-4">
                <h4 className="font-bold text-slate-700 mb-3">
                  Zusammenfassung fÃ¼r Rechnung
                </h4>
                
                {/* Stunden-Ãœbersicht */}
                <div className="bg-white rounded p-3 mb-3 border border-slate-200">
                  <div className="text-sm font-bold text-slate-600 mb-2">Arbeitsstunden:</div>
                  <div className="grid grid-cols-3 gap-2 text-sm">
                    {stundenF > 0 && (
                      <div className="bg-blue-50 p-2 rounded border border-blue-200">
                        <div className="text-xs text-blue-600 font-bold">Facharbeiter (F)</div>
                        <div className="text-lg font-bold text-blue-700">{stundenF.toFixed(2)} h</div>
                        <div className="text-xs text-blue-500">{einst.stundenlohnF || 59} â‚¬/h</div>
                      </div>
                    )}
                    {stundenH > 0 && (
                      <div className="bg-emerald-50 p-2 rounded border border-emerald-200">
                        <div className="text-xs text-emerald-600 font-bold">Helfer (H)</div>
                        <div className="text-lg font-bold text-emerald-700">{stundenH.toFixed(2)} h</div>
                        <div className="text-xs text-emerald-500">{einst.stundenlohnH || 50} â‚¬/h</div>
                      </div>
                    )}
                    <div className="bg-orange-50 p-2 rounded border border-orange-200">
                      <div className="text-xs text-orange-600 font-bold">Gesamt</div>
                      <div className="text-lg font-bold text-orange-700">{gesamtStunden.toFixed(2)} h</div>
                    </div>
                  </div>
                </div>
                
                {/* Material-Ãœbersicht */}
                {allesMaterial.length > 0 && (
                  <div className="bg-white rounded p-3 mb-3 border border-slate-200">
                    <div className="text-sm font-bold text-slate-600 mb-2">Gesamtmaterial:</div>
                    <div className="text-sm text-slate-700 bg-slate-50 p-2 rounded max-h-32 overflow-y-auto">
                      {gesamtMaterialText}
                    </div>
                  </div>
                )}
                
                {/* Button: In Rechnung Ã¼bernehmen */}
                <button
                  onClick={() => {
                    try {
                      // Positionen fÃ¼r die Rechnung erstellen
                      const neuePositionen = [];
                      
                      // PrÃ¼fe ob beide Typen (F und H) vorhanden sind
                      const beidTypenVorhanden = stundenF > 0 && stundenH > 0;
                      
                      // Facharbeiter-Stunden als Position
                      if (stundenF > 0) {
                        neuePositionen.push({
                          id: Date.now() + Math.random(),
                          name: beidTypenVorhanden 
                            ? `Facharbeiter-Stunden (Projekt: ${activeProject?.name || 'Unbekannt'})`
                            : `Arbeitsstunden (Projekt: ${activeProject?.name || 'Unbekannt'})`,
                          einheit: 'h',
                          menge: stundenF.toFixed(2),
                          preis: String(einst.stundenlohnF || 59).replace('.', ',')
                        });
                      }
                      
                      // Helfer-Stunden als Position
                      if (stundenH > 0) {
                        neuePositionen.push({
                          id: Date.now() + Math.random() + 1,
                          name: beidTypenVorhanden
                            ? `Helfer-Stunden (Projekt: ${activeProject?.name || 'Unbekannt'})`
                            : `Arbeitsstunden (Projekt: ${activeProject?.name || 'Unbekannt'})`,
                          einheit: 'h',
                          menge: stundenH.toFixed(2),
                          preis: String(einst.stundenlohnH || 50).replace('.', ',')
                        });
                      }
                      
                      // Material als Positionen parsen und hinzufÃ¼gen
                      if (gesamtMaterialText) {
                        const materialItems = gesamtMaterialText.split(',').map(s => s.trim()).filter(s => s);
                        materialItems.forEach((item, idx) => {
                          const match = item.match(/^(\d+(?:[.,]\d+)?)\s*(\S+)\s+(.+)$/);
                          if (match) {
                            const [, menge, einheit, matName] = match;
                            const gefundenesMat = (appState.material || []).find(m => 
                              m.Name.toLowerCase() === matName.toLowerCase()
                            );
                            neuePositionen.push({
                              id: Date.now() + Math.random() + idx + 10,
                              name: matName,
                              einheit: einheit,
                              menge: String(menge).replace(',', '.'),
                              preis: gefundenesMat ? gefundenesMat.Verkaufspreis : '0,00'
                            });
                          } else {
                            neuePositionen.push({
                              id: Date.now() + Math.random() + idx + 100,
                              name: item,
                              einheit: 'Stk',
                              menge: '1',
                              preis: '0,00'
                            });
                          }
                        });
                      }
                      
                      // Leistungszeitraum berechnen
                      const sortedDates = Object.keys(projektTage).sort();
                      const vonDatum = sortedDates[0] ? new Date(sortedDates[0]).toLocaleDateString('de-DE') : '';
                      const bisDatum = sortedDates.length > 0 ? new Date(sortedDates[sortedDates.length - 1]).toLocaleDateString('de-DE') : '';
                      
                      // Callback aufrufen
                      onCreateInvoice({
                        betreff: `Abrechnung Projekt: ${activeProject?.name || 'Unbekannt'}`,
                        positionen: neuePositionen,
                        leistungszeitraum: { von: vonDatum, bis: bisDatum }
                      });
                    } catch (err) {
                      console.error('Fehler beim Erstellen der Rechnung:', err);
                      alert('Fehler: ' + err.message);
                    }
                  }}
                  className="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg"
                >
                  <span>ğŸ“„</span> In neue Rechnung Ã¼bernehmen
                </button>
                <div className="text-xs text-teal-600 text-center mt-2">
                  Erstellt einen neuen Entwurf mit Arbeitsstunden und Material
                </div>
                
                {/* Regiebericht Button */}
                <button
                  onClick={() => setShowReportModal(true)}
                  className="w-full mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg"
                >
                  <span>âœï¸</span> Regiebericht mit Unterschrift
                </button>
                <div className="text-xs text-slate-500 text-center mt-2">
                  PDF mit Auftragnehmer- und Auftraggeber-Unterschrift
                </div>
              </div>
            );
          })()}
        </div>
        </>
      )}

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* REGIEBERICHT MODAL */}
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {showReportModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style={{animation: 'fadeIn 0.2s ease'}}>
          <div className="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
              <span>âœï¸</span> Regiebericht erstellen
            </h3>
            <p className="text-sm text-slate-500 mb-4">
              Projekt: <strong>{activeProject?.name}</strong>
            </p>
            
            {/* Zeitraum Wahl mit Stunden-Info */}
            {(() => {
              // Berechne Stunden fÃ¼r alle ZeitrÃ¤ume
              const today = new Date();
              const stundenInfo = { today: { facharbeiter: 0, helfer: 0 }, week: { facharbeiter: 0, helfer: 0 }, all: { facharbeiter: 0, helfer: 0 } };
              
              Object.entries(activeProject?.tage || {}).forEach(([datumStr, data]) => {
                const entryDate = new Date(datumStr);
                const isToday = entryDate.toDateString() === today.toDateString();
                const isThisWeek = isSameWeek(entryDate, today);
                
                // Verwende data.entries statt data.mitarbeiter
                (data.entries || []).forEach(entry => {
                  const stunden = parseFloat(entry.netto) || 0;
                  const typ = entry.typ || 'Facharbeiter';
                  const key = (typ === 'Helfer' || typ === 'H') ? 'helfer' : 'facharbeiter';
                  
                  stundenInfo.all[key] += stunden;
                  if (isThisWeek) stundenInfo.week[key] += stunden;
                  if (isToday) stundenInfo.today[key] += stunden;
                });
              });
              
              const formatStunden = (info) => {
                const parts = [];
                if (info.facharbeiter > 0) parts.push(`${info.facharbeiter.toLocaleString('de-DE', {minimumFractionDigits: 1})} Std. Facharbeiter`);
                if (info.helfer > 0) parts.push(`${info.helfer.toLocaleString('de-DE', {minimumFractionDigits: 1})} Std. Helfer`);
                return parts.length > 0 ? parts : ['Keine Stunden'];
              };
              
              return (
                <div className="mb-4">
                  <div className="flex gap-2 bg-slate-100 p-1 rounded-lg mb-3">
                    {[
                      { key: 'today', label: 'Heute' },
                      { key: 'week', label: 'Diese Woche' },
                      { key: 'all', label: 'Alles' }
                    ].map(p => (
                      <button 
                        key={p.key} 
                        onClick={() => setReportPeriod(p.key)} 
                        className={`flex-1 py-2 text-sm font-bold rounded transition-colors ${reportPeriod === p.key ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                      >
                        {p.label}
                      </button>
                    ))}
                  </div>
                  {/* Stunden-Info fÃ¼r gewÃ¤hlten Zeitraum - GROSS fÃ¼r Kunde */}
                  <div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
                    <p className="text-xs text-blue-600 font-medium mb-2">
                      {reportPeriod === 'today' ? 'ğŸ“… Heute' : reportPeriod === 'week' ? 'ğŸ“… Diese Woche' : 'ğŸ“… Gesamt'}
                    </p>
                    <div className="space-y-1">
                      {formatStunden(stundenInfo[reportPeriod]).map((line, i) => (
                        <p key={i} className="text-xl font-bold text-slate-800">ğŸ•’ {line}</p>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* Info: Modus wird Ã¼ber Sidebar gesteuert */}
            {druckModus ? (
              <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <p className="text-sm font-bold text-amber-800">ğŸ–¨ï¸ Druckmodus aktiv</p>
                <p className="text-xs text-amber-600">PDF mit leeren Unterschriftfeldern ("Ort, Datum"). Ã„nderbar in Sidebar â†’ Unterschriftsfelder im PDF</p>
              </div>
            ) : (
              <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="text-sm font-bold text-blue-800">âœï¸ Digitale Signatur aktiv</p>
                <p className="text-xs text-blue-600">Mit GPS-Koordinaten und Zeitstempel. Ã„nderbar in Sidebar â†’ Unterschriftsfelder im PDF</p>
              </div>
            )}

            {/* Unterschriftsfelder nur wenn NICHT Druckmodus */}
            {!druckModus && (
              <>
                {/* 1. Unterschrift AUFTRAGNEHMER */}
                <div className="mb-4">
                  <p className="text-sm font-bold text-slate-700 mb-2">1. Auftragnehmer unterschreibt:</p>
                  <div className="border-2 border-slate-200 rounded-lg bg-slate-50 relative" style={{height: '150px'}}>
                    <canvas 
                      ref={sigCanvasRef}
                      className="w-full h-full cursor-crosshair rounded-lg"
                      style={{touchAction: 'none'}}
                    />
                    <button 
                      onClick={() => { if (sigPadRef.current) sigPadRef.current.clear(); }} 
                      className="absolute bottom-2 right-2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow border hover:bg-red-50"
                    >
                      LÃ¶schen
                    </button>
                  </div>
                </div>

                {/* 2. Unterschrift AUFTRAGGEBER */}
                <div className="mb-4">
                  <p className="text-sm font-bold text-slate-700 mb-2">2. Auftraggeber unterschreibt:</p>
                  <div className="border-2 border-blue-200 rounded-lg bg-blue-50 relative" style={{height: '150px'}}>
                    <canvas 
                      ref={sigCanvasRef2}
                      className="w-full h-full cursor-crosshair rounded-lg"
                      style={{touchAction: 'none'}}
                    />
                    <button 
                      onClick={() => { if (sigPadRef2.current) sigPadRef2.current.clear(); }} 
                      className="absolute bottom-2 right-2 text-xs text-red-500 bg-white px-2 py-1 rounded shadow border hover:bg-red-50"
                    >
                      LÃ¶schen
                    </button>
                  </div>
                </div>
              </>
            )}

            {/* Hinweis bei Druckmodus */}
            {druckModus && (
              <div className="mb-4 p-4 bg-slate-100 rounded-lg text-center">
                <span className="text-4xl">ğŸ–¨ï¸</span>
                <p className="text-sm text-slate-600 mt-2">PDF wird mit leeren Unterschriftfeldern erstellt.</p>
                <p className="text-xs text-slate-500">Bitte nach dem Drucken hÃ¤ndisch mit Ort und Datum unterschreiben.</p>
              </div>
            )}

            <div className="flex gap-3">
              <button 
                onClick={() => setShowReportModal(false)} 
                className="flex-1 py-3 text-slate-600 font-bold bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"
              >
                Abbrechen
              </button>
              <button 
                onClick={async () => {
                  // Validierung - nur bei digitalem Modus prÃ¼fen
                  if (!druckModus) {
                    if (!sigPadRef.current || sigPadRef.current.isEmpty()) {
                      alert("Bitte erst als Auftragnehmer unterschreiben!");
                      return;
                    }
                    if (!sigPadRef2.current || sigPadRef2.current.isEmpty()) {
                      alert("Bitte erst als Auftraggeber unterschreiben!");
                      return;
                    }
                  }

                  const fd = appState.firmenDaten || {};
                  const today = new Date();

                  // 1. Filtern und Datumsbereich ermitteln
                  let filteredRows = [];
                  let totalStunden = 0;
                  let minDate = null;
                  let maxDate = null;

                  Object.entries(activeProject?.tage || {}).forEach(([datumStr, data]) => {
                    const entryDate = new Date(datumStr);
                    let include = false;
                    if (reportPeriod === 'all') include = true;
                    if (reportPeriod === 'today') include = entryDate.toDateString() === today.toDateString();
                    if (reportPeriod === 'week') include = isSameWeek(entryDate, today);

                    if (include) {
                      // Datumsbereich tracken
                      if (!minDate || entryDate < minDate) minDate = entryDate;
                      if (!maxDate || entryDate > maxDate) maxDate = entryDate;
                      
                      (data.entries || []).forEach(entry => {
                        if (parseFloat(entry.netto) > 0) {
                          // Typ konvertieren: F -> Facharbeiter, H -> Helfer
                          let typDisplay = entry.typ || '-';
                          if (typDisplay === 'F') typDisplay = 'Facharbeiter';
                          if (typDisplay === 'H') typDisplay = 'Helfer';
                          
                          filteredRows.push([
                            new Date(datumStr).toLocaleDateString('de-DE'),
                            entry.mitarbeiter || '-',
                            typDisplay,
                            parseFloat(entry.netto).toLocaleString('de-DE', {minimumFractionDigits: 2}) + ' h'
                          ]);
                          totalStunden += parseFloat(entry.netto);
                        }
                      });
                    }
                  });

                  if (filteredRows.length === 0) { 
                    alert("Keine Stunden im gewÃ¤hlten Zeitraum."); 
                    return; 
                  }

                  // GPS-Position abrufen (nur bei digitalem Modus)
                  let gpsText = "";
                  if (!druckModus) {
                    try {
                      const position = await new Promise((resolve, reject) => {
                        if (navigator.geolocation) {
                          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        } else {
                          reject(new Error("Geolocation nicht unterstÃ¼tzt"));
                        }
                      });
                      const lat = position.coords.latitude.toFixed(6);
                      const lon = position.coords.longitude.toFixed(6);
                      const acc = position.coords.accuracy.toFixed(0);
                      gpsText = `GPS: ${lat}, ${lon} (Â±${acc}m)`;
                    } catch (e) {
                      gpsText = "GPS: Nicht verfÃ¼gbar";
                      console.log("GPS nicht verfÃ¼gbar:", e.message);
                    }
                  }

                  // PrÃ¤ziser Zeitstempel (forensisch)
                  const zeitstempel = new Date().toISOString();
                  const zeitstempelDE = new Date().toLocaleString('de-DE', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                  });

                  // 2. PDF Bauen - Professioneller Briefkopf
                  const doc = new jspdf.jsPDF();
                  
                  // === FIRMENBRIEFKOPF (oben rechts) ===
                  doc.setFontSize(12);
                  doc.setFont(undefined, 'bold');
                  doc.text(fd.firmenname || "Meine Firma", 195, 20, { align: 'right' });
                  doc.setFontSize(9);
                  doc.setFont(undefined, 'normal');
                  let briefkopfY = 26;
                  if (fd.strasse) { doc.text(fd.strasse, 195, briefkopfY, { align: 'right' }); briefkopfY += 4; }
                  if (fd.plz || fd.ort) { doc.text(`${fd.plz || ''} ${fd.ort || ''}`, 195, briefkopfY, { align: 'right' }); briefkopfY += 4; }
                  if (fd.telefon) { doc.text(`Tel: ${fd.telefon}`, 195, briefkopfY, { align: 'right' }); briefkopfY += 4; }
                  if (fd.email) { doc.text(fd.email, 195, briefkopfY, { align: 'right' }); briefkopfY += 4; }
                  
                  // === AUFTRAGGEBER (oben links) ===
                  doc.setFontSize(8);
                  doc.setTextColor(100);
                  doc.text("Auftraggeber:", 20, 20);
                  doc.setFontSize(11);
                  doc.setTextColor(0);
                  doc.setFont(undefined, 'bold');
                  doc.text(activeProject?.name || "Unbekannt", 20, 26);
                  doc.setFont(undefined, 'normal');
                  
                  // === PROJEKTINFO ===
                  doc.setFontSize(9);
                  doc.setTextColor(100);
                  let infoY = 34;
                  
                  // Echten Zeitraum berechnen
                  let zeitraumText = '';
                  if (minDate && maxDate) {
                    const minStr = minDate.toLocaleDateString('de-DE');
                    const maxStr = maxDate.toLocaleDateString('de-DE');
                    zeitraumText = minStr === maxStr ? minStr : `${minStr} - ${maxStr}`;
                  } else {
                    zeitraumText = today.toLocaleDateString('de-DE');
                  }
                  
                  doc.text(`Zeitraum: ${zeitraumText}`, 20, infoY);
                  doc.text(`Erstellt: ${zeitstempelDE}`, 20, infoY + 5);
                  
                  // === TRENNLINIE ===
                  doc.setDrawColor(200);
                  doc.line(20, 48, 190, 48);
                  
                  // === GROSSE ÃœBERSCHRIFT ===
                  doc.setTextColor(0);
                  doc.setFontSize(22);
                  doc.setFont(undefined, 'bold');
                  doc.text("REGIEBERICHT", 105, 60, { align: 'center' });
                  doc.setFont(undefined, 'normal');

                  // === STUNDEN-TABELLE ===
                  doc.autoTable({
                    startY: 70,
                    head: [['Datum', 'Mitarbeiter', 'Typ', 'Stunden']],
                    body: filteredRows,
                    foot: [['', '', 'Summe:', totalStunden.toLocaleString('de-DE', {minimumFractionDigits: 2}) + ' Std.']],
                    headStyles: { fillColor: [71, 85, 105], fontSize: 10 },
                    bodyStyles: { fontSize: 9 },
                    footStyles: { fillColor: [241, 245, 249], textColor: [0, 0, 0], fontStyle: 'bold' },
                    margin: { left: 20, right: 20 }
                  });

                  // === UNTERSCHRIFTEN ===
                  let yPos = doc.lastAutoTable.finalY + 20;
                  
                  // PrÃ¼fen ob neue Seite nÃ¶tig
                  if (yPos > 220) {
                    doc.addPage();
                    yPos = 30;
                  }
                  
                  doc.setFontSize(10);
                  doc.setFont(undefined, 'bold');
                  doc.text("BestÃ¤tigung der ordnungsgemÃ¤ÃŸen AusfÃ¼hrung:", 20, yPos);
                  doc.setFont(undefined, 'normal');
                  
                  if (druckModus) {
                    // === DRUCKMODUS: Leere Unterschriftfelder mit "Ort, Datum" ===
                    // Auftragnehmer (links)
                    doc.setDrawColor(180);
                    doc.rect(20, yPos + 5, 70, 30); // Leeres Rechteck
                    doc.line(20, yPos + 35, 90, yPos + 35);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text("Auftragnehmer", 20, yPos + 42);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    doc.setTextColor(120);
                    doc.text("Ort, Datum: _______________________", 20, yPos + 48);
                    
                    // Auftraggeber (rechts)
                    doc.setTextColor(0);
                    doc.setDrawColor(180);
                    doc.rect(110, yPos + 5, 70, 30); // Leeres Rechteck
                    doc.line(110, yPos + 35, 180, yPos + 35);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text("Auftraggeber", 110, yPos + 42);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    doc.setTextColor(120);
                    doc.text("Ort, Datum: _______________________", 110, yPos + 48);
                  } else {
                    // === DIGITALER MODUS: Signatur-Bilder ===
                    const signatureImg1 = sigPadRef.current.toDataURL('image/png');
                    const signatureImg2 = sigPadRef2.current.toDataURL('image/png');
                    
                    // Auftragnehmer (links)
                    doc.addImage(signatureImg1, 'PNG', 20, yPos + 5, 60, 28);
                    doc.line(20, yPos + 35, 80, yPos + 35);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text("Auftragnehmer", 20, yPos + 40);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    doc.setTextColor(80);
                    doc.text(`${zeitstempelDE}`, 20, yPos + 45);
                    doc.text(gpsText, 20, yPos + 49);
                    
                    // Auftraggeber (rechts)
                    doc.setTextColor(0);
                    doc.addImage(signatureImg2, 'PNG', 110, yPos + 5, 60, 28);
                    doc.line(110, yPos + 35, 170, yPos + 35);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text("Auftraggeber", 110, yPos + 40);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    doc.setTextColor(80);
                    doc.text(`${zeitstempelDE}`, 110, yPos + 45);
                    doc.text(gpsText, 110, yPos + 49);
                  }
                  
                  // === FORENSISCHER FOOTER ===
                  doc.setTextColor(150);
                  doc.setFontSize(6);
                  doc.text(`Dokument-ID: ${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`, 20, 285);
                  doc.text(`Zeitstempel (ISO): ${zeitstempel}`, 20, 288);
                  if (!druckModus) {
                    doc.text(`${gpsText}`, 110, 288);
                    doc.text("Dieses Dokument wurde digital erstellt und signiert.", 195, 288, { align: 'right' });
                  } else {
                    doc.text("Druckversion - Unterschriften bitte hÃ¤ndisch leisten.", 195, 288, { align: 'right' });
                  }

                  const safeName = (activeProject?.name || 'Projekt').replace(/[^a-z0-9Ã¤Ã¶Ã¼ÃŸ]/gi, '_');
                  doc.save(`Regiebericht_${safeName}_${new Date().toISOString().slice(0,10)}.pdf`);
                  setShowReportModal(false);
                }} 
                className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
              >
                <span>ğŸ“„</span> PDF erstellen
              </button>
            </div>
          </div>
        </div>
      )}

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {/* TEIL 3: MONATSAUSWERTUNG & EXPORT */}
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      
      <div className="bg-white rounded-lg shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <span>ğŸ“Š</span> Auswertungen
          </h2>
        </div>

        <div className="p-6">
        {/* Filter */}
        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6 flex flex-wrap gap-4 items-end">
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Monat</label>
            <div className="flex items-center gap-2">
              <button 
                onClick={() => {
                  const d = new Date(date);
                  d.setMonth(d.getMonth() - 1);
                  setDate(d.toISOString().split('T')[0]);
                }}
                className="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded font-bold text-lg transition-colors"
              >
                â†
              </button>
              <input 
                type="month" 
                className="p-2 border border-slate-300 rounded font-mono bg-white text-center"
                value={date.substring(0, 7)} 
                onChange={e => setDate(e.target.value + "-01")}
              />
              <button 
                onClick={() => {
                  const d = new Date(date);
                  d.setMonth(d.getMonth() + 1);
                  setDate(d.toISOString().split('T')[0]);
                }}
                className="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded font-bold text-lg transition-colors"
              >
                â†’
              </button>
            </div>
          </div>
          <div className="flex-1 flex justify-end gap-3">
             <button 
                onClick={() => {
                  const currentMonth = date.substring(0, 7);
                  const monthName = new Date(date).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                  
                  // ZÃ¤hle EintrÃ¤ge im Monat und speichere IDs VOR dem Ãœberschreiben
                  const eintraegeImMonat = (zeiterfassung.monatsListe || []).filter(e => e.datum?.startsWith(currentMonth));
                  const zuLoeschendeIds = eintraegeImMonat.map(e => e.id);
                  
                  if (eintraegeImMonat.length === 0) {
                    alert(`Keine Stunden fÃ¼r ${monthName} in der Monatsauswertung vorhanden.`);
                    return;
                  }
                  
                  if (!confirm(`${eintraegeImMonat.length} EintrÃ¤ge fÃ¼r ${monthName} unwiderruflich lÃ¶schen?\n\nDie Daten werden gelÃ¶scht.\n\nIn den Projekten (fÃ¼r Kunden-Rechnungen) bleiben die Stunden erhalten!`)) {
                    return;
                  }
                  
                  // FORENSISCH SICHER: 3x mit Zufallsdaten Ã¼berschreiben (nach ID, nicht nach Datum!)
                  for (let pass = 0; pass < 3; pass++) {
                    updateState(prev => {
                      const prevZeit = prev.zeiterfassung || { projekte: [], monatsListe: [] };
                      return {
                        ...prev,
                        zeiterfassung: {
                          ...prevZeit,
                          monatsListe: (prevZeit.monatsListe || []).map(eintrag => {
                            if (zuLoeschendeIds.includes(eintrag.id)) {
                              // Alle Felder mit Zufallsdaten Ã¼berschreiben
                              return {
                                id: eintrag.id,
                                datum: Math.random().toString(36),
                                projektName: Math.random().toString(36),
                                projektId: Math.random().toString(36),
                                mitarbeiter: Math.random().toString(36),
                                typ: Math.random() > 0.5 ? 'X' : 'Y',
                                von: Math.random().toString(),
                                bis: Math.random().toString(),
                                netto: Math.random() * 999999,
                                created: Math.random().toString(36)
                              };
                            }
                            return eintrag;
                          })
                        }
                      };
                    });
                  }
                  
                  // Nach 3x Ãœberschreiben: EndgÃ¼ltig aus Array entfernen (nach ID!)
                  setTimeout(() => {
                    updateState(prev => {
                      const prevZeit = prev.zeiterfassung || { projekte: [], monatsListe: [] };
                      return {
                        ...prev,
                        zeiterfassung: {
                          ...prevZeit,
                          monatsListe: (prevZeit.monatsListe || []).filter(e => !zuLoeschendeIds.includes(e.id))
                        }
                      };
                    });
                    alert(`${eintraegeImMonat.length} EintrÃ¤ge fÃ¼r ${monthName} wurden gelÃ¶scht.`);
                  }, 150);
                }}
                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-colors"
             >
               Monat lÃ¶schen
             </button>
          </div>
        </div>

        {(() => {
          // Live-Berechnung aller Statistiken
          const currentMonth = date.substring(0, 7);
          const mitarbeiterStats = {};
          const projektStats = {};
          const materialListe = [];
          const einst = zeiterfassung.einstellungen || {};
          
          // 1. Projekte durchgehen NUR fÃ¼r Projekt-Statistik und Material
          (zeiterfassung.projekte || []).forEach(proj => {
            if (!projektStats[proj.id]) {
              projektStats[proj.id] = { name: proj.name, stundenF: 0, stundenH: 0, tage: 0, material: [] };
            }
            
            Object.entries(proj.tage || {}).forEach(([tagDatum, tagData]) => {
              if (tagDatum.startsWith(currentMonth)) {
                projektStats[proj.id].tage++;
                
                if (tagData.material) {
                  projektStats[proj.id].material.push({ datum: tagDatum, text: tagData.material });
                  materialListe.push({ datum: tagDatum, projekt: proj.name, text: tagData.material });
                }
                
                // Projekt-Stunden zÃ¤hlen (fÃ¼r Projekt-Ãœbersicht)
                (tagData.entries || []).forEach(entry => {
                  const stunden = parseFloat(entry.netto) || 0;
                  if (entry.typ === 'F') {
                    projektStats[proj.id].stundenF += stunden;
                  } else {
                    projektStats[proj.id].stundenH += stunden;
                  }
                });
              }
            });
          });
          
          // 2. Mitarbeiter-Stunden NUR aus monatsListe (getrennte Speicherung)
          (zeiterfassung.monatsListe || []).forEach(eintrag => {
            if (eintrag.datum && eintrag.datum.startsWith(currentMonth)) {
              if (!mitarbeiterStats[eintrag.mitarbeiter]) {
                mitarbeiterStats[eintrag.mitarbeiter] = { stundenF: 0, stundenH: 0, projects: new Set() };
              }
              const stunden = parseFloat(eintrag.netto) || 0;
              if (eintrag.typ === 'F') {
                mitarbeiterStats[eintrag.mitarbeiter].stundenF += stunden;
              } else {
                mitarbeiterStats[eintrag.mitarbeiter].stundenH += stunden;
              }
              mitarbeiterStats[eintrag.mitarbeiter].projects.add(eintrag.projektName);
            }
          });
          
          const stundenlohnF = einst.stundenlohnF || 59;
          const stundenlohnH = einst.stundenlohnH || 50;
          const kostenAktiv = einst.kostenAktiv === true;
          
          // Gesamtsummen
          let gesamtF = 0, gesamtH = 0;
          Object.values(mitarbeiterStats).forEach(s => {
            gesamtF += s.stundenF;
            gesamtH += s.stundenH;
          });
          const gesamtStunden = gesamtF + gesamtH;
          const gesamtKosten = (gesamtF * stundenlohnF) + (gesamtH * stundenlohnH);
          
          return (
            <div className="space-y-6">

              {/* MITARBEITER-TABELLE */}
              <div className="bg-white rounded-lg shadow-lg overflow-hidden border border-slate-200">
                <div className="bg-gradient-to-r from-slate-600 to-slate-700 text-white p-3 font-semibold">
                  Mitarbeiter-Stunden
                </div>
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 text-slate-600 font-bold border-b">
                    <tr>
                      <th className="p-3 text-left">Mitarbeiter</th>
                      <th className="p-3 text-left">Projekt(e)</th>
                      <th className="p-3 text-right">F-Std.</th>
                      <th className="p-3 text-right">H-Std.</th>
                      <th className="p-3 text-right">Gesamt</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(mitarbeiterStats).length === 0 ? (
                      <tr><td colSpan="5" className="p-8 text-center text-slate-400">Keine Stunden im gewÃ¤hlten Monat.</td></tr>
                    ) : (
                      Object.entries(mitarbeiterStats)
                        .sort((a,b) => a[0].localeCompare(b[0]))
                        .map(([name, data]) => {
                          const summe = data.stundenF + data.stundenH;
                          return (
                            <tr key={name} className="border-b last:border-0 hover:bg-slate-50">
                              <td className="p-3 font-medium text-slate-800">{name}</td>
                              <td className="p-3 text-slate-500 text-xs">{Array.from(data.projects).join(", ")}</td>
                              <td className="p-3 text-right text-slate-600">{data.stundenF.toFixed(2)}</td>
                              <td className="p-3 text-right text-slate-600">{data.stundenH.toFixed(2)}</td>
                              <td className="p-3 text-right font-bold text-slate-800">{summe.toFixed(2)} h</td>
                            </tr>
                          );
                        })
                    )}
                  </tbody>
                  {Object.entries(mitarbeiterStats).length > 0 && (
                    <tfoot className="bg-slate-200 font-bold">
                      <tr>
                        <td className="p-3">SUMME</td>
                        <td className="p-3"></td>
                        <td className="p-3 text-right text-slate-700">{gesamtF.toFixed(2)}</td>
                        <td className="p-3 text-right text-slate-700">{gesamtH.toFixed(2)}</td>
                        <td className="p-3 text-right text-slate-800">{gesamtStunden.toFixed(2)} h</td>
                      </tr>
                    </tfoot>
                  )}
                </table>
              </div>
            </div>
          );
        })()}
        
        {/* Privacy Footer - Zeiterfassung, erscheint nur am Ende beim Scrollen */}
        <div className="p-4 md:p-6">
          <div className="privacy-footer no-print">
            {/* Speicher-Warnung bei >90% */}
            {speicherInfo?.istKritisch && (
              <div className="bg-red-900/50 border-2 border-red-500 rounded-lg p-4 mb-4 text-center">
                <div className="text-2xl mb-2">âš ï¸</div>
                <strong className="text-red-300 text-sm">Speicher fast voll ({speicherInfo.prozent}%)</strong>
                <p className="text-red-200 text-xs mt-2">
                  Bitte Stammdaten exportieren und mit einem frischen Vault neu starten.
                </p>
              </div>
            )}
            
            {/* Speicher-Ãœbersicht */}
            <div className="bg-slate-800/80 rounded-lg p-3 mb-4 border border-slate-600/30">
              <div className="flex items-center justify-between mb-2 text-xs">
                <span className="text-slate-400 font-semibold">ğŸ’¾ Vault-Speicher</span>
                <span className={speicherInfo?.istKritisch ? 'text-red-400' : speicherInfo?.istWarnung ? 'text-yellow-400' : 'text-green-400'} style={{fontWeight: 700}}>
                  {speicherInfo?.prozent || 0}% belegt ({speicherInfo?.belegtKB || 0} KB / {Math.round((speicherInfo?.maxDataSize || 0)/1024)} KB)
                </span>
              </div>
              <div className="bg-slate-900 rounded h-2 overflow-hidden">
                <div 
                  className={`h-full rounded transition-all ${speicherInfo?.istKritisch ? 'bg-red-500' : speicherInfo?.istWarnung ? 'bg-yellow-500' : 'bg-green-500'}`}
                  style={{width: `${Math.min(100, speicherInfo?.prozent || 0)}%`}}
                />
              </div>
              <div className="flex justify-between mt-1 text-[10px] text-slate-500">
                <span>{appState.zeiterfassung?.projekte?.length || 0} Projekte â€¢ {appState.zeiterfassung?.mitarbeiter?.length || 0} Mitarbeiter</span>
                <span>{speicherInfo?.freiKB || 0} KB frei</span>
              </div>
            </div>
            
            <div className="privacy-footer-motto">
              <span className="shield">ğŸ›¡ï¸</span>Wir speichern nichts. Wir sehen nichts.
            </div>
            <p className="privacy-footer-text">
              <strong>Zero-Knowledge-Prinzip:</strong> Ihre Daten werden ausschlieÃŸlich lokal in Ihrem Browser (IndexedDB) gespeichert und Backups mit <strong>AES-256-GCM</strong> verschlÃ¼sselt. Kein Server, keine Cloud, keine Datensammlung â€“ Ihre Zeiterfassung gehÃ¶rt nur Ihnen.
            </p>
            <div className="privacy-footer-badges">
              <span className="privacy-badge green">âœ“ Lokale Speicherung</span>
              <span className="privacy-badge green">âœ“ Keine Registrierung</span>
              <span className="privacy-badge">ğŸ” MilitÃ¤rgrad-VerschlÃ¼sselung</span>
              <span className="privacy-badge">ğŸ’¾ IndexedDB</span>
              <span className="privacy-badge green">âœ“ DSGVO-konform</span>
            </div>
            <div className="privacy-footer-copyright">
              Â© 2026 Business Suite â€“ Professionelle Zeiterfassung mit maximaler Datensicherheit
            </div>
          </div>
        </div>
      </div>
      </div>
      </div>
    </div>
  );
}

// PDF-Export fÃ¼r Zeiterfassung (erweitert mit Kosten & Material)
const generateTimeTrackingPDF = (appState, zeiterfassung, monthStr) => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const firmenName = appState.firmenDaten?.firmenname || "Firma";
  const einst = zeiterfassung.einstellungen || {};
  const stundenlohnF = einst.stundenlohnF || 59;
  const stundenlohnH = einst.stundenlohnH || 50;
  const kostenAktiv = einst.kostenAktiv === true;
  const unterschriftAktiv = einst.unterschriftAktiv !== false;
  
  // Daten sammeln
  const stundenRows = [];
  const materialListe = [];
  const projektStats = {};
  const mitarbeiterStats = {};
  let gesamtF = 0, gesamtH = 0;
  
  (zeiterfassung.projekte || []).forEach(proj => {
    if (!projektStats[proj.id]) {
      projektStats[proj.id] = { name: proj.name, stundenF: 0, stundenH: 0 };
    }
    
    Object.entries(proj.tage || {}).forEach(([tagDatum, tagData]) => {
      if (tagDatum.startsWith(monthStr)) {
        // Material sammeln
        if (tagData.material) {
          materialListe.push({ datum: tagDatum, projekt: proj.name, text: tagData.material });
        }
        
        (tagData.entries || []).forEach(entry => {
          const stunden = parseFloat(entry.netto) || 0;
          
          stundenRows.push([
            tagDatum,
            entry.mitarbeiter,
            entry.typ,
            proj.name,
            entry.von + ' - ' + entry.bis,
            stunden.toFixed(2)
          ]);
          
          // Statistiken aktualisieren
          if (!mitarbeiterStats[entry.mitarbeiter]) {
            mitarbeiterStats[entry.mitarbeiter] = { stundenF: 0, stundenH: 0 };
          }
          
          if (entry.typ === 'F') {
            gesamtF += stunden;
            projektStats[proj.id].stundenF += stunden;
            mitarbeiterStats[entry.mitarbeiter].stundenF += stunden;
          } else {
            gesamtH += stunden;
            projektStats[proj.id].stundenH += stunden;
            mitarbeiterStats[entry.mitarbeiter].stundenH += stunden;
          }
        });
      }
    });
  });
  
  const gesamtStunden = gesamtF + gesamtH;
  const gesamtKosten = (gesamtF * stundenlohnF) + (gesamtH * stundenlohnH);
  
  // Sortieren
  stundenRows.sort((a,b) => a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]));
  materialListe.sort((a,b) => a.datum.localeCompare(b.datum));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PDF Generierung
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 14;
  let y = 20;
  
  // Header
  doc.setFontSize(18);
  doc.setTextColor(234, 88, 12); // Orange
  doc.text('STUNDENÃœBERSICHT', margin, y);
  
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(monthStr, pageWidth - margin, y, { align: 'right' });
  
  y += 8;
  doc.setFontSize(10);
  doc.text(firmenName, margin, y);
  
  // Trennlinie
  y += 5;
  doc.setDrawColor(234, 88, 12);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  
  y += 10;
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ZUSAMMENFASSUNG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  doc.setFillColor(249, 250, 251);
  doc.rect(margin, y, pageWidth - 2*margin, kostenAktiv ? 22 : 14, 'F');
  
  doc.setFontSize(9);
  doc.setTextColor(80, 80, 80);
  doc.text('ZUSAMMENFASSUNG', margin + 4, y + 5);
  
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text(`Gesamt: ${gesamtStunden.toFixed(2)} h`, margin + 4, y + 11);
  doc.text(`Facharbeiter (F): ${gesamtF.toFixed(2)} h`, margin + 60, y + 11);
  doc.text(`Helfer (H): ${gesamtH.toFixed(2)} h`, margin + 120, y + 11);
  
  if (kostenAktiv) {
    doc.setTextColor(147, 51, 234); // Purple
    doc.text(`Kosten: ${gesamtKosten.toFixed(2)} â‚¬`, margin + 4, y + 18);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`(F: ${stundenlohnF}â‚¬/h Ã— ${gesamtF.toFixed(1)}h = ${(gesamtF * stundenlohnF).toFixed(0)}â‚¬  |  H: ${stundenlohnH}â‚¬/h Ã— ${gesamtH.toFixed(1)}h = ${(gesamtH * stundenlohnH).toFixed(0)}â‚¬)`, margin + 40, y + 18);
  }
  
  y += kostenAktiv ? 28 : 20;
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROJEKT-ÃœBERSICHT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const aktiveProjekte = Object.values(projektStats).filter(p => p.stundenF + p.stundenH > 0);
  if (aktiveProjekte.length > 0) {
    doc.setFontSize(10);
    doc.setTextColor(234, 88, 12);
    doc.text('PROJEKTE', margin, y);
    y += 4;
    
    const projektRows = aktiveProjekte.map(p => {
      const summe = p.stundenF + p.stundenH;
      const kosten = (p.stundenF * stundenlohnF) + (p.stundenH * stundenlohnH);
      return kostenAktiv 
        ? [p.name, p.stundenF.toFixed(1) + ' h', p.stundenH.toFixed(1) + ' h', summe.toFixed(1) + ' h', kosten.toFixed(0) + ' â‚¬']
        : [p.name, p.stundenF.toFixed(1) + ' h', p.stundenH.toFixed(1) + ' h', summe.toFixed(1) + ' h'];
    });
    
    doc.autoTable({
      startY: y,
      head: [kostenAktiv ? ['Projekt', 'F-Std.', 'H-Std.', 'Gesamt', 'Kosten'] : ['Projekt', 'F-Std.', 'H-Std.', 'Gesamt']],
      body: projektRows,
      theme: 'striped',
      styles: { fontSize: 8 },
      headStyles: { fillColor: [234, 88, 12], textColor: 255 },
      margin: { left: margin, right: margin }
    });
    
    y = doc.lastAutoTable.finalY + 8;
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STUNDENDETAILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (stundenRows.length > 0) {
    // Seitenumbruch wenn nÃ¶tig
    if (y > 200) { doc.addPage(); y = 20; }
    
    doc.setFontSize(10);
    doc.setTextColor(59, 130, 246); // Blue
    doc.text('STUNDENDETAILS', margin, y);
    y += 4;
    
    doc.autoTable({
      startY: y,
      head: [['Datum', 'Mitarbeiter', 'Typ', 'Projekt', 'Zeit', 'Std.']],
      body: stundenRows,
      theme: 'grid',
      styles: { fontSize: 7 },
      headStyles: { fillColor: [59, 130, 246], textColor: 255 },
      columnStyles: {
        0: { cellWidth: 22 },
        2: { cellWidth: 10, halign: 'center' },
        5: { cellWidth: 15, halign: 'right' }
      },
      margin: { left: margin, right: margin }
    });
    
    y = doc.lastAutoTable.finalY + 8;
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MATERIAL-LISTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (materialListe.length > 0) {
    // Seitenumbruch wenn nÃ¶tig
    if (y > 220) { doc.addPage(); y = 20; }
    
    doc.setFontSize(10);
    doc.setTextColor(16, 185, 129); // Emerald
    doc.text('MATERIAL & BEMERKUNGEN', margin, y);
    y += 4;
    
    const materialRows = materialListe.map(m => [m.datum, m.projekt, m.text]);
    
    doc.autoTable({
      startY: y,
      head: [['Datum', 'Projekt', 'Material / Bemerkung']],
      body: materialRows,
      theme: 'striped',
      styles: { fontSize: 8 },
      headStyles: { fillColor: [16, 185, 129], textColor: 255 },
      columnStyles: {
        0: { cellWidth: 22 },
        1: { cellWidth: 35 }
      },
      margin: { left: margin, right: margin }
    });
    
    y = doc.lastAutoTable.finalY + 10;
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UNTERSCHRIFTSFELDER (optional)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (unterschriftAktiv) {
    // Seitenumbruch wenn nÃ¶tig
    if (y > 240) { doc.addPage(); y = 20; }
    
    y += 10;
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    
    // Zwei Unterschriftsfelder nebeneinander
    const boxWidth = 80;
    
    doc.text('Auftraggeber:', margin, y);
    doc.text('Auftragnehmer:', pageWidth / 2 + 5, y);
    y += 15;
    
    doc.setDrawColor(150, 150, 150);
    doc.line(margin, y, margin + boxWidth, y);
    doc.line(pageWidth / 2 + 5, y, pageWidth / 2 + 5 + boxWidth, y);
    
    y += 4;
    doc.text('Datum, Unterschrift', margin, y);
    doc.text('Datum, Unterschrift', pageWidth / 2 + 5, y);
  }
  
  // Footer auf allen Seiten
  const totalPages = doc.internal.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text(`Erstellt: ${new Date().toLocaleDateString('de-DE')} | Seite ${i} von ${totalPages}`, pageWidth / 2, 290, { align: 'center' });
  }
  
  doc.save(`Stunden_${monthStr}.pdf`);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EINSTELLUNGEN MODUL - Zentrale Konfiguration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function SettingsModule({ appState, updateState, cloudConfig, setCloudConfig, triggerCloudSync, restoreFromCloud, syncStatus, exportFullBackup, importBackupFile, exportStammdatenFile }) {
  const [activeTab, setActiveTab] = useState('profil');
  const fd = appState.firmenDaten || {};

  const updateFd = (field, value) => {
    updateState(prev => ({
      ...prev,
      firmenDaten: { ...prev.firmenDaten, [field]: value }
    }));
  };

  return (
    <div className="main-content flex-1 pt-14 md:pt-0 pb-20 md:pb-6 flex flex-col bg-slate-100 overflow-y-auto">
      <div className="max-w-5xl mx-auto p-6 md:p-10 w-full">
        <h1 className="text-3xl font-bold text-slate-800 mb-6">Einstellungen</h1>

        {/* TABS */}
        <div className="flex gap-4 mb-8 border-b border-slate-200">
          <button onClick={() => setActiveTab('profil')} className={`pb-2 px-1 font-bold transition-colors ${activeTab === 'profil' ? 'text-slate-800 border-b-2 border-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>Firmenprofil</button>
          <button onClick={() => setActiveTab('cloud')} className={`pb-2 px-1 font-bold transition-colors ${activeTab === 'cloud' ? 'text-slate-800 border-b-2 border-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>Cloud & Sync</button>
          <button onClick={() => setActiveTab('daten')} className={`pb-2 px-1 font-bold transition-colors ${activeTab === 'daten' ? 'text-slate-800 border-b-2 border-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>Daten & Backup</button>
        </div>

        {/* TAB 1: FIRMENPROFIL */}
        {activeTab === 'profil' && (
          <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold mb-6 flex items-center justify-between">
               <span>Stammdaten</span>
               <span className="text-xs font-normal text-slate-400">Diese Daten erscheinen auf allen Dokumenten.</span>
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {/* Linke Spalte: Adresse */}
              <div className="space-y-4">
                <h3 className="font-bold text-slate-400 uppercase text-xs tracking-wider">Anschrift</h3>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">Firmenname / Inhaber</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.firmenname || ''} onChange={e => updateFd('firmenname', e.target.value)} placeholder="Max Mustermann Handwerk" />
                </div>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">StraÃŸe & Nr.</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.strasse || ''} onChange={e => updateFd('strasse', e.target.value)} placeholder="MusterstraÃŸe 1" />
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">PLZ</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.plz || ''} onChange={e => updateFd('plz', e.target.value)} placeholder="12345" />
                  </div>
                  <div className="col-span-2">
                    <label className="block text-sm font-bold text-slate-700 mb-1">Ort</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.ort || ''} onChange={e => updateFd('ort', e.target.value)} placeholder="Musterstadt" />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">Land</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.land || ''} onChange={e => updateFd('land', e.target.value)} placeholder="Deutschland" />
                </div>
              </div>

              {/* Rechte Spalte: Kontakt & Bank */}
              <div className="space-y-4">
                <h3 className="font-bold text-slate-400 uppercase text-xs tracking-wider">Kontakt & Finanzen</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">Telefon</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.telefon || ''} onChange={e => updateFd('telefon', e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">E-Mail</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.email || ''} onChange={e => updateFd('email', e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">Webseite</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.website || ''} onChange={e => updateFd('website', e.target.value)} />
                </div>
                <hr className="my-4 border-slate-200" />
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">Bankname</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.bankName || ''} onChange={e => updateFd('bankName', e.target.value)} placeholder="Sparkasse..." />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">IBAN</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg font-mono text-sm" value={fd.iban || ''} onChange={e => updateFd('iban', e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">BIC</label>
                    <input type="text" className="w-full p-3 border border-slate-300 rounded-lg font-mono text-sm" value={fd.bic || ''} onChange={e => updateFd('bic', e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1">Steuernummer / USt-ID</label>
                  <input type="text" className="w-full p-3 border border-slate-300 rounded-lg" value={fd.steuernummer || ''} onChange={e => updateFd('steuernummer', e.target.value)} />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* TAB 2: CLOUD SYNC */}
        {activeTab === 'cloud' && (
          <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
            <div className="flex justify-between items-start mb-6">
              <div>
                <h2 className="text-xl font-bold">Cloud-Sync</h2>
                <p className="text-slate-500 text-sm mt-1">Synchronisiert deine verschlÃ¼sselten Daten automatisch in die Cloud. Die Daten bleiben Ende-zu-Ende verschlÃ¼sselt.</p>
              </div>
              <div className={`px-3 py-1 rounded-full text-xs font-bold ${cloudConfig?.enabled ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                {cloudConfig?.enabled ? 'â— Aktiv' : 'â—‹ Deaktiviert'}
              </div>
            </div>

            <div className="bg-slate-50 p-6 rounded-lg border border-slate-200">
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2">LizenzschlÃ¼ssel</label>
              <div className="flex gap-3">
                <input 
                  type="password" 
                  className="flex-1 p-3 border border-slate-300 rounded-lg font-mono text-sm"
                  placeholder="Dein LizenzschlÃ¼ssel..."
                  value={cloudConfig?.licenseKey || ''}
                  onChange={e => setCloudConfig({ licenseKey: e.target.value })}
                />
                <button 
                  onClick={() => setCloudConfig({ enabled: !cloudConfig?.enabled })}
                  className={`px-6 rounded-lg font-bold transition-colors ${cloudConfig?.enabled ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-teal-600 text-white hover:bg-teal-700'}`}
                >
                  {cloudConfig?.enabled ? 'Deaktivieren' : 'Aktivieren'}
                </button>
              </div>
              <div className="mt-4 flex items-center gap-2 text-xs text-slate-500">
                 <span>Daten werden lokal verschlÃ¼sselt, bevor sie hochgeladen werden.</span>
                 <span className="ml-auto font-mono">
                   {syncStatus === 'uploading' && 'â³ Synchronisiere...'}
                   {syncStatus === 'success' && 'âœ… Synchronisiert'}
                   {syncStatus === 'error' && 'âŒ Fehler'}
                   {syncStatus === 'idle' && 'â—‹ Bereit'}
                 </span>
              </div>
              {cloudConfig?.enabled && (
                <div className="mt-4 flex gap-3">
                   <button 
                     onClick={triggerCloudSync} 
                     disabled={syncStatus === 'uploading'} 
                     className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold text-white text-sm flex justify-center items-center gap-2 disabled:opacity-50"
                   >
                     {syncStatus === 'uploading' ? 'â³ Synchronisiere...' : 'â˜ï¸ In Cloud hochladen'}
                   </button>
                   <button 
                     onClick={restoreFromCloud} 
                     disabled={syncStatus === 'uploading'} 
                     className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-bold text-white text-sm flex justify-center items-center gap-2 disabled:opacity-50"
                   >
                     â˜ï¸ Aus Cloud wiederherstellen
                   </button>
                </div>
              )}
            </div>

            {/* Info-Box */}
            <div className="mt-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
              <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <span>â„¹ï¸</span> Ihre Vorteile & Sicherheit
              </h3>
              <p className="text-sm text-slate-600 mb-4">
                Wir nutzen eine militÃ¤rische Sicherheits-Architektur, die Datenschutz mit modernem Komfort verbindet:
              </p>
              <div className="space-y-4 text-sm text-slate-700">
                <div className="flex gap-3">
                  <span className="text-xl flex-shrink-0">ğŸ”„</span>
                  <div>
                    <strong>Backup & GerÃ¤te-Sync:</strong> Ihre Daten sind sicher, selbst wenn Ihr GerÃ¤t verloren geht oder defekt ist. Gleichzeitig kÃ¶nnen Sie nahtlos zwischen PC, Tablet und Laptop wechseln â€“ alle GerÃ¤te sind immer auf dem gleichen Stand.
                  </div>
                </div>
                <div className="flex gap-3">
                  <span className="text-xl flex-shrink-0">ğŸ›¡ï¸</span>
                  <div>
                    <strong>Digitale Tarnkappe (5 MB Schutz):</strong> Wir speichern Daten in festen, mit Rauschen aufgefÃ¼llten 5-MB-Containern. Der Vorteil: Von auÃŸen sieht eine leere Datenbank exakt so aus wie eine volle. Niemand kann anhand der DateigrÃ¶ÃŸe erraten, wie viele Kunden Sie haben.
                  </div>
                </div>
                <div className="flex gap-3">
                  <span className="text-xl flex-shrink-0">ğŸ”’</span>
                  <div>
                    <strong>EndgÃ¼ltiges & Sicheres LÃ¶schen:</strong> Cloudflare R2 (unser Speicher) nutzt keine Historie. Wenn Sie synchronisieren, wird der alte Tresor physikalisch Ã¼berschrieben und vernichtet.
                  </div>
                </div>
                <div className="flex gap-3">
                  <span className="text-xl flex-shrink-0">ğŸ‘ï¸</span>
                  <div>
                    <strong>Kein "Big Tech" Scannen:</strong> Anders als herkÃ¶mmliche Clouds (die Daten oft indexieren), dient dieser Speicher nur als "dumme" Ablage fÃ¼r den verschlÃ¼sselten Container. Ihre Daten werden nicht analysiert.
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* TAB 3: DATEN & BACKUP */}
        {activeTab === 'daten' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             {/* Backup Export */}
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
               <h3 className="font-bold text-lg mb-2">VerschlÃ¼sseltes Backup</h3>
               <p className="text-sm text-slate-500 mb-4 flex-1">Exportiert alle Daten als verschlÃ¼sselte Datei. Kann auf anderen GerÃ¤ten importiert werden.</p>
               <button 
                 onClick={exportFullBackup}
                 className="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 flex justify-center items-center gap-2"
               >
                 <span>ğŸ”</span> Backup erstellen
               </button>
             </div>

             {/* Backup Import */}
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
               <h3 className="font-bold text-lg mb-2">Backup importieren</h3>
               <p className="text-sm text-slate-500 mb-4 flex-1">Stellt ein verschlÃ¼sseltes Backup wieder her. BenÃ¶tigt das Original-Passwort.</p>
               <label className="block w-full py-4 bg-indigo-500 text-white rounded-lg font-bold hover:bg-indigo-600 text-center cursor-pointer">
                 <span>ğŸ”“ Backup laden</span>
                 <input type="file" accept=".json,.txt,.enc" className="hidden" onChange={e => {
                    const file = e.target.files[0];
                    if (file) {
                      importBackupFile(file);
                      e.target.value = '';
                    }
                 }} />
               </label>
             </div>

             {/* Stammdaten Export */}
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
               <h3 className="font-bold text-lg mb-2">Stammdaten exportieren</h3>
               <p className="text-sm text-slate-500 mb-4 flex-1">Exportiert nur Kunden, Positionen und Firmeneinstellungen (unverschlÃ¼sselt).</p>
               <button 
                 onClick={exportStammdatenFile}
                 className="w-full py-4 bg-slate-700 text-white rounded-lg font-bold hover:bg-slate-600 flex justify-center items-center gap-2"
               >
                 <span>ğŸ“¦</span> Stammdaten exportieren
               </button>
             </div>

             {/* Stammdaten Import */}
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
               <h3 className="font-bold text-lg mb-2">Stammdaten importieren</h3>
               <p className="text-sm text-slate-500 mb-4 flex-1">Importiert Kunden und Positionen aus einer Stammdaten-Datei.</p>
               <label className="block w-full py-4 bg-slate-600 text-white rounded-lg font-bold hover:bg-slate-500 text-center cursor-pointer">
                 <span>ğŸ“¥</span> Stammdaten laden
                 <input type="file" accept=".json" className="hidden" onChange={e => {
                    const file = e.target.files[0];
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = async (evt) => {
                        try {
                          const data = JSON.parse(evt.target.result);
                          if (data.kunden || data.material) {
                            updateState(prev => ({
                              ...prev,
                              kunden: [...(prev.kunden || []), ...(data.kunden || [])],
                              material: [...(prev.material || []), ...(data.material || [])]
                            }));
                            alert(`âœ… Import erfolgreich!\n\n${(data.kunden || []).length} Kunden\n${(data.material || []).length} Positionen`);
                          } else {
                            alert('Keine gÃ¼ltigen Stammdaten gefunden.');
                          }
                        } catch (err) {
                          alert('Fehler beim Import: ' + err.message);
                        }
                      };
                      reader.readAsText(file);
                      e.target.value = '';
                    }
                 }} />
               </label>
             </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAUPTANWENDUNG (mit Vault-Integration)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MainApp() {
  const { 
    appState, 
    updateState, 
    forceSave, 
    saveStatus, 
    lastSaved,
    lockVault,
    exportStammdatenFile,
    exportFullBackup,
    importBackupFile,
    // Cloud-Sync
    cloudConfig,
    updateCloudConfig,
    syncStatus,
    lastSyncError,
    triggerCloudSync,
    restoreFromCloud
  } = useVault();
  
  // Lokale State-Werte aus appState extrahieren
  const db = { kunden: appState.kunden, material: appState.material };
  const rechnungen = [...appState.rechnungen, ...appState.angebote];
  const firmenDaten = appState.firmenDaten;
  
  // Speicher-Ãœberwachung: Berechne wie viel Platz belegt ist
  const speicherInfo = React.useMemo(() => {
    // JSON-GrÃ¶ÃŸe der Nutzdaten berechnen
    const jsonString = JSON.stringify(appState);
    const bytesUsed = new TextEncoder().encode(jsonString).length;
    
    // VerfÃ¼gbarer Platz im 5MB Container (abzÃ¼glich Overhead fÃ¼r Salt, IV, Tag, LÃ¤ngenfeld)
    const overhead = 16 + 12 + 16 + 4; // salt + iv + tag + length field
    const maxDataSize = VAULT_CONFIG.FIXED_SIZE - overhead;
    
    const prozent = Math.min(100, (bytesUsed / maxDataSize) * 100);
    const freiKB = Math.max(0, (maxDataSize - bytesUsed) / 1024);
    const belegtKB = bytesUsed / 1024;
    
    return {
      bytesUsed,
      maxDataSize,
      prozent: prozent.toFixed(1),
      freiKB: freiKB.toFixed(0),
      belegtKB: belegtKB.toFixed(0),
      istKritisch: prozent > 90,
      istWarnung: prozent > 75
    };
  }, [appState]);
  
  // Lokale UI-States
  const [activeTab, setActiveTab] = useState("material");
  const [suchTerm, setSuchTerm] = useState("");
  const [dokSuchTerm, setDokSuchTerm] = useState("");
  const [musterFilter, setMusterFilter] = useState(false);
  const [belegSort, setBelegSort] = useState("datum-desc");
  const [dokTypFilter, setDokTypFilter] = useState("alle");
  const [successMessage, setSuccessMessage] = useState("");
  const [neuMat, setNeuMat] = useState({ name: "", einheit: "Stk", preis: "0,00" });
  const [neuKunde, setNeuKunde] = useState({ anrede: "Organisation", name: "", strasse: "", plz: "", ort: "" });
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [activeModule, setActiveModule] = useState('dashboard'); // 'dashboard', 'rechnung' oder 'zeit'
  const [clickedMaterial, setClickedMaterial] = useState(null);
  const [clickedKunde, setClickedKunde] = useState(null);
  
  // â•â•â• Zeiterfassungs-States â•â•â•
  const [zeitActiveProjectId, setZeitActiveProjectId] = useState("");
  const [zeitNewProjectName, setZeitNewProjectName] = useState("");
  const [zeitActiveTab, setZeitActiveTab] = useState("projekte"); // 'projekte', 'mitarbeiter', 'einstellungen'
  // Standard-Zoom: 50% auf Mobile (< 768px), 100% auf Desktop
  const [zoomLevel, setZoomLevel] = useState(() => {
    // Desktop: immer 100%
    if (window.innerWidth >= 1024 && window.innerHeight >= 600) return 1;
    // Mobile: Bildschirmbreite / A4-Breite (210mm â‰ˆ 794px), aber mindestens 50%
    const idealZoom = window.innerWidth / 794;
    return Math.max(0.5, Math.min(1, idealZoom));
  });
  
  const logoInputRef = useRef(null);
  
  // Standard-Dokumentstruktur fÃ¼r neues Dokument
  const leeresDokument = {
    id: null,
    typ: "RECHNUNG",
    nummer: "",
    datum: new Date().toLocaleDateString('de-DE'),
    leistungszeitraum: { von: "", bis: "" },
    kunde: { name: "", strasse: "", plz: "", ort: "" },
    positionen: [],
    abschlag: "0",
    muster: false,
    arbeitsort: "",
    abschlagsrechnungBetrag: "0",
    rabatt: "0",
    rabattBeschreibung: "Nachlass",
    betreff: "",
    freitext: "",
    signaturKunde: false,
    signaturAbsender: false,
    signaturAbsenderData: "",
    signaturAbsenderOrt: "",
    signaturAbsenderDatum: "",
    rechnungshinweis: ""
  };
  
  // Generiere temporÃ¤re ID fÃ¼r EntwÃ¼rfe (negativ, um von gespeicherten Dokumenten zu unterscheiden)
  const generateEntwurfId = () => -Date.now();
  
  // Lade ersten Entwurf oder leeres Dokument
  const [aktivesDok, setAktivesDok] = useState(() => {
    const entwuerfe = appState.entwuerfe || [];
    return entwuerfe.length > 0 ? entwuerfe[0] : { ...leeresDokument, entwurfId: generateEntwurfId() };
  });
  
  // PrÃ¼ft ob das aktuelle Dokument ECHTE Ã„nderungen hat (nicht nur auto-generierte Nummer)
  // Ein Entwurf gilt als "in Bearbeitung" wenn: Positionen, Kunde oder Betreff vorhanden
  const hatUngespeichertenEntwurf = React.useMemo(() => {
    return (aktivesDok.positionen?.length > 0) || 
      ((aktivesDok.kunde?.name || '').trim() !== '') ||
      ((aktivesDok.betreff || '').trim() !== '');
  }, [aktivesDok.positionen?.length, aktivesDok.kunde?.name, aktivesDok.betreff]);
  
  // Speichere Entwurf automatisch bei Ã„nderungen
  useEffect(() => {
    // Nur speichern wenn: Hat Ã„nderungen UND hat eine Entwurf-ID
    if (hatUngespeichertenEntwurf && aktivesDok.entwurfId) {
      console.log('ğŸ“ Entwurf wird gespeichert:', aktivesDok.kunde?.name, 'ID:', aktivesDok.entwurfId);
      updateState(prev => {
        const entwuerfe = prev.entwuerfe || [];
        const existingIndex = entwuerfe.findIndex(e => e.entwurfId === aktivesDok.entwurfId);
        
        if (existingIndex >= 0) {
          // Existierenden Entwurf aktualisieren
          const neueEntwuerfe = [...entwuerfe];
          neueEntwuerfe[existingIndex] = { ...aktivesDok };
          return { ...prev, entwuerfe: neueEntwuerfe };
        } else {
          // Neuen Entwurf hinzufÃ¼gen
          console.log('ğŸ“ Neuer Entwurf hinzugefÃ¼gt');
          return { ...prev, entwuerfe: [...entwuerfe, { ...aktivesDok }] };
        }
      });
    }
  }, [aktivesDok, hatUngespeichertenEntwurf, updateState]);
  
  // Scroll-Position beim Start auf 0,0 setzen
  useEffect(() => {
    const resetScroll = () => {
      const scrollArea = document.querySelector('.preview-scroll-area');
      if (scrollArea) {
        scrollArea.scrollLeft = 0;
        scrollArea.scrollTop = 0;
      }
    };
    
    resetScroll();
    setTimeout(resetScroll, 100);
    setTimeout(resetScroll, 500);
  }, []);
  
  // Browser-Warnung NUR wenn Vault noch speichert (pending/saving)
  // Der Entwurf wird ja automatisch im Vault gespeichert, daher keine Warnung nÃ¶tig
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      // Warnung NUR wenn Vault noch nicht fertig gespeichert hat
      if (saveStatus === 'pending' || saveStatus === 'saving') {
        e.preventDefault();
        e.returnValue = 'Ã„nderungen werden noch gespeichert. Wirklich verlassen?';
        return e.returnValue;
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [saveStatus, hatUngespeichertenEntwurf]);

  // Signatur-Canvas Refs und Funktionen
  const signaturCanvasRef = useRef(null);
  const [isDrawing, setIsDrawing] = useState(false);

  const startDrawing = (e) => {
    const canvas = signaturCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
    const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
    ctx.beginPath();
    ctx.moveTo(x, y);
    setIsDrawing(true);
  };

  const draw = (e) => {
    if (!isDrawing) return;
    const canvas = signaturCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
    const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
    ctx.lineTo(x, y);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
  };

  const stopDrawing = () => {
    if (isDrawing) {
      setIsDrawing(false);
      const canvas = signaturCanvasRef.current;
      if (canvas) {
        const dataUrl = canvas.toDataURL('image/png');
        setAktivesDok(prev => ({...prev, signaturAbsenderData: dataUrl}));
      }
    }
  };

  const clearSignaturCanvas = () => {
    const canvas = signaturCanvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      setAktivesDok(prev => ({...prev, signaturAbsenderData: ''}));
    }
  };

  // Firmeneinstellungen speichern (in Vault)
  const saveFirmenDaten = (newData) => {
    const dataWithId = { ...newData, id: 1 };
    updateState(prev => ({
      ...prev,
      firmenDaten: dataWithId
    }));
  };

  // Logo hochladen
  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      saveFirmenDaten({...firmenDaten, logo: ev.target.result});
    };
    reader.readAsDataURL(file);
  };

  const Ã¼bersetzeAnrede = w => {
    w = (w || "").toLowerCase().trim();
    if (w.includes('herr') || w === 'm') return "Herr";
    if (w.includes('frau') || w === 'w') return "Frau";
    return "Organisation";
  };

  // Zeige Namen wie sie sind
  const korrigiereName = (name, isOrganisation = false) => {
    return name;
  };

  // Generiere vorgeschlagene Rechnungsnummer beim ersten Laden
  useEffect(() => {
    const prefix = "RE";
    const existing = rechnungen
      .filter(d => d.typ === "RECHNUNG" && !d.muster)
      .map(d => {
        const match = d.nummer.match(/RE-(\d+)/);
        return match ? parseInt(match[1], 10) : 0;
      });
    const nextNum = existing.length ? Math.max(...existing) + 1 : 1;
    const suggestedNumber = `${prefix}-${nextNum.toString().padStart(4, '0')}`;
    
    setAktivesDok(prev => ({...prev, nummer: suggestedNumber}));
  }, []);

  // Automatisch neue Nummer vorschlagen, wenn Dokumenttyp geÃ¤ndert wird
  useEffect(() => {
    if (aktivesDok.id) return; // Nur bei neuen Dokumenten
    
    const prefix = aktivesDok.typ === "ANGEBOT" ? "AN" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "AR" : aktivesDok.typ === "LEERES_DOKUMENT" ? "LD" : "RE";
    const existing = rechnungen
      .filter(d => d.typ === aktivesDok.typ && !d.muster)
      .map(d => {
        const match = d.nummer.match(new RegExp(`${prefix}-(\\d+)`));
        return match ? parseInt(match[1], 10) : 0;
      });
    const nextNum = existing.length ? Math.max(...existing) + 1 : 1;
    const suggestedNumber = `${prefix}-${nextNum.toString().padStart(4, '0')}`;
    
    setAktivesDok(prev => ({...prev, nummer: suggestedNumber}));
  }, [aktivesDok.typ]);

  // Datenbank speichern (im Vault)
  const saveToDB = (ndb) => {
    updateState(prev => ({
      ...prev,
      kunden: ndb.kunden,
      material: ndb.material
    }));
  };

  const generateNextNumber = () => {
    const prefix = aktivesDok.typ === "ANGEBOT" ? "AN" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "AR" : aktivesDok.typ === "LEERES_DOKUMENT" ? "LD" : "RE";
    const existing = rechnungen
      .filter(d => d.typ === aktivesDok.typ && !d.muster)
      .map(d => {
        const match = d.nummer.match(new RegExp(`${prefix}-(\\d+)`));
        return match ? parseInt(match[1], 10) : 0;
      });
    const next = existing.length ? Math.max(...existing) + 1 : 1;
    return `${prefix}-${next.toString().padStart(4, '0')}`;
  };

  const generateMusterNumber = () => {
    const prefix = aktivesDok.typ === "ANGEBOT" ? "AN" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "AR" : aktivesDok.typ === "LEERES_DOKUMENT" ? "LD" : "RE";
    const count = rechnungen.filter(d => d.muster && d.typ === aktivesDok.typ).length + 1;
    return `M-${prefix}-${count.toString().padStart(3, '0')}`;
  };

  const saveDok = (forceMuster = false, silent = false) => {
    // Wenn ein Muster bearbeitet wird und NICHT als Muster gespeichert werden soll,
    // erstelle ein neues Dokument (Muster bleibt unverÃ¤ndert)
    const isEditingMuster = aktivesDok.muster && !forceMuster;
    
    // PrÃ¼fen ob das Dokument mit dieser ID noch existiert
    const existiertInListe = aktivesDok.id !== null && aktivesDok.id > 0 && rechnungen.some(d => d.id === aktivesDok.id);
    
    // NEU: PrÃ¼fen ob der Dokumenttyp gewechselt wurde (z.B. Angebot â†’ Rechnung)
    const originalDok = existiertInListe ? rechnungen.find(d => d.id === aktivesDok.id) : null;
    const typWurdeGewechselt = originalDok && originalDok.typ !== aktivesDok.typ;
    
    // Bei Typ-Wechsel: User fragen ob neues Dokument erstellt werden soll
    if (typWurdeGewechselt && !forceMuster) {
      const originalTypText = originalDok.typ === 'ANGEBOT' ? 'Angebot' : 
                              originalDok.typ === 'ABSCHLAGSRECHNUNG' ? 'Abschlagsrechnung' : 
                              originalDok.typ === 'RECHNUNG' ? 'Rechnung' : originalDok.typ;
      const neuerTypText = aktivesDok.typ === 'ANGEBOT' ? 'Angebot' : 
                           aktivesDok.typ === 'ABSCHLAGSRECHNUNG' ? 'Abschlagsrechnung' : 
                           aktivesDok.typ === 'RECHNUNG' ? 'Rechnung' : aktivesDok.typ;
      
      const shouldCreateNew = confirm(
        `ğŸ“‹ Dokumenttyp wurde geÃ¤ndert!\n\n` +
        `Original: ${originalTypText} ${originalDok.nummer}\n` +
        `Neu: ${neuerTypText}\n\n` +
        `MÃ¶chten Sie eine NEUE ${neuerTypText} erstellen?\n` +
        `(Das ursprÃ¼ngliche ${originalTypText} bleibt erhalten)\n\n` +
        `OK = Neue ${neuerTypText} erstellen\n` +
        `Abbrechen = Nicht speichern`
      );
      
      if (!shouldCreateNew) {
        return; // Abbrechen - nichts speichern
      }
      // Weiter mit Erstellung eines neuen Dokuments (typWurdeGewechselt = true bewirkt neue ID)
    }
    
    let nr = aktivesDok.nummer.trim();
    
    if (isEditingMuster || typWurdeGewechselt) {
      // Muster wird als neues normales Dokument gespeichert ODER Typ wurde gewechselt
      nr = generateNextNumber(); // Neue Nummer generieren
    } else if (!nr) {
      nr = forceMuster ? generateMusterNumber() : generateNextNumber();
    }
    
    // Neue ID generieren wenn: Muster-Bearbeitung, Typ-Wechsel, keine ID vorhanden, oder ID existiert nicht mehr in Liste
    const brauchNeueId = isEditingMuster || typWurdeGewechselt || !aktivesDok.id || aktivesDok.id < 0 || !existiertInListe;
    
    // entwurfId entfernen fÃ¼r gespeichertes Dokument
    const { entwurfId, ...dokOhneEntwurfId } = aktivesDok;
    
    const neu = {
      ...dokOhneEntwurfId,
      id: brauchNeueId ? Date.now() : aktivesDok.id,
      nummer: nr,
      // Bei Muster-Bearbeitung: muster auf false setzen
      muster: isEditingMuster ? false : (forceMuster || aktivesDok.muster)
    };
    
    // Bei Muster-Bearbeitung, Typ-Wechsel oder neuem Dokument: hinzufÃ¼gen
    // Bei existierendem Dokument: aktualisieren
    const allDocs = brauchNeueId
      ? [...rechnungen, neu]  // Neues Dokument hinzufÃ¼gen
      : rechnungen.map(d => d.id === aktivesDok.id ? neu : d);  // Existierendes aktualisieren
    
    // Aktualisiere auch aktivesDok mit der neuen ID (ohne entwurfId)
    setAktivesDok(neu);
    
    // Speichere Rechnungen und Angebote getrennt im Vault
    const rechnungenItems = allDocs.filter(d => d.typ !== "ANGEBOT");
    const angeboteItems = allDocs.filter(d => d.typ === "ANGEBOT");
    
    // Entwurf aus der Liste entfernen (falls vorhanden)
    updateState(prev => {
      const entwuerfe = (prev.entwuerfe || []).filter(e => e.entwurfId !== entwurfId);
      return {
        ...prev,
        rechnungen: rechnungenItems,
        angebote: angeboteItems,
        entwuerfe: entwuerfe
      };
    });
    
    if (neu.muster) setMusterFilter(true);
    if (isEditingMuster) setMusterFilter(false); // Zeige normale Dokumente nach Muster-Konvertierung
    
    // Bessere BestÃ¤tigungsmeldung
    if (!silent) {
      if (typWurdeGewechselt) {
        alert(`âœ… Neue ${neu.typ === 'ANGEBOT' ? 'Angebot' : neu.typ} ${neu.nummer} erstellt!\n\nDas ursprÃ¼ngliche ${originalDok.typ === 'ANGEBOT' ? 'Angebot' : originalDok.typ} ${originalDok.nummer} wurde beibehalten.`);
      } else {
        alert(`${neu.muster ? "Muster" : neu.typ} ${neu.nummer} gespeichert`);
      }
    }
  };

  const loadDok = d => {
    // Wenn Dokument aus gespeicherter Liste geladen wird, entwurfId entfernen
    const { entwurfId, ...dokOhneEntwurfId } = d;
    setAktivesDok(dokOhneEntwurfId);
  };

  const newDok = () => {
    // Generiere vorgeschlagene Nummer basierend auf Dokumenttyp
    const prefix = "RE";
    const existing = rechnungen
      .filter(d => d.typ === "RECHNUNG" && !d.muster)
      .map(d => {
        const match = d.nummer.match(/RE-(\d+)/);
        return match ? parseInt(match[1], 10) : 0;
      });
    const nextNum = existing.length ? Math.max(...existing) + 1 : 1;
    const suggestedNumber = `${prefix}-${nextNum.toString().padStart(4, '0')}`;
    
    const neuesDok = {
      id: null,
      entwurfId: generateEntwurfId(), // Neue Entwurf-ID fÃ¼r automatisches Speichern
      typ: "RECHNUNG",
      nummer: suggestedNumber,
      datum: new Date().toLocaleDateString('de-DE'),
      leistungszeitraum: { von: "", bis: "" },
      kunde: { name: "", strasse: "", plz: "", ort: "" },
      positionen: [],
      abschlag: "0",
      muster: false,
      arbeitsort: "",
      abschlagsrechnungBetrag: "0",
      rabatt: "0",
      rabattBeschreibung: "Nachlass",
      betreff: "",
      freitext: "",
      signaturKunde: false,
      signaturAbsender: false,
      signaturAbsenderData: "",
      signaturAbsenderOrt: "",
      signaturAbsenderDatum: "",
      rechnungshinweis: ""
    };
    setAktivesDok(neuesDok);
  };

  const copyAsMuster = d => {
    const kopie = {
      ...d,
      id: null,
      nummer: generateMusterNumber(),
      datum: new Date().toLocaleDateString('de-DE'),
      muster: true
    };
    setAktivesDok(kopie);
    saveDok(true);
  };

  const removeMuster = (d) => {
    if (!confirm(`Muster ${d.nummer} in normales Dokument umwandeln?`)) return;
    
    const allDocs = rechnungen.map(doc => doc.id === d.id ? {...doc, muster: false} : doc);
    const rechnungenItems = allDocs.filter(doc => doc.typ !== "ANGEBOT");
    const angeboteItems = allDocs.filter(doc => doc.typ === "ANGEBOT");
    
    updateState(prev => ({
      ...prev,
      rechnungen: rechnungenItems,
      angebote: angeboteItems
    }));
    
    alert(`${d.typ} ${d.nummer} ist jetzt kein Muster mehr`);
    setMusterFilter(false);
  };

  const deleteDok = async (d) => {
    if (!confirm(`${d.typ} ${d.nummer} lÃ¶schen?\n\nAlle Daten werden unwiderruflich gelÃ¶scht.`)) return;
    
    // Bestimme ob Rechnung oder Angebot
    const isAngebot = d.typ === "ANGEBOT";
    const dataPath = isAngebot ? 'angebote' : 'rechnungen';
    
    // LÃ¶schung durchfÃ¼hren
    await secureDelete(updateState, dataPath, d.id);
    
    alert(`${d.typ} ${d.nummer} wurde gelÃ¶scht`);
  };

  // Kunde lÃ¶schen
  const deleteKunde = async (k) => {
    const kundeName = k.Organisation || k.name || 'Unbenannt';
    if (!confirm(`Kunde "${kundeName}" lÃ¶schen?\n\nAlle Daten werden unwiderruflich gelÃ¶scht.\n\nHinweis: Bereits gespeicherte Rechnungen/Angebote bleiben erhalten.`)) return;
    
    // Sichere LÃ¶schung durchfÃ¼hren
    await secureDelete(updateState, 'kunden', k.id);
    
    // Falls der gelÃ¶schte Kunde gerade im aktiven Dokument verwendet wird, entfernen
    if (aktivesDok.kunde?.id === k.id) {
      setAktivesDok(prev => ({ ...prev, kunde: {} }));
    }
  };

  // Material/Position lÃ¶schen
  const deleteMaterial = async (m) => {
    const matName = m.Name || m.name || 'Unbenannt';
    if (!confirm(`Material "${matName}" lÃ¶schen?\n\nAlle Daten werden unwiderruflich gelÃ¶scht.\n\nHinweis: Bereits in Dokumenten verwendete Positionen bleiben erhalten.`)) return;
    
    // Sichere LÃ¶schung durchfÃ¼hren
    await secureDelete(updateState, 'material', m.id);
  };

  const updateStamm = (typ, kundeId, feld, val) => {
    const arr = [...db[typ]];
    const idx = arr.findIndex(item => item.id === kundeId);
    if (idx === -1) return;
    
    arr[idx] = { ...arr[idx], [feld]: val };
    saveToDB({ ...db, [typ]: arr });
    
    // Erfolgsmeldung anzeigen (nur Material)
    if (typ === "material") {
      setSuccessMessage(`âœ“ Ã„nderung gespeichert`);
      setTimeout(() => setSuccessMessage(""), 2000);
    }
    
    // Wenn ein Kunde bearbeitet wird, synchronisiere auch aktivesDok
    if (typ === "kunden") {
      const editedKunde = arr[idx];
      // PrÃ¼fe, ob dieser Kunde im aktiven Dokument verwendet wird (anhand des Namens)
      const kundenName = editedKunde.Organisation || editedKunde.name || "";
      if (aktivesDok.kunde.name && aktivesDok.kunde.name.includes(kundenName)) {
        // Aktualisiere die Adresse in aktivesDok
        setAktivesDok({
          ...aktivesDok,
          kunde: {
            ...aktivesDok.kunde,
            strasse: editedKunde.Strasse || editedKunde.strasse || "",
            plz: editedKunde.PLZ || editedKunde.plz || "",
            ort: editedKunde.Ort || editedKunde.ort || ""
          }
        });
      }
    }
  };

  // Hilfsfunktion: PrÃ¼ft ob aktives Dokument ein gespeichertes ist (nicht Entwurf)
  const istGespeichertesDokument = aktivesDok.id && aktivesDok.id > 0 && !aktivesDok.entwurfId;
  
  // Hilfsfunktion: Erstellt Kopie als neuen Entwurf
  const erstelleKopieAlsEntwurf = () => {
    const prefix = aktivesDok.typ === "ANGEBOT" ? "AN" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "AR" : aktivesDok.typ === "LEERES_DOKUMENT" ? "LD" : "RE";
    const existing = rechnungen
      .filter(d => d.typ === aktivesDok.typ && !d.muster)
      .map(d => {
        const match = d.nummer.match(new RegExp(`${prefix}-(\\d+)`));
        return match ? parseInt(match[1], 10) : 0;
      });
    const nextNum = existing.length ? Math.max(...existing) + 1 : 1;
    const suggestedNumber = `${prefix}-${nextNum.toString().padStart(4, '0')}`;
    
    return {
      ...aktivesDok,
      id: null,
      entwurfId: generateEntwurfId(),
      nummer: suggestedNumber,
      datum: new Date().toLocaleDateString('de-DE'),
      muster: false
    };
  };

  const waehleKunde = k => {
    const anrede = Ã¼bersetzeAnrede(k.anrede);
    const prfx = anrede === "Herr" ? "Herrn " : anrede === "Frau" ? "Frau " : "";
    const rawName = k.Organisation || k.name || "";
    const isOrg = !!k.Organisation;
    const correctedName = korrigiereName(rawName, isOrg);
    
    const neuerKunde = {
      name: prfx + correctedName,
      strasse: k.Strasse || k.strasse || "",
      plz: k.PLZ || k.plz || "",
      ort: k.Ort || k.ort || ""
    };
    
    // Wenn gespeichertes Dokument: Warnung anzeigen
    if (istGespeichertesDokument) {
      const alterKunde = aktivesDok.kunde?.name || 'Unbekannt';
      const choice = confirm(
        `âš ï¸ Sie bearbeiten ein gespeichertes Dokument!\n\n` +
        `${aktivesDok.typ} ${aktivesDok.nummer} (${alterKunde})\n\n` +
        `Was mÃ¶chten Sie tun?\n\n` +
        `[OK] = Neues Dokument mit "${correctedName}" erstellen\n` +
        `[Abbrechen] = Abbrechen (nichts Ã¤ndern)`
      );
      
      if (choice) {
        // Neues Dokument als Kopie erstellen
        const kopie = erstelleKopieAlsEntwurf();
        setAktivesDok({
          ...kopie,
          kunde: neuerKunde
        });
      }
      // Bei Abbrechen: Nichts tun
      return;
    }
    
    // Normaler Fall: Einfach Kunde setzen
    setAktivesDok({
      ...aktivesDok,
      kunde: neuerKunde
    });
  };

  const addPos = m => {
    const neuePosition = {
      id: Date.now(),
      name: m.Name,
      menge: "1",
      einheit: m.Einheit,
      preis: String(m.Verkaufspreis).replace('.', ','),
      isUeberschrift: false,
      isOptional: false
    };
    
    // Wenn gespeichertes Dokument: Warnung anzeigen
    if (istGespeichertesDokument) {
      const choice = confirm(
        `âš ï¸ Sie bearbeiten ein gespeichertes Dokument!\n\n` +
        `${aktivesDok.typ} ${aktivesDok.nummer}\n\n` +
        `Was mÃ¶chten Sie tun?\n\n` +
        `[OK] = Position zu neuem Dokument (Kopie) hinzufÃ¼gen\n` +
        `[Abbrechen] = Position zum Original hinzufÃ¼gen (Ã¼berschreibt!)`
      );
      
      if (choice) {
        // Neues Dokument als Kopie erstellen mit neuer Position
        const kopie = erstelleKopieAlsEntwurf();
        setAktivesDok({
          ...kopie,
          positionen: [...kopie.positionen, neuePosition]
        });
        return;
      }
      // Bei Abbrechen: Original wird bearbeitet (falls gewÃ¼nscht)
    }
    
    // Normaler Fall: Position hinzufÃ¼gen
    setAktivesDok({
      ...aktivesDok,
      positionen: [...aktivesDok.positionen, neuePosition]
    });
  };

  const parseVal = v => parseFloat(String(v || "0").replace(',', '.') || 0);

  const netto = aktivesDok.positionen.reduce((s, p) => (p.isUeberschrift || p.isOptional) ? s : s + parseVal(p.menge) * parseVal(p.preis), 0);
  const abschlagProzent = parseVal(aktivesDok.abschlag);
  const abschlagBetrag = netto * (abschlagProzent / 100);
  const restNetto = netto - abschlagBetrag;
  
  // Rabatt vom Netto abziehen
  const rabattBetrag = parseVal(aktivesDok.rabatt || "0");
  const nettoNachRabatt = restNetto - rabattBetrag;
  
  // MwSt auf Netto nach Rabatt berechnen
  const mwst = nettoNachRabatt * 0.19;
  const restBrutto = nettoNachRabatt + mwst;
  const brutto = nettoNachRabatt + mwst;
  
  // Manuell eingetragener Abschlagsrechnungsbetrag
  const abschlagsrechnungBetrag = parseVal(aktivesDok.abschlagsrechnungBetrag || "0");
  const restbetragNachAbschlag = brutto - abschlagsrechnungBetrag;

  const sortedRechnungen = [...rechnungen]
    .filter(d => musterFilter ? d.muster : !d.muster)
    .filter(d => {
      if (dokTypFilter === "alle") return true;
      if (dokTypFilter === "angebote") return d.typ === "ANGEBOT";
      if (dokTypFilter === "rechnungen") return d.typ === "RECHNUNG" || d.typ === "ABSCHLAGSRECHNUNG";
      if (dokTypFilter === "leer") return d.typ === "LEERES_DOKUMENT";
      return true;
    })
    .filter(d => {
      if (!dokSuchTerm) return true;
      const searchLower = dokSuchTerm.toLowerCase();
      return (d.nummer || "").toLowerCase().includes(searchLower) ||
             (d.kunde.name || "").toLowerCase().includes(searchLower) ||
             (d.datum || "").includes(searchLower);
    })
    .sort((a, b) => {
      if (belegSort === "datum-desc") return new Date(b.datum.split('.').reverse().join('-')) - new Date(a.datum.split('.').reverse().join('-'));
      if (belegSort === "datum-asc") return new Date(a.datum.split('.').reverse().join('-')) - new Date(b.datum.split('.').reverse().join('-'));
      if (belegSort === "nummer-desc") return (b.nummer || "").localeCompare(a.nummer || "");
      if (belegSort === "nummer-asc") return (a.nummer || "").localeCompare(b.nummer || "");
      return 0;
    });

  // Save Status Indicator
  const SaveStatusIndicator = () => {
    const statusColors = {
      saved: '#22c55e',
      pending: '#eab308',
      saving: '#3b82f6',
      error: '#ef4444'
    };
    const statusTexts = {
      saved: 'âœ“ Gespeichert',
      pending: 'â— Ã„nderungen...',
      saving: 'â†» Speichert...',
      error: 'âš  Fehler'
    };
    
    // Cloud-Sync Status
    const cloudStatusColors = {
      idle: '#64748b',
      uploading: '#8b5cf6',
      success: '#22c55e',
      error: '#ef4444'
    };
    const cloudStatusIcons = {
      idle: 'â˜ï¸',
      uploading: 'â—Œ',
      success: 'âœ“',
      error: 'âœ—'
    };
    
    return (
      <div style={{ 
        display: 'flex', 
        alignItems: 'center', 
        gap: '8px', 
        fontSize: '10px',
        padding: '4px 8px',
        background: 'rgba(0,0,0,0.3)',
        borderRadius: '4px'
      }}>
        <span style={{ color: statusColors[saveStatus] }}>{statusTexts[saveStatus]}</span>
        {lastSaved && saveStatus === 'saved' && (
          <span style={{ color: '#64748b' }}>
            {lastSaved.toLocaleTimeString('de-DE')}
          </span>
        )}
        {cloudConfig.enabled && (
          <span style={{ 
            color: cloudStatusColors[syncStatus], 
            marginLeft: '4px',
            borderLeft: '1px solid #475569',
            paddingLeft: '8px'
          }}>
            {cloudStatusIcons[syncStatus]} Cloud
          </span>
        )}
      </div>
    );
  };

  // ============================================================
  // ZENTRALE PDF-RENDER-FUNKTION - wird von allen PDF-Exports genutzt
  // ============================================================
  const renderPDFContent = (doc, dokument, firma, berechnungen) => {
    const { restNetto, nettoNachRabatt, mwst, brutto, abschlagProzent, abschlagBetrag, restBrutto } = berechnungen;
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const ml = 25;
    const mr = 20;
    const mt = 25;
    const mb = 45;
    const headerOffset = mt + 28;

    const addHeader = (pageNum = 1) => {
      const hexColor = firma.primaerFarbe || "#006666";
      const r = parseInt(hexColor.slice(1,3), 16);
      const g = parseInt(hexColor.slice(3,5), 16);
      const b = parseInt(hexColor.slice(5,7), 16);
      
      if (firma.logo) {
        const logoWidth = firma.logoBreite || 40;
        const logoHeight = firma.logoHoehe || 15;
        let logoX = ml;
        if (firma.logoPosition === "mitte") logoX = (pageWidth - logoWidth) / 2;
        else if (firma.logoPosition === "rechts") logoX = pageWidth - mr - logoWidth;
        try { doc.addImage(firma.logo, 'AUTO', logoX, mt - 10, logoWidth, logoHeight); } catch(e) {}
      }
      
      doc.setFontSize(28);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(r, g, b);
      if (!firma.logo) {
        doc.text(firma.firmenname.toUpperCase(), pageWidth / 2, mt - 2, { align: "center" });
      }

      if (pageNum === 1) {
        doc.setFontSize(7);
        const bkColor = firma.briefkopfFarbe || "#444444";
        doc.setTextColor(parseInt(bkColor.slice(1,3), 16), parseInt(bkColor.slice(3,5), 16), parseInt(bkColor.slice(5,7), 16));
        doc.setFont("helvetica", "normal");
        const absenderName = firma.briefkopfAbsender === "firmenname" ? firma.firmenname : firma.inhaberName;
        const absender = `${absenderName} Â· ${firma.strasse} Â· ${firma.plz} ${firma.ort}`;
        doc.text(absender, ml, mt + 27);
        doc.setDrawColor(204, 204, 204);
        doc.line(ml, mt + 29, ml + doc.getTextWidth(absender), mt + 29);
      }
    };

    const addFooter = (pageNum, totalPages) => {
      let fy = pageHeight - mb + 12;
      doc.setDrawColor(204, 204, 204);
      doc.line(ml, fy + 5, pageWidth - mr, fy + 5);

      const colW = (pageWidth - ml - mr) / 4;
      const colsX = [ml, ml + colW, ml + colW * 2, ml + colW * 3];
      const emailLines = doc.splitTextToSize("E-Mail: " + firma.email, colW - 2);
      const colLines = [
        [firma.firmenname, firma.strasse, firma.plz + " " + firma.ort, firma.land],
        ["Tel. " + firma.telefon, ...emailLines, "Web: " + firma.website],
        ["Steuer-Nr. " + firma.steuernummer, "Inhaber: " + firma.inhaberName],
        ["Bank: " + firma.bankName, "IBAN: " + firma.iban, "BIC: " + firma.bic]
      ];

      doc.setFontSize(8.5);
      doc.setTextColor(68, 68, 68);
      let maxLines = Math.max(...colLines.map(c => c.length));
      let lineY = fy + 8;
      for (let i = 0; i < maxLines; i++) {
        for (let c = 0; c < 4; c++) {
          const txt = colLines[c][i];
          if (txt) doc.text(txt, colsX[c], lineY);
        }
        lineY += 3.8;
      }

      doc.setFontSize(9);
      doc.setTextColor(100);
      const pText = `Seite ${pageNum} von ${totalPages}`;
      doc.text(pText, pageWidth - mr - doc.getTextWidth(pText), pageHeight - 10);
    };

    let y = mt + 34;
    addHeader(1);

    // Anschrift
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(17, 17, 17);
    if (dokument.kunde?.name) { doc.text(dokument.kunde.name, ml, y); y += 5; }
    doc.setFont("helvetica", "normal");
    if (dokument.kunde?.strasse) { doc.text(dokument.kunde.strasse, ml, y); y += 5; }
    const plzOrt = [dokument.kunde?.plz, dokument.kunde?.ort].filter(Boolean).join(" ");
    if (plzOrt) { doc.text(plzOrt, ml, y); y += 5; }
    y += 24;

    // Titel
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 102, 102);
    const titelText = dokument.typ === "LEERES_DOKUMENT" ? (dokument.betreff || "LEERES DOKUMENT") : (dokument.typ || "RECHNUNG");
    doc.text(titelText, ml, y);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(17, 17, 17);
    const numLabel = dokument.typ === "ANGEBOT" ? "Angebots-Nr." : dokument.typ === "ABSCHLAGSRECHNUNG" ? "Abschlagsrechnungs-Nr." : dokument.typ === "LEERES_DOKUMENT" ? "Dok.-Nr." : "Rechnungs-Nr.";
    doc.text(`${numLabel}: ${dokument.nummer || "â€“"}`, pageWidth - mr, y - 4, { align: "right" });
    doc.text(`Datum: ${dokument.datum || "â€“"}`, pageWidth - mr, y, { align: "right" });
    
    if (dokument.typ !== "ANGEBOT" && dokument.typ !== "LEERES_DOKUMENT" && (dokument.leistungszeitraum?.von || dokument.leistungszeitraum?.bis)) {
      const lzVon = dokument.leistungszeitraum.von || "";
      const lzBis = dokument.leistungszeitraum.bis || "";
      const lzText = lzVon && lzBis ? `${lzVon} - ${lzBis}` : lzVon || lzBis;
      doc.text(`Leistungszeitraum: ${lzText}`, pageWidth - mr, y + 5, { align: "right" });
    }
    y += 12;

    // LEERES_DOKUMENT Spezialbehandlung
    if (dokument.typ === "LEERES_DOKUMENT") {
      if (dokument.freitext) {
        doc.setFontSize(11);
        doc.setTextColor(17, 17, 17);
        const freitextLines = doc.splitTextToSize(dokument.freitext, pageWidth - ml - mr);
        for (const ln of freitextLines) {
          if (y > pageHeight - mb) { doc.addPage(); addHeader(doc.internal.getNumberOfPages()); y = headerOffset; }
          doc.text(ln, ml, y);
          y += 6;
        }
      }
      
      const hasSignatur = dokument.signaturKunde || dokument.signaturAbsender;
      if (hasSignatur) {
        y += 15;
        if (y + 35 > pageHeight - mb) { doc.addPage(); addHeader(doc.internal.getNumberOfPages()); y = headerOffset + 15; }
        const bothSignatures = dokument.signaturKunde && dokument.signaturAbsender;
        const sigWidth = 60, sigGap = 20;
        let xAbsender = ml;
        let xKunde = bothSignatures ? ml + sigWidth + sigGap : ml;
        
        if (dokument.signaturAbsender) {
          doc.setFontSize(9); doc.setTextColor(102, 102, 102);
          doc.text(firma.inhaberName, xAbsender, y);
          if (dokument.signaturAbsenderData) {
            try { doc.addImage(dokument.signaturAbsenderData, 'PNG', xAbsender, y + 2, sigWidth, 20); } catch(e) {}
          }
          doc.setDrawColor(51, 51, 51); doc.setLineWidth(0.3);
          doc.line(xAbsender, y + 24, xAbsender + sigWidth, y + 24);
          doc.setFontSize(8); doc.setTextColor(153, 153, 153);
          doc.text("Ort, Datum: " + (dokument.signaturAbsenderOrt || "________________") + ", " + (dokument.signaturAbsenderDatum || "________________"), xAbsender, y + 28);
        }
        
        if (dokument.signaturKunde) {
          doc.setFontSize(9); doc.setTextColor(102, 102, 102);
          doc.text("Unterschrift Kunde", xKunde, y);
          doc.setDrawColor(51, 51, 51); doc.setLineWidth(0.3);
          doc.line(xKunde, y + 24, xKunde + sigWidth, y + 24);
          doc.setFontSize(8); doc.setTextColor(153, 153, 153);
          doc.text("Ort, Datum: ________________", xKunde, y + 28);
        }
      }
      
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) { doc.setPage(i); addFooter(i, totalPages); }
      return;
    }

    // Arbeitsort
    const workText = dokument.arbeitsort || (dokument.typ === "ANGEBOT"
      ? (dokument.kunde?.strasse && dokument.kunde?.ort ? `FÃ¼r die Arbeiten in der ${dokument.kunde.strasse} in ${dokument.kunde.ort}.` : dokument.kunde?.strasse ? `FÃ¼r die Arbeiten in der ${dokument.kunde.strasse}.` : 'FÃ¼r die Arbeiten in der StraÃŸe des Kunden.')
      : (dokument.kunde?.strasse && dokument.kunde?.ort ? `FÃ¼r die ausgefÃ¼hrten Arbeiten in der ${dokument.kunde.strasse} in ${dokument.kunde.ort}.` : dokument.kunde?.strasse ? `FÃ¼r die ausgefÃ¼hrten Arbeiten in der ${dokument.kunde.strasse}.` : 'FÃ¼r die ausgefÃ¼hrten Arbeiten in der StraÃŸe des Kunden.'));
    const workLines = doc.splitTextToSize(workText, pageWidth - ml - mr);
    if (y + workLines.length * 5 > pageHeight - mb) { doc.addPage(); addHeader(doc.internal.getNumberOfPages()); y = headerOffset; }
    doc.setFontSize(10); doc.setTextColor(68, 68, 68);
    for (const ln of workLines) { doc.text(ln, ml, y); y += 5; }
    y += 4;

    // Tabelle
    let posCounter = 0;
    const tableBody = (dokument.positionen || []).map((p) => {
      let posNummer = "";
      if (!p.isUeberschrift) {
        if (p.isOptional) posNummer = "Opt.";
        else { posCounter++; posNummer = String(posCounter); }
      }
      const gesamtBetrag = (parseVal(p.menge) * parseVal(p.preis)).toFixed(2) + " â‚¬";
      const gesamtAnzeige = (p.isOptional && !p.isUeberschrift) ? `(${gesamtBetrag})` : gesamtBetrag;
      return [
        posNummer, p.name || "",
        p.isUeberschrift ? "" : (p.menge || ""),
        p.isUeberschrift ? "" : (p.einheit || ""),
        p.isUeberschrift ? "" : ((p.preis || "") + (p.preis ? " â‚¬" : "")),
        p.isUeberschrift ? "" : gesamtAnzeige
      ];
    });

    doc.autoTable({
      startY: y,
      head: [['Pos.', 'Beschreibung', 'Menge', 'Einheit', 'Einzelpreis â‚¬', 'Gesamt â‚¬']],
      body: tableBody,
      theme: 'plain',
      styles: { fontSize: 10, cellPadding: 2.8, overflow: 'linebreak', halign: 'left', lineWidth: {top: 0, right: 0, bottom: 0.1, left: 0}, lineColor: [238, 238, 238] },
      headStyles: { fillColor: false, textColor: [0, 102, 102], fontStyle: 'bold', lineWidth: {top: 0, right: 0, bottom: 0.3, left: 0}, lineColor: [0, 102, 102] },
      alternateRowStyles: { fillColor: false },
      columnStyles: { 0: { cellWidth: 14, halign: 'left' }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 22, halign: 'right' }, 3: { cellWidth: 20, halign: 'right' }, 4: { cellWidth: 30, halign: 'right' }, 5: { cellWidth: 30, halign: 'right' } },
      margin: { left: ml, right: mr, bottom: mb, top: headerOffset },
      didParseCell: (data) => {
        if (data.section === 'body' && data.row.index < (dokument.positionen || []).length) {
          const pos = (dokument.positionen || [])[data.row.index];
          if (pos?.isUeberschrift) data.cell.styles.fontStyle = 'bold';
          else if (data.column.index === 5) data.cell.styles.fontStyle = 'bold';
        }
      },
      didDrawPage: () => { addHeader(doc.internal.getCurrentPageInfo().pageNumber); }
    });

    y = doc.lastAutoTable.finalY + 14;

    // Summenblock
    let sumHeight = 28;
    if (abschlagProzent > 0) sumHeight += 18;
    if (y + sumHeight > pageHeight - mb) { doc.addPage(); addHeader(doc.internal.getCurrentPageInfo().pageNumber); y = headerOffset; }

    const sumRight = pageWidth - mr;
    const sumLeft = sumRight - 85;

    doc.setFontSize(10); doc.setDrawColor(0, 102, 102); doc.setFont("helvetica", "normal"); doc.setTextColor(17, 17, 17);
    doc.setLineWidth(0.1); doc.line(sumLeft, y - 2, sumRight, y - 2); y += 2;
    doc.text('Nettobetrag', sumLeft, y);
    doc.text(restNetto.toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
    y += 5;

    const rabattBetrag = parseVal(dokument.rabatt || "0");
    if (rabattBetrag > 0) {
      doc.setTextColor(0, 102, 102);
      doc.text(dokument.rabattBeschreibung || "Nachlass", sumLeft, y);
      doc.text(`-${rabattBetrag.toFixed(2)} â‚¬`, sumRight, y, { align: "right" });
      y += 4;
      doc.setTextColor(17, 17, 17); doc.setFont("helvetica", "bold");
      doc.setLineWidth(0.1); doc.line(sumLeft, y, sumRight, y); y += 3;
      doc.text('Zwischensumme', sumLeft, y);
      doc.text(nettoNachRabatt.toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
      y += 5; doc.setFont("helvetica", "normal");
    }

    doc.setTextColor(17, 17, 17);
    doc.text('MwSt. 19 %', sumLeft, y);
    doc.text(mwst.toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
    y += 4;

    doc.setLineWidth(0.3); doc.line(sumLeft, y - 3, sumRight, y - 3); y += 4;
    doc.setFontSize(12); doc.setFont("helvetica", "bold");
    const sumLabel = dokument.typ === "ANGEBOT" ? "Angebotssumme" : dokument.typ === "ABSCHLAGSRECHNUNG" ? "Abschlagsrechnungsbetrag" : "Rechnungsbetrag";
    doc.text(sumLabel, sumLeft, y);
    doc.text(brutto.toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
    y += 4;

    if (dokument.typ === "RECHNUNG" && parseVal(dokument.abschlagsrechnungBetrag || "0") > 0) {
      const abschlagsrechnungBetrag = parseVal(dokument.abschlagsrechnungBetrag || "0");
      doc.setTextColor(0, 102, 102); doc.setFont("helvetica", "normal"); doc.setFontSize(10); y += 2;
      doc.text('Abzgl. Abschlagsrechnung(en)', sumLeft, y);
      doc.text(`-${abschlagsrechnungBetrag.toFixed(2)} â‚¬`, sumRight, y, { align: "right" });
      y += 5; doc.setTextColor(17, 17, 17); doc.setFontSize(13); doc.setFont("helvetica", "bold");
      doc.setLineWidth(0.1); doc.line(sumLeft, y, sumRight, y); y += 4;
      doc.text('Restbetrag', sumLeft, y);
      doc.text((brutto - abschlagsrechnungBetrag).toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
      y += 2;
    }

    if (abschlagProzent > 0) {
      y += 3; doc.setTextColor(0, 102, 102); doc.setFont("helvetica", "normal"); doc.setFontSize(10);
      doc.text(`Abschlag ${abschlagProzent} %`, sumLeft, y);
      doc.text(`-${abschlagBetrag.toFixed(2)} â‚¬`, sumRight, y, { align: "right" });
      y += 3; doc.setTextColor(17, 17, 17); doc.setFontSize(13); doc.setFont("helvetica", "bold");
      doc.setLineWidth(0.1); doc.setLineDash([1, 1]); doc.line(sumLeft, y, sumRight, y); y += 2;
      doc.text('Restbetrag', sumLeft, y);
      doc.text(restBrutto.toFixed(2) + ' â‚¬', sumRight, y, { align: "right" });
      doc.setLineDash([]);
    }

    // Zahlungsbedingungen
    const stundensatz = firma.stundensatz || 59;
    const zahlungsziel = firma.zahlungsziel || 10;
    const angebotsgueltigkeit = firma.angebotsgueltigkeit || 30;
    const paymentLines = dokument.typ === "ANGEBOT" ? [
      "", (firma.angebotHinweis || "Unvorhergesehene Arbeiten werden mit {stundensatz},- â‚¬/Std. abgerechnet.").replace('{stundensatz}', stundensatz),
      "", `Dieses Angebot ist ${angebotsgueltigkeit} Tage ab Ausstellungsdatum gÃ¼ltig.`,
      "", "Wir freuen uns auf Ihre Auftragserteilung und stehen fÃ¼r RÃ¼ckfragen gerne zur VerfÃ¼gung.",
      "", "Mit freundlichen GrÃ¼ÃŸen", firma.inhaberName
    ] : [
      "", `Zahlungsbedingungen: Zahlung innerhalb von ${zahlungsziel} Tagen ab Rechnungseingang ohne AbzÃ¼ge.`,
      "", ...(dokument.rechnungshinweis ? [dokument.rechnungshinweis, ""] : []),
      "Bitte Ã¼berweisen Sie den Rechnungsbetrag unter Angabe der Rechnungsnummer auf das unten angegebene Konto.",
      "", "Mit freundlichen GrÃ¼ÃŸen", firma.inhaberName
    ];

    const maxWidth = pageWidth - ml - mr;
    const paymentWrapped = paymentLines.map(l => doc.splitTextToSize(l, maxWidth));
    const paymentHeight = paymentWrapped.reduce((acc, arr) => acc + (arr.length * 5), 0);
    if (y + paymentHeight > pageHeight - mb) { doc.addPage(); addHeader(doc.internal.getNumberOfPages()); y = headerOffset; }

    y += 5; doc.setFontSize(10); doc.setTextColor(68, 68, 68);
    for (const wrapped of paymentWrapped) {
      for (const ln of wrapped) { doc.text(ln, ml, y); y += 5; }
    }

    // Footer auf alle Seiten
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) { doc.setPage(i); addFooter(i, totalPages); }
  };

  // ============================================================
  // HAUPT-PDF-EXPORT-FUNKTION
  // ============================================================
  const createPDF = async () => {
    saveDok();
    await forceSave();
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    // Berechnungen fÃ¼r PDF
    const berechnungen = { restNetto, nettoNachRabatt, mwst, brutto, abschlagProzent, abschlagBetrag, restBrutto };
    
    // Zentralisierte Render-Funktion aufrufen
    renderPDFContent(doc, aktivesDok, firmenDaten, berechnungen);

    // Dateiname generieren
    const fullName = aktivesDok.kunde?.name || "Unbekannt";
    const cleanName = fullName.replace(/^(Herr|Herrn|Frau|FrÃ¤ulein)\s+/i, "").trim();
    const lastName = cleanName.split(" ").pop().replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼ÃŸ-]/g, "");
    const fileName = `${aktivesDok.nummer}-${lastName}.pdf`;
    
    // Share/Download Dialog
    const pdfBlob = doc.output('blob');
    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
    
    const hasShare = typeof navigator.share === 'function';
    let canShareFiles = false;
    if (navigator.canShare) {
      try { canShareFiles = navigator.canShare({ files: [file] }); } catch(e) {}
    }
    
    if (hasShare && canShareFiles) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
      overlay.innerHTML = `
        <div style="background:#1e293b;padding:30px;border-radius:15px;text-align:center;max-width:90%;color:white;">
          <h3 style="margin:0 0 10px 0;">ğŸ“„ ${fileName}</h3>
          <p style="margin:0 0 20px 0;color:#94a3b8;font-size:14px;">Wie mÃ¶chten Sie die PDF speichern?</p>
          <button id="sharePdfBtn2" style="background:#22c55e;color:white;border:none;padding:15px 40px;border-radius:10px;font-size:18px;cursor:pointer;margin:5px;min-width:140px;">ğŸ“¤ Teilen</button>
          <button id="downloadPdfBtn2" style="background:#3b82f6;color:white;border:none;padding:15px 40px;border-radius:10px;font-size:18px;cursor:pointer;margin:5px;min-width:140px;">ğŸ’¾ Download</button>
          <br><button id="cancelPdfBtn2" style="background:#64748b;color:white;border:none;padding:10px 30px;border-radius:8px;font-size:14px;cursor:pointer;margin-top:15px;">Abbrechen</button>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('#sharePdfBtn2').onclick = async () => { overlay.remove(); try { await navigator.share({ files: [file], title: fileName }); } catch (err) { if (err.name !== 'AbortError') doc.save(fileName); } };
      overlay.querySelector('#downloadPdfBtn2').onclick = () => { overlay.remove(); doc.save(fileName); };
      overlay.querySelector('#cancelPdfBtn2').onclick = () => { overlay.remove(); };
    } else {
      doc.save(fileName);
    }
  };

  return (
    <div className="app-container flex flex-col md:flex-row h-screen md:overflow-hidden">
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * MOBILE HEADER - Sichtbar wenn Sidebar nicht permanent angezeigt wird
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div className="mobile-header fixed left-0 right-0 z-50 bg-slate-900/95 backdrop-blur border-b border-slate-700 px-2 py-1 flex items-center" style={{ top: '0', paddingTop: 'calc(env(safe-area-inset-top, 0px) + 4px)', paddingLeft: 'calc(env(safe-area-inset-left, 0px) + 8px)' }}>
        {/* Hamburger-MenÃ¼ - feste Breite */}
        <button
          onClick={() => setSidebarOpen(!sidebarOpen)}
          className="text-white p-2 rounded hover:bg-slate-700 flex-shrink-0"
          title="MenÃ¼"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={sidebarOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16"} />
          </svg>
        </button>
        
        {/* Leerraum in der Mitte */}
        <span className="flex-1"></span>
        
        {/* Status-Icons - flex-shrink-0 verhindert Kompression */}
        <div className="flex items-center gap-2 flex-shrink-0">
          {/* Cloud-Status */}
          {cloudConfig.enabled && (
            <div className="relative" title={syncStatus === 'idle' ? 'Cloud bereit' : syncStatus === 'uploading' ? 'Synchronisiere...' : syncStatus === 'success' ? 'Cloud-Sync OK' : 'Cloud-Fehler'}>
              {syncStatus === 'idle' && <span className="text-slate-500 text-lg">â˜ï¸</span>}
              {syncStatus === 'uploading' && <span className="text-purple-400 text-lg animate-spin">âŸ³</span>}
              {syncStatus === 'success' && <span className="text-green-400 text-lg">â˜ï¸</span>}
              {syncStatus === 'error' && <span className="text-red-400 text-lg">â˜ï¸</span>}
            </div>
          )}
          
          {/* Save-Status */}
          <div className={`w-2.5 h-2.5 rounded-full ${
            saveStatus === 'saved' ? 'bg-green-500' : 
            saveStatus === 'pending' ? 'bg-orange-500 animate-pulse' : 
            saveStatus === 'saving' ? 'bg-blue-500 animate-ping' : 
            'bg-red-500'
          }`} />
          
          {/* Logout-Button */}
          <button
            onClick={async () => {
              if (saveStatus === 'pending' || saveStatus === 'saving') {
                if (!confirm('Ã„nderungen werden noch gespeichert. Trotzdem ausloggen?')) return;
              }
              await lockVault();
            }}
            className="text-slate-400 hover:text-red-400 p-1"
            title="Vault sperren"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </button>
        </div>
      </div>
      
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * DESKTOP STATUS BAR - Nur auf Desktop sichtbar (oben rechts)
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div className="hidden md:flex fixed top-4 right-4 z-50 items-center gap-3">
        {/* Cloud-Status */}
        {cloudConfig.enabled && (
          <div className="flex items-center gap-2 bg-slate-800/90 backdrop-blur px-3 py-2 rounded-lg border border-slate-700" title={syncStatus === 'idle' ? 'Cloud bereit' : syncStatus === 'uploading' ? 'Synchronisiere...' : syncStatus === 'success' ? 'Cloud-Sync OK' : 'Cloud-Fehler'}>
            {syncStatus === 'idle' && <span className="text-slate-400 text-sm">â˜ï¸ Bereit</span>}
            {syncStatus === 'uploading' && <span className="text-purple-400 text-sm animate-pulse">âŸ³ Sync...</span>}
            {syncStatus === 'success' && <span className="text-green-400 text-sm">â˜ï¸ âœ“</span>}
            {syncStatus === 'error' && <span className="text-red-400 text-sm">â˜ï¸ âœ—</span>}
          </div>
        )}
        
        {/* Status-Indikator (Ampel) */}
        <div className="flex items-center gap-2 bg-slate-800/90 backdrop-blur px-3 py-2 rounded-lg border border-slate-700" title={saveStatus === 'saved' ? 'Alle Ã„nderungen gespeichert' : saveStatus === 'pending' ? 'Ã„nderungen werden gespeichert...' : saveStatus === 'saving' ? 'Speichert...' : 'Fehler beim Speichern'}>
          {saveStatus === 'saved' && (
            <>
              <span className="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
              <span className="text-green-400 text-xs font-medium">âœ“ Gespeichert</span>
            </>
          )}
          {saveStatus === 'pending' && (
            <>
              <span className="w-3 h-3 rounded-full bg-orange-500 animate-pulse"></span>
              <span className="text-orange-400 text-xs font-medium">â— Ã„nderungen...</span>
            </>
          )}
          {saveStatus === 'saving' && (
            <>
              <span className="w-3 h-3 rounded-full bg-blue-500 animate-spin"></span>
              <span className="text-blue-400 text-xs font-medium">â†» Speichert...</span>
            </>
          )}
          {saveStatus === 'error' && (
            <>
              <span className="w-3 h-3 rounded-full bg-red-500"></span>
              <span className="text-red-400 text-xs font-medium">âœ— Fehler</span>
            </>
          )}
        </div>
        
        {/* Logout-Button (Schloss) */}
        <button
          onClick={async () => {
            if (saveStatus === 'pending' || saveStatus === 'saving') {
              if (!confirm('Ã„nderungen werden noch gespeichert. Trotzdem ausloggen?')) return;
            }
            await lockVault();
          }}
          className="bg-slate-800/90 backdrop-blur hover:bg-red-700 text-white p-2 rounded-lg border border-slate-700 hover:border-red-600 transition-colors"
          title="Vault sperren (Logout)"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </button>
      </div>
      
      {/* Sidebar Backdrop fÃ¼r Mobile */}
      <div className={`sidebar-backdrop ${sidebarOpen ? 'open' : ''}`} onClick={() => setSidebarOpen(false)}></div>
      
      <div className={`sidebar w-full md:w-96 bg-slate-900 text-white p-4 pt-16 md:pt-4 pb-24 md:pb-4 no-print flex flex-col shadow-2xl border-r border-teal-900 ${sidebarOpen ? 'open' : ''}`}>
        {/* Home-Button + Einstellungen */}
        <div className="flex items-center gap-2 mb-4 border-b border-slate-700 pb-4">
          <button 
            onClick={() => setActiveModule('dashboard')} 
            className="flex-1 text-left p-2 text-slate-400 hover:text-white flex items-center gap-2"
          >
            <span className="text-xl">ğŸ </span>
            <span className="font-bold uppercase tracking-wider text-xs">Startseite</span>
          </button>
          <button 
            onClick={() => setActiveModule('settings')} 
            className={`p-2 rounded-lg transition-all ${activeModule === 'settings' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
            title="Einstellungen"
          >
            âš™ï¸
          </button>
        </div>

        {/* Modul-Navigation */}
        <div className="flex gap-2 mb-4">
          <button 
            onClick={() => setActiveModule('rechnung')} 
            className={`flex-1 py-3 rounded-lg font-bold text-sm transition-all ${activeModule === 'rechnung' ? 'bg-teal-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
          >
            ğŸ“„ Dokumente
          </button>
          <button 
            onClick={() => setActiveModule('zeit')} 
            className={`flex-1 py-3 rounded-lg font-bold text-sm transition-all ${activeModule === 'zeit' ? 'bg-orange-500 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
          >
            â±ï¸ Zeiterfassung
          </button>
        </div>
        
        {/* Rechnungs-Modul Tabs */}
        {activeModule === 'rechnung' && (
        <>
        <div className="flex gap-1 mb-4 bg-slate-800 p-1 rounded text-[10px] font-bold uppercase flex-wrap">
          <button onClick={() => { setActiveTab("material"); setSuchTerm(""); }} className={`flex-1 py-2 rounded ${activeTab === "material" ? "bg-teal-600" : ""}`}>Positionen</button>
          <button onClick={() => { setActiveTab("kunden"); setSuchTerm(""); }} className={`flex-1 py-2 rounded ${activeTab === "kunden" ? "bg-teal-600" : ""}`}>Kunden</button>
          <button onClick={() => { setActiveTab("dokumente"); setSuchTerm(""); }} className={`flex-1 py-2 rounded ${activeTab === "dokumente" ? "bg-teal-600" : ""}`}>Dokumente</button>
          <button onClick={() => { setActiveTab("neu"); setSuchTerm(""); }} className={`flex-1 py-2 rounded ${activeTab === "neu" ? "bg-teal-600" : ""}`}>+ Neu</button>
          <button onClick={() => { setActiveTab("einstellungen"); setSuchTerm(""); }} className={`flex-1 py-2 rounded ${activeTab === "einstellungen" ? "bg-teal-600" : ""}`}>âš™ï¸</button>
        </div>

        <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4">
          {activeTab === "material" && (
            <>
              <h3 className="text-teal-400 font-bold uppercase text-xs mb-2">Positionen</h3>
              {successMessage && (
                <div style={{ backgroundColor: '#10b981', color: 'white', padding: '8px 12px', borderRadius: '4px', marginBottom: '12px', fontSize: '11px', fontWeight: 'bold', textAlign: 'center' }}>
                  {successMessage}
                </div>
              )}
              <input type="text" placeholder="Suchen..." className="w-full p-2 text-black text-xs rounded outline-none" value={suchTerm} onChange={e => setSuchTerm(e.target.value)} />
              {db.material.filter(m => (m.Name || "").toLowerCase().includes(suchTerm.toLowerCase())).map((m, i) => (
                <div key={m.id || i} className="p-2 bg-slate-800 rounded border border-slate-700 text-[10px] group">
                  <input className="bg-transparent text-teal-300 font-bold w-full outline-none" value={m.Name} onChange={e => updateStamm('material', m.id, 'Name', e.target.value)} />
                  <div className="flex justify-between mt-1 items-center">
                    <div className="flex gap-1 text-slate-400 italic">
                      <input className="bg-slate-700 w-16 px-1 rounded text-white" value={m.Verkaufspreis} onChange={e => updateStamm('material', m.id, 'Verkaufspreis', e.target.value)} /> â‚¬
                      <input className="bg-slate-700 w-10 px-1 rounded uppercase text-white" value={m.Einheit} onChange={e => updateStamm('material', m.id, 'Einheit', e.target.value)} />
                    </div>
                    <button onClick={() => { addPos(m); setClickedMaterial(m.id); setTimeout(() => setClickedMaterial(null), 300); }} className={`px-3 py-1 rounded font-bold uppercase text-xs transition-colors ${clickedMaterial === m.id ? 'bg-green-500 scale-95' : 'bg-teal-600'}`} style={{transform: clickedMaterial === m.id ? 'scale(0.95)' : 'scale(1)', transition: 'all 0.1s ease'}}>ADD</button>
                  </div>
                </div>
              ))}
            </>
          )}

          {activeTab === "kunden" && (
            <>
              <h3 className="text-teal-400 font-bold uppercase text-xs mb-2">Kunden</h3>
              <input type="text" placeholder="Kunden suchen..." className="w-full p-2 text-black text-xs rounded outline-none" value={suchTerm} onChange={e => setSuchTerm(e.target.value)} />
              {db.kunden.filter(k => (k.Organisation || k.name || "").toLowerCase().includes(suchTerm.toLowerCase())).map((k, i) => {
                const displayName = korrigiereName(k.Organisation || k.name || "", !!k.Organisation);
                return (
                <div key={k.id || i} className="p-3 bg-slate-800 rounded border border-slate-700 text-[10px] space-y-2">
                  <div className="flex justify-between items-center">
                    <select value={k.anrede} onChange={e => updateStamm('kunden', k.id, 'anrede', e.target.value)} className="bg-slate-700 text-teal-300 rounded px-1 outline-none font-bold">
                      <option value="Organisation">Organisation</option>
                      <option value="Herr">Herr</option>
                      <option value="Frau">Frau</option>
                    </select>
                    <button onClick={() => deleteKunde(k)} className="px-2 py-1 rounded text-xs text-slate-500 hover:text-red-400 transition-colors">ğŸ—‘ï¸</button>
                  </div>
                  <input className="bg-transparent text-white font-bold w-full outline-none text-xs border-b border-slate-700" placeholder="Name / Firma" value={displayName} onChange={e => updateStamm('kunden', k.id, 'Organisation', e.target.value)} />
                  <input className="bg-slate-700 text-white w-full outline-none text-xs rounded px-2 py-1" placeholder="StraÃŸe" value={k.Strasse || k.strasse || ""} onChange={e => updateStamm('kunden', k.id, 'Strasse', e.target.value)} />
                  <div className="flex gap-2">
                    <input className="bg-slate-700 text-white w-1/3 outline-none text-xs rounded px-2 py-1" placeholder="PLZ" value={k.PLZ || k.plz || ""} onChange={e => updateStamm('kunden', k.id, 'PLZ', e.target.value)} />
                    <input className="bg-slate-700 text-white w-2/3 outline-none text-xs rounded px-2 py-1" placeholder="Ort" value={k.Ort || k.ort || ""} onChange={e => updateStamm('kunden', k.id, 'Ort', e.target.value)} />
                  </div>
                  <button onClick={() => { waehleKunde(k); setClickedKunde(k.id); setTimeout(() => { setClickedKunde(null); setSidebarOpen(false); }, 300); }} className={`w-full py-1.5 rounded font-bold uppercase text-xs transition-colors ${clickedKunde === k.id ? 'bg-green-500 scale-95' : 'bg-teal-600'}`} style={{transform: clickedKunde === k.id ? 'scale(0.95)' : 'scale(1)', transition: 'all 0.1s ease'}}>WÃ¤hlen</button>
                </div>
              );})}
            </>
          )}

          {activeTab === "dokumente" && (
            <>
              <h3 className="text-teal-400 font-bold uppercase text-xs mb-2">Dokumente</h3>
              <input 
                type="text" 
                placeholder="Dokumente suchen (Nummer, Kunde, Datum)..." 
                className="w-full p-2 text-black text-xs rounded outline-none" 
                value={dokSuchTerm} 
                onChange={e => setDokSuchTerm(e.target.value)} 
              />
              <div className="flex gap-2 mb-2 mt-3">
                <select value={belegSort} onChange={e => setBelegSort(e.target.value)} className="bg-slate-700 text-white rounded px-2 py-1 text-xs">
                  <option value="datum-desc">Datum (neueste zuerst)</option>
                  <option value="datum-asc">Datum (Ã¤lteste zuerst)</option>
                  <option value="nummer-desc">Nummer (neueste zuerst)</option>
                  <option value="nummer-asc">Nummer (Ã¤lteste zuerst)</option>
                </select>
                <button onClick={() => setMusterFilter(!musterFilter)} className={`px-3 py-1 rounded text-xs font-bold ${musterFilter ? "bg-purple-600" : "bg-slate-700"}`}>
                  {musterFilter ? "Muster aus" : "Nur Muster"}
                </button>
              </div>
              <div className="flex gap-2 mb-2">
                <button onClick={() => setDokTypFilter("alle")} className={`flex-1 px-3 py-1 rounded text-xs font-bold ${dokTypFilter === "alle" ? "bg-teal-600" : "bg-slate-700"}`}>
                  Alle
                </button>
                <button onClick={() => setDokTypFilter("angebote")} className={`flex-1 px-3 py-1 rounded text-xs font-bold ${dokTypFilter === "angebote" ? "bg-blue-600" : "bg-slate-700"}`}>
                  Angebote
                </button>
                <button onClick={() => setDokTypFilter("rechnungen")} className={`flex-1 px-3 py-1 rounded text-xs font-bold ${dokTypFilter === "rechnungen" ? "bg-green-600" : "bg-slate-700"}`}>
                  Rechnungen
                </button>
                <button onClick={() => setDokTypFilter("leer")} className={`flex-1 px-3 py-1 rounded text-xs font-bold ${dokTypFilter === "leer" ? "bg-purple-600" : "bg-slate-700"}`}>
                  Leer
                </button>
                <button onClick={() => setDokTypFilter("entwuerfe")} className={`flex-1 px-3 py-1 rounded text-xs font-bold ${dokTypFilter === "entwuerfe" ? "bg-orange-600" : "bg-slate-700"}`}>
                  EntwÃ¼rfe {(appState.entwuerfe?.length || 0) > 0 && `(${appState.entwuerfe.length})`}
                </button>
              </div>
              
              {/* EntwÃ¼rfe-Ansicht */}
              {dokTypFilter === "entwuerfe" ? (
                <>
                  {(appState.entwuerfe?.length || 0) > 0 ? (
                    appState.entwuerfe.map(entwurf => (
                      <div key={entwurf.entwurfId} className="p-3 bg-slate-800 rounded border-2 border-orange-500 text-xs mb-2">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="text-orange-400 font-bold text-sm">âš ï¸ ENTWURF</span>
                          {entwurf.entwurfId === aktivesDok.entwurfId && (
                            <span className="text-xs bg-green-600 px-2 py-0.5 rounded">AKTIV</span>
                          )}
                        </div>
                        <div className="text-slate-300 mb-1">
                          <span className="text-slate-500">Typ:</span> {entwurf.typ || 'Unbekannt'}
                        </div>
                        <div className="text-slate-300 mb-1">
                          <span className="text-slate-500">Kunde:</span> {entwurf.kunde?.name || 'Kein Kunde'}
                        </div>
                        <div className="text-slate-300 mb-1">
                          <span className="text-slate-500">Datum:</span> {entwurf.datum || 'Kein Datum'}
                        </div>
                        <div className="text-slate-300 mb-3">
                          <span className="text-slate-500">Positionen:</span> {entwurf.positionen?.length || 0}
                        </div>
                        <div className="flex gap-2">
                          <button 
                            onClick={() => setAktivesDok(entwurf)} 
                            className="flex-1 bg-orange-600 hover:bg-orange-500 px-3 py-2 rounded font-bold uppercase text-xs"
                            disabled={entwurf.entwurfId === aktivesDok.entwurfId}
                          >
                            ğŸ“ {entwurf.entwurfId === aktivesDok.entwurfId ? 'Wird bearbeitet' : 'Laden'}
                          </button>
                          <button 
                            onClick={() => {
                              if (confirm('Entwurf wirklich verwerfen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) {
                                // Entwurf aus Liste entfernen
                                updateState(prev => ({
                                  ...prev,
                                  entwuerfe: (prev.entwuerfe || []).filter(e => e.entwurfId !== entwurf.entwurfId)
                                }));
                                // Wenn der aktive Entwurf gelÃ¶scht wird, neues leeres Dokument erstellen
                                if (entwurf.entwurfId === aktivesDok.entwurfId) {
                                  newDok();
                                }
                              }
                            }} 
                            className="bg-red-600 hover:bg-red-500 px-3 py-2 rounded font-bold uppercase text-xs"
                          >
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <p className="text-slate-500 text-xs italic mt-2">Keine offenen EntwÃ¼rfe vorhanden.</p>
                  )}
                </>
              ) : (
                <>
                  {/* Normale Dokumentenliste */}
                  {sortedRechnungen.length === 0 && <p className="text-slate-500 text-xs italic">Keine Belege gefunden.</p>}
                  {sortedRechnungen.map(d => (
                    <div key={d.id} className="p-3 bg-slate-800 rounded border border-slate-700 text-xs hover:bg-slate-700 flex flex-col gap-1">
                      <div className="flex justify-between items-center">
                        <div className="cursor-pointer flex-1" onClick={() => loadDok(d)}>
                          <div className={`font-bold ${d.typ === "RECHNUNG" ? "text-green-400" : d.typ === "ANGEBOT" ? "text-blue-400" : d.typ === "ABSCHLAGSRECHNUNG" ? "text-orange-400" : d.typ === "LEERES_DOKUMENT" ? "text-purple-400" : "text-yellow-400"}`}>
                            {d.typ === "LEERES_DOKUMENT" ? "LEERES DOK." : d.typ} {d.nummer} {d.muster ? "(Muster)" : ""}
                          </div>
                          <div className="text-slate-400 text-[11px]">
                            {d.datum} â€“ {d.kunde.name || "Kein Kunde"}
                          </div>
                        </div>
                      </div>
                      <div className="flex gap-2 mt-1">
                        {d.muster ? (
                          <button onClick={e => { e.stopPropagation(); removeMuster(d); }} className="bg-orange-600 hover:bg-orange-500 px-2 py-1 rounded font-bold uppercase text-xs flex-1">
                            Von Muster entfernen
                          </button>
                        ) : (
                          <button onClick={e => { e.stopPropagation(); copyAsMuster(d); }} className="bg-purple-600 hover:bg-purple-500 px-2 py-1 rounded font-bold uppercase text-xs flex-1">
                            Als Muster speichern
                          </button>
                        )}
                        <button onClick={e => { e.stopPropagation(); deleteDok(d); }} className="px-2 py-1 rounded text-xs text-slate-500 hover:text-red-400 transition-colors">
                          ğŸ—‘ï¸
                        </button>
                      </div>
                    </div>
                  ))}
                </>
              )}
            </>
          )}

          {activeTab === "neu" && (
            <div className="space-y-6">
              <div className="bg-slate-800 p-4 rounded border border-teal-900">
                <p className="font-bold text-teal-400 uppercase mb-2 text-xs">Neuer Kunde</p>
                <select value={neuKunde.anrede} onChange={e => setNeuKunde({...neuKunde, anrede: e.target.value})} className="w-full p-2 bg-slate-700 text-white rounded mb-2 text-xs">
                  <option value="Organisation">Organisation</option>
                  <option value="Herr">Herr</option>
                  <option value="Frau">Frau</option>
                </select>
                <input type="text" placeholder="Name / Firma" className="w-full p-2 text-black rounded mb-2 text-xs" value={neuKunde.name} onChange={e => setNeuKunde({...neuKunde, name: e.target.value})} />
                <input type="text" placeholder="StraÃŸe" className="w-full p-2 text-black rounded mb-2 text-xs" value={neuKunde.strasse} onChange={e => setNeuKunde({...neuKunde, strasse: e.target.value})} />
                <div className="flex gap-2">
                  <input type="text" placeholder="PLZ" className="w-1/3 p-2 text-black rounded text-xs" value={neuKunde.plz} onChange={e => setNeuKunde({...neuKunde, plz: e.target.value})} />
                  <input type="text" placeholder="Ort" className="w-2/3 p-2 text-black rounded text-xs" value={neuKunde.ort} onChange={e => setNeuKunde({...neuKunde, ort: e.target.value})} />
                </div>
                <button onClick={() => {
                  const k = { ...neuKunde, id: Date.now() };
                  saveToDB({ ...db, kunden: [k, ...db.kunden] });
                  waehleKunde(k);
                  setNeuKunde({ anrede: "Organisation", name: "", strasse: "", plz: "", ort: "" });
                }} className="mt-2 w-full bg-teal-600 py-2 rounded font-bold uppercase text-xs">
                  Kunde Speichern
                </button>
              </div>

              <div className="bg-slate-800 p-4 rounded border border-teal-900">
                <p className="font-bold text-teal-400 uppercase mb-2 text-xs">Neue Position</p>
                <input type="text" placeholder="Materialname" className="w-full p-2 text-black rounded mb-2 text-xs" value={neuMat.name} onChange={e => setNeuMat({...neuMat, name: e.target.value})} />
                <div className="flex gap-2">
                  <input type="text" placeholder="Einheit" className="w-1/2 p-2 text-black rounded text-xs" value={neuMat.einheit} onChange={e => setNeuMat({...neuMat, einheit: e.target.value})} />
                  <input type="text" placeholder="Preis â‚¬" className="w-1/2 p-2 text-black rounded text-xs" value={neuMat.preis} onChange={e => setNeuMat({...neuMat, preis: e.target.value})} />
                </div>
                <button onClick={() => {
                  const m = { Name: neuMat.name, Einheit: neuMat.einheit, Verkaufspreis: neuMat.preis.replace(',', '.'), id: Date.now() };
                  saveToDB({ ...db, material: [m, ...db.material] });
                  setNeuMat({ name: "", einheit: "Stk", preis: "0,00" });
                }} className="mt-2 w-full bg-teal-600 py-2 rounded font-bold uppercase text-xs">
                  Material Speichern
                </button>
              </div>
            </div>
          )}

          {activeTab === "einstellungen" && (
            <div className="space-y-4">
              <p className="font-bold text-teal-400 uppercase text-xs mb-2">âš™ï¸ Firmeneinstellungen</p>
              
              {/* Logo Upload */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="text-xs text-slate-400 mb-2">Logo</p>
                <div className="flex items-center gap-2 mb-2">
                  {firmenDaten.logo && (
                    <img src={firmenDaten.logo} alt="Logo" style={{ maxHeight: '40px', maxWidth: '100px' }} />
                  )}
                  <button onClick={() => logoInputRef.current?.click()} className="bg-teal-600 px-3 py-1 rounded text-xs">
                    {firmenDaten.logo ? 'Ã„ndern' : 'Hochladen'}
                  </button>
                  {firmenDaten.logo && (
                    <button onClick={() => saveFirmenDaten({...firmenDaten, logo: ''})} className="bg-red-600 px-2 py-1 rounded text-xs">âœ•</button>
                  )}
                  <input ref={logoInputRef} type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                </div>
                <p className="text-xs text-slate-400 mb-1">Position:</p>
                <div className="flex gap-2 mb-2">
                  {['links', 'mitte', 'rechts'].map(pos => (
                    <button key={pos} onClick={() => saveFirmenDaten({...firmenDaten, logoPosition: pos})} 
                      className={`px-3 py-1 rounded text-xs ${firmenDaten.logoPosition === pos ? 'bg-teal-600' : 'bg-slate-700'}`}>
                      {pos.charAt(0).toUpperCase() + pos.slice(1)}
                    </button>
                  ))}
                </div>
                <p className="text-xs text-slate-400 mb-1">GrÃ¶ÃŸe (mm):</p>
                <div className="flex gap-2">
                  <div className="flex-1">
                    <label className="text-xs text-slate-500">Breite</label>
                    <input type="number" className="w-full p-2 text-black rounded text-xs" 
                      value={firmenDaten.logoBreite || 40} 
                      onChange={e => saveFirmenDaten({...firmenDaten, logoBreite: parseInt(e.target.value) || 40})} />
                  </div>
                  <div className="flex-1">
                    <label className="text-xs text-slate-500">HÃ¶he</label>
                    <input type="number" className="w-full p-2 text-black rounded text-xs" 
                      value={firmenDaten.logoHoehe || 15} 
                      onChange={e => saveFirmenDaten({...firmenDaten, logoHoehe: parseInt(e.target.value) || 15})} />
                  </div>
                </div>
              </div>

              {/* Firmenname & Farben */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="text-xs text-slate-400 mb-1">Firmenname</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.firmenname} onChange={e => saveFirmenDaten({...firmenDaten, firmenname: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">PrimÃ¤rfarbe (Ãœberschriften)</p>
                <div className="flex gap-2 items-center mb-2">
                  <input type="color" value={firmenDaten.primaerFarbe} onChange={e => saveFirmenDaten({...firmenDaten, primaerFarbe: e.target.value})} className="w-10 h-8 rounded cursor-pointer" />
                  <input type="text" className="flex-1 p-2 text-black rounded text-xs" value={firmenDaten.primaerFarbe} onChange={e => saveFirmenDaten({...firmenDaten, primaerFarbe: e.target.value})} />
                </div>
                <p className="text-xs text-slate-400 mb-1">Briefkopf-Farbe (Absender)</p>
                <div className="flex gap-2 items-center mb-2">
                  <input type="color" value={firmenDaten.briefkopfFarbe || '#444444'} onChange={e => saveFirmenDaten({...firmenDaten, briefkopfFarbe: e.target.value})} className="w-10 h-8 rounded cursor-pointer" />
                  <input type="text" className="flex-1 p-2 text-black rounded text-xs" value={firmenDaten.briefkopfFarbe || '#444444'} onChange={e => saveFirmenDaten({...firmenDaten, briefkopfFarbe: e.target.value})} />
                </div>
                <p className="text-xs text-slate-400 mb-1">Briefkopf-Absender</p>
                <div className="flex gap-2">
                  <button 
                    onClick={() => saveFirmenDaten({...firmenDaten, briefkopfAbsender: 'inhaber'})}
                    className={`flex-1 py-2 rounded text-xs ${firmenDaten.briefkopfAbsender !== 'firmenname' ? 'bg-teal-600' : 'bg-slate-700'}`}
                  >Inhaber</button>
                  <button 
                    onClick={() => saveFirmenDaten({...firmenDaten, briefkopfAbsender: 'firmenname'})}
                    className={`flex-1 py-2 rounded text-xs ${firmenDaten.briefkopfAbsender === 'firmenname' ? 'bg-teal-600' : 'bg-slate-700'}`}
                  >Firmenname</button>
                </div>
              </div>

              {/* Adresse */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="text-xs text-slate-400 mb-1">Inhaber</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.inhaberName} onChange={e => saveFirmenDaten({...firmenDaten, inhaberName: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">StraÃŸe</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.strasse} onChange={e => saveFirmenDaten({...firmenDaten, strasse: e.target.value})} />
                <div className="flex gap-2">
                  <div className="w-1/3">
                    <p className="text-xs text-slate-400 mb-1">PLZ</p>
                    <input type="text" className="w-full p-2 text-black rounded text-xs" 
                      value={firmenDaten.plz} onChange={e => saveFirmenDaten({...firmenDaten, plz: e.target.value})} />
                  </div>
                  <div className="w-2/3">
                    <p className="text-xs text-slate-400 mb-1">Ort</p>
                    <input type="text" className="w-full p-2 text-black rounded text-xs" 
                      value={firmenDaten.ort} onChange={e => saveFirmenDaten({...firmenDaten, ort: e.target.value})} />
                  </div>
                </div>
                <p className="text-xs text-slate-400 mb-1 mt-2">Land</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs" 
                  value={firmenDaten.land} onChange={e => saveFirmenDaten({...firmenDaten, land: e.target.value})} />
              </div>

              {/* Kontakt */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="text-xs text-slate-400 mb-1">Telefon</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.telefon} onChange={e => saveFirmenDaten({...firmenDaten, telefon: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">E-Mail</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.email} onChange={e => saveFirmenDaten({...firmenDaten, email: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">Website</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs" 
                  value={firmenDaten.website} onChange={e => saveFirmenDaten({...firmenDaten, website: e.target.value})} />
              </div>

              {/* Steuer & Bank */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="text-xs text-slate-400 mb-1">Steuernummer</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.steuernummer} onChange={e => saveFirmenDaten({...firmenDaten, steuernummer: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">Bank</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.bankName} onChange={e => saveFirmenDaten({...firmenDaten, bankName: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">IBAN</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.iban} onChange={e => saveFirmenDaten({...firmenDaten, iban: e.target.value})} />
                <p className="text-xs text-slate-400 mb-1">BIC</p>
                <input type="text" className="w-full p-2 text-black rounded text-xs" 
                  value={firmenDaten.bic} onChange={e => saveFirmenDaten({...firmenDaten, bic: e.target.value})} />
              </div>

              {/* Zahlungsbedingungen */}
              <div className="bg-slate-800 p-3 rounded border border-teal-900">
                <p className="font-bold text-teal-400 uppercase text-xs mb-2">Zahlungsbedingungen</p>
                <p className="text-xs text-slate-400 mb-1">Zahlungsziel (Tage)</p>
                <input type="number" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.zahlungsziel || 10} onChange={e => saveFirmenDaten({...firmenDaten, zahlungsziel: parseInt(e.target.value) || 10})} />
                <p className="text-xs text-slate-400 mb-1">AngebotsgÃ¼ltigkeit (Tage)</p>
                <input type="number" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.angebotsgueltigkeit || 30} onChange={e => saveFirmenDaten({...firmenDaten, angebotsgueltigkeit: parseInt(e.target.value) || 30})} />
                <p className="text-xs text-slate-400 mb-1">Stundensatz (â‚¬)</p>
                <input type="number" className="w-full p-2 text-black rounded text-xs mb-2" 
                  value={firmenDaten.stundensatz || 59} onChange={e => saveFirmenDaten({...firmenDaten, stundensatz: parseInt(e.target.value) || 59})} />
                <p className="text-xs text-slate-400 mb-1">Angebots-Hinweistext <span className="text-slate-500">(verwende {'{stundensatz}'} als Platzhalter)</span></p>
                <textarea className="w-full p-2 text-black rounded text-xs" rows="2"
                  value={firmenDaten.angebotHinweis || "Unvorhergesehene Arbeiten werden mit {stundensatz},- â‚¬/Std. abgerechnet."}
                  onChange={e => saveFirmenDaten({...firmenDaten, angebotHinweis: e.target.value})} />
              </div>
              
              {/* CSV-Import */}
              <div className="bg-slate-800 p-3 rounded border border-blue-900">
                <p className="font-bold text-blue-400 uppercase text-xs mb-3">ğŸ“¥ CSV-Import</p>
                <p className="text-xs text-slate-500 mb-2">Importiert Kunden oder Artikel aus CSV-Dateien. Spalten werden automatisch erkannt.</p>
                <label className="block w-full bg-blue-700 hover:bg-blue-600 py-2 rounded font-bold uppercase text-xs text-center cursor-pointer">
                  ğŸ“„ CSV-Datei auswÃ¤hlen
                  <input 
                    type="file" 
                    accept=".csv,.txt" 
                    className="hidden" 
                    onChange={async (e) => {
                      const file = e.target.files[0];
                      if (!file) return;
                      e.target.value = '';
                      
                      const loading = showLoadingDialog('ğŸ“„ Lese CSV-Datei...');
                      
                      try {
                        const text = await file.text();
                        const { headers, rows, delimiter } = parseCSV(text);
                        
                        if (rows.length === 0) {
                          loading.close();
                          alert('Die CSV-Datei ist leer oder hat ein ungÃ¼ltiges Format.');
                          return;
                        }
                        
                        const detectedType = detectCSVType(headers);
                        loading.updateMessage(`ğŸ” Erkannt: ${detectedType === 'kunden' ? 'Kundendaten' : detectedType === 'material' ? 'Artikeldaten' : 'Unbekannt'}`);
                        
                        loading.close();
                        
                        // Benutzer fragen
                        const userChoice = prompt(
                          `ğŸ“Š CSV-Import\n\n` +
                          `Gefunden: ${rows.length} Zeilen\n` +
                          `Trennzeichen: "${delimiter}"\n` +
                          `Erkannter Typ: ${detectedType === 'kunden' ? 'Kunden' : detectedType === 'material' ? 'Artikel/Material' : 'Nicht eindeutig'}\n\n` +
                          `Spalten: ${headers.slice(0, 5).join(', ')}${headers.length > 5 ? '...' : ''}\n\n` +
                          `Als was importieren?\n` +
                          `1 = Kunden\n` +
                          `2 = Material/Artikel\n` +
                          `0 = Abbrechen`,
                          detectedType === 'kunden' ? '1' : detectedType === 'material' ? '2' : '0'
                        );
                        
                        if (!userChoice || userChoice === '0') return;
                        
                        let importedItems = [];
                        let targetField = '';
                        
                        if (userChoice === '1') {
                          importedItems = mapCSVToKunden(rows, headers);
                          targetField = 'kunden';
                        } else if (userChoice === '2') {
                          importedItems = mapCSVToMaterial(rows, headers);
                          targetField = 'material';
                        } else {
                          alert('UngÃ¼ltige Auswahl');
                          return;
                        }
                        
                        if (importedItems.length === 0) {
                          alert('Keine gÃ¼ltigen EintrÃ¤ge gefunden. PrÃ¼fen Sie das CSV-Format.');
                          return;
                        }
                        
                        // Vorschau der ersten 3 EintrÃ¤ge
                        const preview = importedItems.slice(0, 3).map(item => 
                          targetField === 'kunden' 
                            ? `â€¢ ${item.name} (${item.plz} ${item.ort})`
                            : `â€¢ ${item.name} - ${item.preis}â‚¬/${item.einheit}`
                        ).join('\n');
                        
                        if (!confirm(`${importedItems.length} ${targetField === 'kunden' ? 'Kunden' : 'Positionen'} importieren?\n\nVorschau:\n${preview}${importedItems.length > 3 ? '\n...' : ''}`)) return;
                        
                        // Import durchfÃ¼hren
                        updateState(prev => ({
                          ...prev,
                          [targetField]: [...prev[targetField], ...importedItems]
                        }));
                        
                        await forceSave();
                        alert(`âœ… ${importedItems.length} ${targetField === 'kunden' ? 'Kunden' : 'Positionen'} erfolgreich importiert!`);
                        
                      } catch (err) {
                        loading.close();
                        console.error('CSV-Import Fehler:', err);
                        alert('Fehler beim CSV-Import: ' + err.message);
                      }
                    }}
                  />
                </label>
                <p className="text-xs text-slate-600 mt-2">UnterstÃ¼tzt: Komma (,) und Semikolon (;) als Trennzeichen</p>
              </div>
              
              {/* Stammdaten Export */}
              <div className="bg-slate-800 p-3 rounded border border-blue-900">
                <p className="font-bold text-blue-400 uppercase text-xs mb-2">ğŸ“¦ Stammdaten Export</p>
                <p className="text-xs text-slate-500 mb-2">Exportiert Kunden, Positionen und Einstellungen (ohne Rechnungen/Angebote).</p>
                <button 
                  onClick={exportStammdatenFile}
                  className="w-full bg-blue-700 hover:bg-blue-600 py-2 rounded font-bold uppercase text-xs"
                >
                  ğŸ“¦ Stammdaten exportieren
                </button>
              </div>
              
              {/* Cloud-Sync Einstellungen */}
              <div className="bg-slate-800 p-3 rounded border border-purple-900">
                <p className="font-bold text-purple-400 uppercase text-xs mb-3">â˜ï¸ Cloud-Sync (Hybrid-Backup)</p>
                <p className="text-xs text-slate-500 mb-3">
                  Synchronisiert deine verschlÃ¼sselten Daten automatisch in die Cloud. Die Daten bleiben Ende-zu-Ende verschlÃ¼sselt.
                </p>
                
                {/* Status-Anzeige */}
                <div className="mb-3 p-2 rounded bg-slate-900 text-xs">
                  <div className="flex items-center gap-2">
                    <span>Status:</span>
                    {syncStatus === 'idle' && <span className="text-slate-400">â— Bereit</span>}
                    {syncStatus === 'uploading' && <span className="text-yellow-400">â—Œ Synchronisiere...</span>}
                    {syncStatus === 'success' && <span className="text-green-400">âœ“ Erfolgreich</span>}
                    {syncStatus === 'error' && <span className="text-red-400">âœ— Fehler</span>}
                  </div>
                  {lastSyncError && syncStatus === 'error' && (
                    <p className="text-red-400 text-xs mt-1">{lastSyncError}</p>
                  )}
                </div>
                
                {/* Aktivieren/Deaktivieren Toggle */}
                <div className="flex items-center gap-3 mb-3">
                  <button 
                    onClick={() => updateCloudConfig({ enabled: !cloudConfig.enabled })}
                    className={`relative w-12 h-6 rounded-full transition-colors ${cloudConfig.enabled ? 'bg-purple-600' : 'bg-slate-600'}`}
                  >
                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${cloudConfig.enabled ? 'left-7' : 'left-1'}`}></div>
                  </button>
                  <span className="text-xs text-slate-300">
                    {cloudConfig.enabled ? 'Cloud-Sync aktiviert' : 'Cloud-Sync deaktiviert'}
                  </span>
                </div>
                
                {/* LizenzschlÃ¼ssel */}
                <p className="text-xs text-slate-400 mb-1">LizenzschlÃ¼ssel</p>
                <input 
                  type="password" 
                  placeholder="Dein LizenzschlÃ¼ssel..." 
                  className="w-full p-2 text-black rounded text-xs mb-3" 
                  value={cloudConfig.licenseKey || ''} 
                  onChange={e => updateCloudConfig({ licenseKey: e.target.value })}
                />
                
                {/* Manueller Sync-Button */}
                <button 
                  onClick={triggerCloudSync}
                  disabled={!cloudConfig.enabled || !cloudConfig.licenseKey || !cloudConfig.workerUrl || syncStatus === 'uploading'}
                  className={`w-full py-2 rounded font-bold uppercase text-xs ${
                    cloudConfig.enabled && cloudConfig.licenseKey && cloudConfig.workerUrl && syncStatus !== 'uploading'
                      ? 'bg-purple-600 hover:bg-purple-500' 
                      : 'bg-slate-600 cursor-not-allowed'
                  }`}
                >
                  {syncStatus === 'uploading' ? 'â—Œ Synchronisiere...' : 'â˜ï¸ Jetzt synchronisieren'}
                </button>
                
                {/* Cloud-Restore Button */}
                <button 
                  onClick={restoreFromCloud}
                  disabled={!cloudConfig.enabled || !cloudConfig.licenseKey || !cloudConfig.workerUrl || syncStatus === 'uploading' || syncStatus === 'downloading'}
                  className={`w-full py-2 mt-2 rounded font-bold uppercase text-xs ${
                    cloudConfig.enabled && cloudConfig.licenseKey && cloudConfig.workerUrl && syncStatus !== 'uploading' && syncStatus !== 'downloading'
                      ? 'bg-indigo-600 hover:bg-indigo-500' 
                      : 'bg-slate-600 cursor-not-allowed'
                  }`}
                >
                  {syncStatus === 'downloading' ? 'â—Œ Lade...' : 'ğŸ“¥ Aus Cloud wiederherstellen'}
                </button>
                
                <p className="text-xs text-slate-600 mt-2">
                  ğŸ” Daten werden lokal verschlÃ¼sselt, bevor sie hochgeladen werden.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * SIDEBAR FOOTER - Kompakte Version (Backup-Buttons bleiben hier)
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="pt-4 border-t border-slate-700 space-y-2 text-xs">
          <div className="grid grid-cols-2 gap-2">
            <button onClick={exportFullBackup} className="bg-indigo-700 py-2 rounded font-bold uppercase hover:bg-indigo-600 text-[10px]">
              ğŸ” Backup
            </button>
            <label className="bg-indigo-600 py-2 rounded text-center cursor-pointer hover:bg-indigo-500 font-bold uppercase block text-[10px]">
              ğŸ”“ Import
              <input type="file" className="hidden" accept=".json,.txt,.enc" onChange={(e) => {
                const file = e.target.files[0];
                if (file) {
                  importBackupFile(file);
                  e.target.value = '';
                }
              }} />
            </label>
          </div>
          
          {/* .dat Archiv Ã¶ffnen */}
          <label className="block w-full bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold uppercase text-center cursor-pointer border border-dashed border-slate-500 text-[10px]">
            ğŸ”“ .dat Archiv Ã¶ffnen
            <input 
              type="file" 
              className="hidden" 
              accept=".dat"
              onChange={async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                e.target.value = '';
                
                const password = prompt('ğŸ”‘ Archiv-Passwort eingeben:');
                if (!password) return;
                
                const loading = showLoadingDialog('ğŸ”“ EntschlÃ¼ssele...');
                
                try {
                  const arrayBuffer = await file.arrayBuffer();
                  const bytes = new Uint8Array(arrayBuffer);
                  
                  const salt = bytes.slice(0, 16);
                  const iv = bytes.slice(16, 28);
                  const encryptedData = bytes.slice(28);
                  
                  const keyMaterial = await crypto.subtle.importKey(
                    'raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
                  );
                  
                  const key = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
                    keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
                  );
                  
                  const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv, tagLength: 128 }, key, encryptedData
                  );
                  
                  const decryptedBytes = new Uint8Array(decrypted);
                  const view = new DataView(decrypted);
                  
                  const pdfLength = view.getUint32(0, true);
                  const pdfData = decryptedBytes.slice(8, 8 + pdfLength);
                  const pdfBlob = new Blob([pdfData], { type: 'application/pdf' });
                  
                  loading.close();
                  
                  const pdfUrl = URL.createObjectURL(pdfBlob);
                  window.open(pdfUrl, '_blank');
                  setTimeout(() => URL.revokeObjectURL(pdfUrl), 60000);
                  
                } catch (err) {
                  loading.close();
                  if (err.name === 'OperationError') {
                    alert('âŒ Falsches Passwort!');
                  } else {
                    alert('Fehler: ' + err.message);
                  }
                }
              }}
            />
          </label>
        </div>
        </>
        )} {/* Ende activeModule === 'rechnung' */}
        
        {/* Zeiterfassungs-Modul Sidebar */}
        {activeModule === 'zeit' && (
        <>
        {/* Tabs fÃ¼r Zeiterfassung */}
        <div className="flex gap-1 mb-4 bg-slate-800 p-1 rounded text-[10px] font-bold uppercase flex-wrap">
          <button onClick={() => setZeitActiveTab("projekte")} className={`flex-1 py-2 rounded transition-colors ${zeitActiveTab === "projekte" ? "bg-teal-600" : "hover:bg-slate-700"}`}>ğŸ“ Projekte</button>
          <button onClick={() => setZeitActiveTab("mitarbeiter")} className={`flex-1 py-2 rounded transition-colors ${zeitActiveTab === "mitarbeiter" ? "bg-teal-600" : "hover:bg-slate-700"}`}>ğŸ‘¥ Team</button>
          <button onClick={() => setZeitActiveTab("einstellungen")} className={`flex-1 py-2 rounded transition-colors ${zeitActiveTab === "einstellungen" ? "bg-teal-600" : "hover:bg-slate-700"}`}>âš™ï¸</button>
        </div>

        <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4">
          {/* PROJEKTE TAB */}
          {zeitActiveTab === "projekte" && (
            <>
              <h3 className="text-teal-400 font-bold uppercase text-xs mb-2">Projekte</h3>
              
              {/* Neues Projekt erstellen */}
              <div className="flex gap-2 mb-4">
                <input 
                  type="text" 
                  placeholder="Neues Projekt..." 
                  value={zeitNewProjectName}
                  onChange={e => setZeitNewProjectName(e.target.value)}
                  onKeyDown={e => {
                    if (e.key === 'Enter' && zeitNewProjectName.trim()) {
                      const newProject = {
                        id: "p_" + Date.now(),
                        name: zeitNewProjectName,
                        created: new Date().toISOString(),
                        tage: {}
                      };
                      updateState(prev => {
                        const prevZeit = prev.zeiterfassung || { projekte: [], mitarbeiter: [], einstellungen: {} };
                        return {
                          ...prev,
                          zeiterfassung: {
                            ...prevZeit,
                            projekte: [newProject, ...(prevZeit.projekte || [])]
                          }
                        };
                      });
                      setZeitActiveProjectId(newProject.id);
                      setZeitNewProjectName("");
                    }
                  }}
                  className="flex-1 p-2 text-black text-xs rounded outline-none"
                />
                <button 
                  onClick={() => {
                    if (!zeitNewProjectName.trim()) return;
                    const newProject = {
                      id: "p_" + Date.now(),
                      name: zeitNewProjectName,
                      created: new Date().toISOString(),
                      tage: {}
                    };
                    updateState(prev => {
                      const prevZeit = prev.zeiterfassung || { projekte: [], mitarbeiter: [], einstellungen: {} };
                      return {
                        ...prev,
                        zeiterfassung: {
                          ...prevZeit,
                          projekte: [newProject, ...(prevZeit.projekte || [])]
                        }
                      };
                    });
                    setZeitActiveProjectId(newProject.id);
                    setZeitNewProjectName("");
                  }}
                  className="bg-teal-600 text-white px-3 rounded font-bold hover:bg-teal-500"
                >+</button>
              </div>
              
              {/* Projektliste */}
              {(appState.zeiterfassung?.projekte || []).length === 0 ? (
                <p className="text-slate-500 text-xs italic text-center py-8">Noch keine Projekte. Erstelle dein erstes Projekt oben.</p>
              ) : (
                (appState.zeiterfassung?.projekte || []).map(proj => {
                  const isActive = zeitActiveProjectId === proj.id;
                  const stundenGesamt = Object.values(proj.tage || {}).reduce((sum, tag) => sum + (tag.daySum || 0), 0);
                  return (
                    <div 
                      key={proj.id} 
                      onClick={() => setZeitActiveProjectId(proj.id)}
                      className={`p-3 rounded border cursor-pointer transition-all ${
                        isActive 
                          ? 'bg-teal-500/20 border-teal-500 ring-1 ring-teal-500' 
                          : 'bg-slate-800 border-slate-700 hover:border-teal-400'
                      }`}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <div className={`font-bold text-sm ${isActive ? 'text-teal-400' : 'text-white'}`}>{proj.name}</div>
                          <div className="text-slate-400 text-[10px] mt-1">
                            {Object.keys(proj.tage || {}).length} Tage erfasst
                          </div>
                        </div>
                        <div className="text-right">
                          <div className={`font-bold ${isActive ? 'text-teal-400' : 'text-emerald-400'}`}>
                            {stundenGesamt.toFixed(1)}h
                          </div>
                          <button 
                            onClick={async (e) => {
                              e.stopPropagation();
                              if (confirm(`Projekt "${proj.name}" lÃ¶schen?\n\nDas Projekt wird unwiderruflich gelÃ¶scht.\nDie Mitarbeiter-Stunden bleiben in der Monatsauswertung erhalten.`)) {
                                // Projekt sicher lÃ¶schen (3x Ã¼berschreiben)
                                // Die Stunden existieren bereits doppelt in monatsListe
                                await secureDelete(updateState, 'zeiterfassung.projekte', proj.id);
                                if (zeitActiveProjectId === proj.id) setZeitActiveProjectId("");
                              }
                            }}
                            className="text-slate-500 hover:text-red-400 text-[10px] mt-1"
                          >ğŸ—‘ï¸ LÃ¶schen</button>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </>
          )}

          {/* MITARBEITER TAB */}
          {zeitActiveTab === "mitarbeiter" && (
            <>
              <h3 className="text-orange-400 font-bold uppercase text-xs mb-2">Mitarbeiter</h3>
              
              {/* Neuen Mitarbeiter hinzufÃ¼gen */}
              <div className="flex gap-2 mb-4">
                <input 
                  type="text" 
                  placeholder="Neuer Mitarbeiter..." 
                  id="neuer-mitarbeiter-input"
                  onKeyDown={e => {
                    if (e.key === 'Enter') {
                      const input = e.target;
                      const name = input.value.trim();
                      if (!name) return;
                      
                      const mitarbeiter = appState.zeiterfassung?.mitarbeiter || [];
                      if (mitarbeiter.includes(name)) {
                        alert('Dieser Mitarbeiter existiert bereits.');
                        return;
                      }
                      
                      updateState(prev => {
                        const prevZeit = prev.zeiterfassung || { mitarbeiter: [] };
                        return {
                          ...prev,
                          zeiterfassung: {
                            ...prevZeit,
                            mitarbeiter: [...(prevZeit.mitarbeiter || []), name].sort()
                          }
                        };
                      });
                      input.value = '';
                    }
                  }}
                  className="flex-1 p-2 text-black text-xs rounded outline-none"
                />
                <button 
                  onClick={() => {
                    const input = document.getElementById('neuer-mitarbeiter-input');
                    const name = input.value.trim();
                    if (!name) return;
                    
                    const mitarbeiter = appState.zeiterfassung?.mitarbeiter || [];
                    if (mitarbeiter.includes(name)) {
                      alert('Dieser Mitarbeiter existiert bereits.');
                      return;
                    }
                    
                    updateState(prev => {
                      const prevZeit = prev.zeiterfassung || { mitarbeiter: [] };
                      return {
                        ...prev,
                        zeiterfassung: {
                          ...prevZeit,
                          mitarbeiter: [...(prevZeit.mitarbeiter || []), name].sort()
                        }
                      };
                    });
                    input.value = '';
                  }}
                  className="bg-teal-600 text-white px-3 rounded font-bold hover:bg-teal-500"
                >+</button>
              </div>
              
              <p className="text-slate-500 text-[10px] mb-3">Oder automatisch beim Erfassen von Stunden.</p>
              
              {/* Mitarbeiterliste */}
              <div className="space-y-2">
                {(appState.zeiterfassung?.mitarbeiter || []).length === 0 ? (
                  <p className="text-slate-500 text-xs italic text-center py-6">Noch keine Mitarbeiter.</p>
                ) : (
                  (appState.zeiterfassung?.mitarbeiter || []).map((name, idx) => (
                    <div key={idx} className="p-3 bg-slate-800 rounded border border-slate-700 flex justify-between items-center group">
                      <span className="text-white font-medium text-sm">{name}</span>
                      <button 
                        onClick={() => {
                          if (confirm(`"${name}" aus der Mitarbeiterliste entfernen?`)) {
                            updateState(prev => {
                              const prevZeit = prev.zeiterfassung || { mitarbeiter: [] };
                              return {
                                ...prev,
                                zeiterfassung: {
                                  ...prevZeit,
                                  mitarbeiter: prevZeit.mitarbeiter.filter(m => m !== name)
                                }
                              };
                            });
                          }
                        }}
                        className="text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                      >âœ•</button>
                    </div>
                  ))
                )}
              </div>
              
              <p className="text-slate-600 text-[10px] mt-4 border-t border-slate-700 pt-3">
                ğŸ’¡ Entfernen lÃ¶scht nur den Autocomplete-Vorschlag, nicht die erfassten Stunden.
              </p>
            </>
          )}

          {/* EINSTELLUNGEN TAB */}
          {zeitActiveTab === "einstellungen" && (
            <>
              <h3 className="text-orange-400 font-bold uppercase text-xs mb-2">Einstellungen</h3>
              
              <div className="space-y-4">
                {/* Pausenzeit */}
                <div className="p-3 bg-slate-800 rounded border border-slate-700">
                  <label className="flex items-center gap-2 mb-3">
                    <input 
                      type="checkbox" 
                      checked={appState.zeiterfassung?.einstellungen?.pauseAktiv !== false}
                      onChange={e => {
                        updateState(prev => {
                          const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                          return {
                            ...prev,
                            zeiterfassung: {
                              ...prevZeit,
                              einstellungen: {
                                ...prevZeit.einstellungen,
                                pauseAktiv: e.target.checked
                              }
                            }
                          };
                        });
                      }}
                      className="accent-teal-500"
                    />
                    <span className="text-white text-sm font-medium">Automatische Pause abziehen</span>
                  </label>
                  
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="text-slate-400 text-[10px] uppercase block mb-1">Pause von</label>
                      <input 
                        type="time" 
                        value={appState.zeiterfassung?.einstellungen?.pauseStart || "12:00"}
                        onChange={e => {
                          updateState(prev => {
                            const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                            return {
                              ...prev,
                              zeiterfassung: {
                                ...prevZeit,
                                einstellungen: {
                                  ...prevZeit.einstellungen,
                                  pauseStart: e.target.value
                                }
                              }
                            };
                          });
                        }}
                        className="w-full p-2 bg-slate-700 text-white rounded text-sm"
                      />
                    </div>
                    <div>
                      <label className="text-slate-400 text-[10px] uppercase block mb-1">Pause bis</label>
                      <input 
                        type="time" 
                        value={appState.zeiterfassung?.einstellungen?.pauseEnde || "12:30"}
                        onChange={e => {
                          updateState(prev => {
                            const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                            return {
                              ...prev,
                              zeiterfassung: {
                                ...prevZeit,
                                einstellungen: {
                                  ...prevZeit.einstellungen,
                                  pauseEnde: e.target.value
                                }
                              }
                            };
                          });
                        }}
                        className="w-full p-2 bg-slate-700 text-white rounded text-sm"
                      />
                    </div>
                  </div>
                </div>

                {/* Stundenlohn */}
                <div className="p-3 bg-slate-800 rounded border border-slate-700">
                  <label className="flex items-center gap-2 mb-3">
                    <input 
                      type="checkbox" 
                      checked={appState.zeiterfassung?.einstellungen?.kostenAktiv === true}
                      onChange={e => {
                        updateState(prev => {
                          const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                          return {
                            ...prev,
                            zeiterfassung: {
                              ...prevZeit,
                              einstellungen: {
                                ...prevZeit.einstellungen,
                                kostenAktiv: e.target.checked
                              }
                            }
                          };
                        });
                      }}
                      className="accent-teal-500"
                    />
                    <span className="text-white text-sm font-medium">ğŸ’° Kosten berechnen</span>
                  </label>
                  
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="text-slate-400 text-[10px] uppercase block mb-1">Facharbeiter (F)</label>
                      <div className="flex items-center gap-1">
                        <input 
                          type="number" 
                          value={appState.zeiterfassung?.einstellungen?.stundenlohnF || 59}
                          onChange={e => {
                            updateState(prev => {
                              const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                              return {
                                ...prev,
                                zeiterfassung: {
                                  ...prevZeit,
                                  einstellungen: {
                                    ...prevZeit.einstellungen,
                                    stundenlohnF: parseFloat(e.target.value) || 0
                                  }
                                }
                              };
                            });
                          }}
                          className="flex-1 p-2 bg-slate-700 text-white rounded text-sm"
                        />
                        <span className="text-slate-500 text-xs">â‚¬</span>
                      </div>
                    </div>
                    <div>
                      <label className="text-slate-400 text-[10px] uppercase block mb-1">Helfer (H)</label>
                      <div className="flex items-center gap-1">
                        <input 
                          type="number" 
                          value={appState.zeiterfassung?.einstellungen?.stundenlohnH || 50}
                          onChange={e => {
                            updateState(prev => {
                              const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                              return {
                                ...prev,
                                zeiterfassung: {
                                  ...prevZeit,
                                  einstellungen: {
                                    ...prevZeit.einstellungen,
                                    stundenlohnH: parseFloat(e.target.value) || 0
                                  }
                                }
                              };
                            });
                          }}
                          className="flex-1 p-2 bg-slate-700 text-white rounded text-sm"
                        />
                        <span className="text-slate-500 text-xs">â‚¬</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* PDF Einstellungen */}
                <div className="p-3 bg-slate-800 rounded border border-slate-700">
                  <label className="flex items-center gap-2">
                    <input 
                      type="checkbox" 
                      checked={appState.zeiterfassung?.einstellungen?.unterschriftAktiv !== false}
                      onChange={e => {
                        updateState(prev => {
                          const prevZeit = prev.zeiterfassung || { einstellungen: {} };
                          return {
                            ...prev,
                            zeiterfassung: {
                              ...prevZeit,
                              einstellungen: {
                                ...prevZeit.einstellungen,
                                unterschriftAktiv: e.target.checked
                              }
                            }
                          };
                        });
                      }}
                      className="accent-teal-500"
                    />
                    <span className="text-white text-sm font-medium">ğŸ“ Unterschriftsfelder im PDF</span>
                  </label>
                </div>
              </div>
            </>
          )}
        </div>
        
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * SIDEBAR FOOTER - Backup-Buttons (gleich wie im Dokumente-Modul)
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="pt-4 border-t border-slate-700 space-y-2 text-xs mt-auto">
          <div className="grid grid-cols-2 gap-2">
            <button onClick={exportFullBackup} className="bg-indigo-700 py-2 rounded font-bold uppercase hover:bg-indigo-600 text-[10px]">
              ğŸ” Backup
            </button>
            <label className="bg-indigo-600 py-2 rounded text-center cursor-pointer hover:bg-indigo-500 font-bold uppercase block text-[10px]">
              ğŸ”“ Import
              <input type="file" className="hidden" accept=".json,.txt,.enc" onChange={(e) => {
                const file = e.target.files[0];
                if (file) {
                  importBackupFile(file);
                  e.target.value = '';
                }
              }} />
            </label>
          </div>
        </div>
        </>
        )}
      </div>

      {/* DASHBOARD / LAUNCHER */}
      {activeModule === 'dashboard' && (
        <div className="main-content flex-1 pt-14 md:pt-0 pb-20 md:pb-6 flex flex-col bg-slate-100 overflow-y-auto">
          <div className="max-w-6xl mx-auto p-6 md:p-10 w-full">
            <header className="mb-12 text-center md:text-left">
              <h1 className="text-3xl font-bold text-slate-800 mb-2">
                Willkommen zurÃ¼ck, <span className="text-teal-600">{appState.firmenDaten.inhaberName || 'Chef'}</span>.
              </h1>
              <p className="text-slate-500">WÃ¤hlen Sie einen Bereich, um zu starten.</p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              
              {/* MODUL 1: RECHNUNGEN */}
              <div 
                onClick={() => setActiveModule('rechnung')}
                className="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl border-l-8 border-teal-600 cursor-pointer transform transition hover:-translate-y-1 group"
              >
                <div className="text-4xl mb-4 group-hover:scale-110 transition-transform duration-300">ğŸ“„</div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">Rechnungen & Angebote</h3>
                <p className="text-slate-500 text-sm mb-4">Erstellen, verwalten und PDF-Export von Dokumenten.</p>
                <div className="text-xs font-bold text-teal-600 uppercase tracking-wide">
                  {appState.rechnungen.length + appState.angebote.length} Dokumente gespeichert
                </div>
              </div>

              {/* MODUL 2: ZEITERFASSUNG */}
              <div 
                onClick={() => setActiveModule('zeit')}
                className="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl border-l-8 border-orange-500 cursor-pointer transform transition hover:-translate-y-1 group"
              >
                <div className="text-4xl mb-4 group-hover:scale-110 transition-transform duration-300">â±ï¸</div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">Zeiterfassung</h3>
                <p className="text-slate-500 text-sm mb-4">Stunden dokumentieren, Pausen berechnen und Monatsberichte.</p>
                <div className="text-xs font-bold text-orange-500 uppercase tracking-wide">
                  {(appState.zeiterfassung?.projekte || []).length} Projekte aktiv
                </div>
              </div>

              {/* MODUL 3: EINSTELLUNGEN */}
              <div 
                onClick={() => setActiveModule('settings')}
                className="bg-white p-8 rounded-xl shadow-sm hover:shadow-xl border-l-8 border-slate-500 cursor-pointer transform transition hover:-translate-y-1 group"
              >
                <div className="text-4xl mb-4 group-hover:scale-110 transition-transform duration-300">âš™ï¸</div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">Einstellungen</h3>
                <p className="text-slate-500 text-sm mb-4">Firmenprofil, Cloud-Sync und Datenverwaltung.</p>
                <div className="text-xs font-bold text-slate-500 uppercase tracking-wide">
                  Globale Konfiguration
                </div>
              </div>

            </div>

            {/* SICHERHEITS STATUS UNTEN */}
            <div className="mt-16 p-6 bg-slate-200/50 rounded-lg flex flex-col md:flex-row items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="bg-emerald-100 text-emerald-700 p-2 rounded-full">ğŸ›¡ï¸</div>
                <div>
                  <div className="font-bold text-slate-700 text-sm">System sicher</div>
                  <div className="text-xs text-slate-500">Daten sind verschlÃ¼sselt im RAM geladen.</div>
                </div>
              </div>
              <button onClick={() => window.location.reload()} className="text-xs text-slate-500 hover:text-red-600 font-bold uppercase">
                Logout (Sitzung beenden)
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Vorschau - nur bei Rechnungsmodul */}
      {activeModule === 'rechnung' && (
      <div className="main-content flex-1 pt-14 md:pt-0 pb-20 md:pb-6 flex flex-col bg-slate-100 overflow-y-auto md:overflow-visible">
        
        {/* ZOOM TOOLBAR - nur auf MobilgerÃ¤ten */}
        {(window.innerWidth < 1024 || window.innerHeight < 600) && (
          <div className="zoom-toolbar no-print">
            <div className="flex items-center gap-2 flex-wrap">
              <div className="flex items-center gap-2 text-sm text-gray-600 bg-gray-100 px-2 py-1.5 rounded-lg">
                <span className="text-xs">ğŸ”</span>
                <input 
                  type="range" 
                  min="0.5" 
                  max="1.0" 
                  step="0.05" 
                  value={zoomLevel} 
                  onChange={(e) => setZoomLevel(parseFloat(e.target.value))}
                  className="w-20 accent-teal-600 cursor-pointer"
                />
                <span className="w-10 text-xs text-right font-mono">{Math.round(zoomLevel * 100)}%</span>
              </div>
              <div className="flex gap-1">
                <button onClick={() => setZoomLevel(0.5)} className={`px-2 py-1 text-xs rounded ${zoomLevel === 0.5 ? 'bg-teal-600 text-white' : 'bg-gray-200'}`}>50%</button>
                <button onClick={() => setZoomLevel(0.75)} className={`px-2 py-1 text-xs rounded ${zoomLevel === 0.75 ? 'bg-teal-600 text-white' : 'bg-gray-200'}`}>75%</button>
                <button onClick={() => setZoomLevel(1)} className={`px-2 py-1 text-xs rounded ${zoomLevel === 1 ? 'bg-teal-600 text-white' : 'bg-gray-200'}`}>100%</button>
              </div>
            </div>
          </div>
        )}
        
        {/* SCROLL-BEREICH mit A4-Blatt */}
        <div className="preview-scroll-area">
          {/* Wrapper fÃ¼r Zentrierung */}
          <div style={{
            display: 'inline-flex',
            justifyContent: 'center',
            minWidth: '100%',
          }}>
          <div
            id="rechnung-druck"
            className="a4-preview"
            style={{
              transform: `scale(${zoomLevel})`,
              transformOrigin: 'top center',
              fontFamily: 'Arial, Helvetica, sans-serif',
              fontSize: '11pt',
              lineHeight: '1.45',
              color: '#111',
              boxSizing: 'border-box',
              marginBottom: `${(zoomLevel - 1) * 297}mm`,
              marginLeft: `${(zoomLevel - 1) * 105}mm`,
              marginRight: `${(zoomLevel - 1) * 105}mm`,
            }}
          >
            {/* Falzmarken */}
            <div className="falzmarke falzmarke-1 no-print"></div>
            <div className="falzmarke falzmarke-3 no-print"></div>
            <div className="falzmarke falzmarke-2 no-print"></div>
            
            <div className="page-content">
              {/* GroÃŸer Header mit Logo */}
              <div className="page-header">
                {/* Logo wenn vorhanden */}
                {firmenDaten.logo && (
                <div style={{ 
                  display: 'flex',
                  justifyContent: firmenDaten.logoPosition === 'mitte' ? 'center' : firmenDaten.logoPosition === 'rechts' ? 'flex-end' : 'flex-start',
                  marginBottom: '4mm'
                }}>
                  <img src={firmenDaten.logo} alt="Logo" style={{ 
                    width: `${firmenDaten.logoBreite || 40}mm`, 
                    height: `${firmenDaten.logoHoehe || 15}mm`,
                    objectFit: 'contain'
                  }} />
                </div>
              )}
              {/* Firmenname nur anzeigen wenn kein Logo */}
              {!firmenDaten.logo && (
                <div style={{ fontSize: '28pt', fontWeight: 'bold', color: firmenDaten.primaerFarbe, marginBottom: '14mm', textAlign: 'center', letterSpacing: '1px' }}>
                  {firmenDaten.firmenname.toUpperCase()}
                </div>
              )}

              {/* Absenderzeile klein */}
              <div style={{ fontSize: '9pt', color: firmenDaten.briefkopfFarbe || '#444', marginBottom: '14mm', borderBottom: '1px solid #ccc', paddingBottom: '2mm', textAlign: 'left' }}>
                {firmenDaten.briefkopfAbsender === "firmenname" ? firmenDaten.firmenname : firmenDaten.inhaberName} Â· {firmenDaten.strasse} Â· {firmenDaten.plz} {firmenDaten.ort}
              </div>
            </div>

            {/* Anschrift â€“ zeilenweise (DIN-konform) */}
            <div style={{ marginBottom: '18mm', width: '90mm', lineHeight: '1.6' }}>
              {aktivesDok.kunde.name && <div style={{ fontWeight: 'bold' }}>{aktivesDok.kunde.name}</div>}
              {aktivesDok.kunde.strasse && <div>{aktivesDok.kunde.strasse}</div>}
              {(aktivesDok.kunde.plz || aktivesDok.kunde.ort) && <div>{[aktivesDok.kunde.plz, aktivesDok.kunde.ort].filter(Boolean).join(' ')}</div>}
            </div>

            {/* Rechnungskopf */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '12mm', paddingBottom: '4mm' }}>
              <div>
                {aktivesDok.typ === "LEERES_DOKUMENT" ? (
                  <input 
                    type="text" 
                    style={{ fontSize: '22pt', fontWeight: 'bold', color: firmenDaten.primaerFarbe, margin: 0, border: `1px dashed ${firmenDaten.primaerFarbe}`, padding: '2px 8px', borderRadius: '4px', width: '100%' }}
                    value={aktivesDok.betreff || ""}
                    onChange={e => setAktivesDok({...aktivesDok, betreff: e.target.value})}
                    placeholder="Betreff eingeben..."
                  />
                ) : (
                  <h1 style={{ fontSize: '22pt', fontWeight: 'bold', color: firmenDaten.primaerFarbe, margin: 0 }}>{aktivesDok.typ}</h1>
                )}
              </div>
              <div style={{ textAlign: 'right', fontSize: '10pt' }}>
                <div>{aktivesDok.typ === "ANGEBOT" ? "Angebots" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "Abschlagsrechnungs" : aktivesDok.typ === "LEERES_DOKUMENT" ? "Dok." : "Rechnungs"}-Nr.: <input style={{ border: 'none', borderBottom: '1px dashed #666', outline: 'none', width: '110px', textAlign: 'right' }} value={aktivesDok.nummer} onChange={e => setAktivesDok({...aktivesDok, nummer: e.target.value})} /></div>
                <div>Datum: <input style={{ border: 'none', borderBottom: '1px dashed #666', outline: 'none', width: '90px', textAlign: 'right' }} value={aktivesDok.datum} onChange={e => setAktivesDok({...aktivesDok, datum: e.target.value})} /></div>
                {aktivesDok.typ !== "ANGEBOT" && aktivesDok.typ !== "LEERES_DOKUMENT" && (
                  <div style={{ fontSize: '10pt' }}>Leistungszeitraum: <input style={{ border: 'none', borderBottom: '1px dashed #666', outline: 'none', width: '70px', textAlign: 'right' }} placeholder="von" value={aktivesDok.leistungszeitraum?.von || ""} onChange={e => setAktivesDok({...aktivesDok, leistungszeitraum: {...(aktivesDok.leistungszeitraum || {}), von: e.target.value}})} /> - <input style={{ border: 'none', borderBottom: '1px dashed #666', outline: 'none', width: '70px', textAlign: 'right' }} placeholder="bis" value={aktivesDok.leistungszeitraum?.bis || ""} onChange={e => setAktivesDok({...aktivesDok, leistungszeitraum: {...(aktivesDok.leistungszeitraum || {}), bis: e.target.value}})} /></div>
                )}
              </div>
            </div>

            {/* Arbeitsort - editierbar (nicht bei Leeres Dokument) */}
            {aktivesDok.typ !== "LEERES_DOKUMENT" && (
            <div style={{ marginBottom: '8mm', fontSize: '10pt', color: '#444' }}>
              <input 
                type="text" 
                style={{ width: '100%', border: '1px solid #ccc', padding: '4px 6px', fontSize: '10pt', borderRadius: '3px', outline: 'none' }}
                value={aktivesDok.arbeitsort || (aktivesDok.typ === "ANGEBOT" 
                  ? (aktivesDok.kunde.strasse && aktivesDok.kunde.ort ? `FÃ¼r die Arbeiten in der ${aktivesDok.kunde.strasse} in ${aktivesDok.kunde.ort}.` : aktivesDok.kunde.strasse ? `FÃ¼r die Arbeiten in der ${aktivesDok.kunde.strasse}.` : 'FÃ¼r die Arbeiten in der StraÃŸe des Kunden.')
                  : (aktivesDok.kunde.strasse && aktivesDok.kunde.ort ? `FÃ¼r die ausgefÃ¼hrten Arbeiten in der ${aktivesDok.kunde.strasse} in ${aktivesDok.kunde.ort}.` : aktivesDok.kunde.strasse ? `FÃ¼r die ausgefÃ¼hrten Arbeiten in der ${aktivesDok.kunde.strasse}.` : 'FÃ¼r die ausgefÃ¼hrten Arbeiten in der StraÃŸe des Kunden.'))}
                onChange={e => setAktivesDok({...aktivesDok, arbeitsort: e.target.value})}
                placeholder="Ort der Arbeiten"
              />
            </div>
            )}

            {/* Freitext und Signatur fÃ¼r Leeres Dokument */}
            {aktivesDok.typ === "LEERES_DOKUMENT" && (
              <>
                <div style={{ marginBottom: '8mm' }}>
                  <textarea
                    style={{ 
                      width: '100%', 
                      minHeight: '300px', 
                      border: '1px solid #ccc', 
                      padding: '8px 12px', 
                      fontSize: '11pt', 
                      borderRadius: '4px', 
                      outline: 'none',
                      lineHeight: '1.6',
                      fontFamily: 'inherit',
                      resize: 'vertical'
                    }}
                    value={aktivesDok.freitext || ""}
                    onChange={e => setAktivesDok({...aktivesDok, freitext: e.target.value})}
                    placeholder="Geben Sie hier Ihren Text ein..."
                  />
                </div>
                
                {/* Signatur-Optionen */}
                <div className="no-print" style={{ marginBottom: '8mm', padding: '12px', backgroundColor: '#f8f9fa', borderRadius: '4px', border: '1px solid #ddd' }}>
                  <div style={{ fontWeight: 'bold', marginBottom: '8px', fontSize: '10pt', color: '#333' }}>Signaturfelder (optional)</div>
                  <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '10pt', marginBottom: '6px' }}>
                    <input 
                      type="checkbox" 
                      checked={aktivesDok.signaturKunde || false}
                      onChange={e => setAktivesDok({...aktivesDok, signaturKunde: e.target.checked})}
                      style={{ marginRight: '8px', width: '18px', height: '18px' }}
                    />
                    <span style={{ color: '#333' }}>
                      <strong>Unterschrift Kunde</strong> â€“ Feld fÃ¼r Kundenunterschrift
                    </span>
                  </label>
                  <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '10pt' }}>
                    <input 
                      type="checkbox" 
                      checked={aktivesDok.signaturAbsender || false}
                      onChange={e => setAktivesDok({...aktivesDok, signaturAbsender: e.target.checked})}
                      style={{ marginRight: '8px', width: '18px', height: '18px' }}
                    />
                    <span style={{ color: '#333' }}>
                      <strong>{firmenDaten.inhaberName}</strong> â€“ Ihre Unterschrift
                    </span>
                  </label>
                </div>
                
                {/* Signaturfelder-Vorschau */}
                {(aktivesDok.signaturKunde || aktivesDok.signaturAbsender) && (
                  <div style={{ marginTop: '10mm', marginBottom: '8mm', display: 'flex', justifyContent: 'flex-start', gap: '20mm' }}>
                    {aktivesDok.signaturAbsender && (
                      <div style={{ flex: '0 0 45%' }}>
                        <div style={{ fontSize: '9pt', color: '#666', marginBottom: '2mm' }}>{firmenDaten.inhaberName}</div>
                        <canvas
                          ref={signaturCanvasRef}
                          width={200}
                          height={80}
                          style={{ 
                            border: '1px solid #ccc', 
                            borderRadius: '4px', 
                            backgroundColor: '#fff',
                            touchAction: 'none',
                            cursor: 'crosshair'
                          }}
                          onMouseDown={startDrawing}
                          onMouseMove={draw}
                          onMouseUp={stopDrawing}
                          onMouseLeave={stopDrawing}
                          onTouchStart={startDrawing}
                          onTouchMove={draw}
                          onTouchEnd={stopDrawing}
                        />
                        <div style={{ marginTop: '2mm', display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                          <button 
                            type="button" 
                            onClick={clearSignaturCanvas}
                            style={{ fontSize: '8pt', padding: '2px 8px', cursor: 'pointer', backgroundColor: '#f0f0f0', border: '1px solid #ccc', borderRadius: '3px' }}
                          >
                            LÃ¶schen
                          </button>
                          <span style={{ fontSize: '8pt', color: '#666' }}>Ort:</span>
                          <input 
                            type="text" 
                            value={aktivesDok.signaturAbsenderOrt || ""}
                            onChange={e => setAktivesDok({...aktivesDok, signaturAbsenderOrt: e.target.value})}
                            placeholder="Ort"
                            style={{ 
                              fontSize: '8pt', 
                              padding: '2px 6px', 
                              border: '1px solid #ccc', 
                              borderRadius: '3px',
                              width: '80px'
                            }}
                          />
                          <span style={{ fontSize: '8pt', color: '#666' }}>Datum:</span>
                          <input 
                            type="text" 
                            value={aktivesDok.signaturAbsenderDatum || ""}
                            onChange={e => setAktivesDok({...aktivesDok, signaturAbsenderDatum: e.target.value})}
                            placeholder="TT.MM.JJJJ"
                            style={{ 
                              fontSize: '8pt', 
                              padding: '2px 6px', 
                              border: '1px solid #ccc', 
                              borderRadius: '3px',
                              width: '80px'
                            }}
                          />
                        </div>
                      </div>
                    )}
                    {aktivesDok.signaturKunde && (
                      <div style={{ flex: '0 0 45%' }}>
                        <div style={{ borderTop: '1px solid #333', paddingTop: '2mm', marginTop: '62px' }}>
                          <div style={{ fontSize: '9pt', color: '#666' }}>Unterschrift Kunde</div>
                          <div style={{ fontSize: '8pt', color: '#999', marginTop: '1mm' }}>Ort, Datum: ________________</div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </>
            )}

            {/* Tabelle (nicht bei Leeres Dokument) */}
            {aktivesDok.typ !== "LEERES_DOKUMENT" && (
            <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '12mm', fontSize: '10pt' }}>
              <thead>
                <tr style={{ borderBottom: '2px solid #006666', textAlign: 'left' }}>
                  <th className="no-print" style={{ padding: '3mm 0', width: '30px' }}>Ãœ</th>
                  {aktivesDok.typ === "ANGEBOT" && <th className="no-print" style={{ padding: '3mm 0', width: '30px' }}>Opt.</th>}
                  <th style={{ padding: '3mm 0', width: '15mm' }}>Pos.</th>
                  <th style={{ padding: '3mm 0' }}>Beschreibung</th>
                  <th style={{ padding: '3mm 0', textAlign: 'right', width: '20mm' }}>Menge</th>
                  <th style={{ padding: '3mm 0', textAlign: 'right', width: '18mm' }}>Einheit</th>
                  <th style={{ padding: '3mm 0', textAlign: 'right', width: '28mm' }}>Einzelpreis â‚¬</th>
                  <th style={{ padding: '3mm 0', textAlign: 'right', width: '28mm' }}>Gesamt â‚¬</th>
                  <th className="no-print" style={{ width: '20px' }}></th>
                </tr>
              </thead>
              <tbody>
                {aktivesDok.positionen.map((p, i) => {
                  // Berechne die tatsÃ¤chliche Positionsnummer (ohne Ãœberschriften und optionale)
                  const posNummer = aktivesDok.positionen.slice(0, i).filter(pos => !pos.isUeberschrift && !pos.isOptional).length + (p.isUeberschrift || p.isOptional ? 0 : 1);
                  const posLabel = p.isOptional ? "Opt." : (p.isUeberschrift ? '' : posNummer);
                  const gesamtBetrag = (parseVal(p.menge) * parseVal(p.preis)).toFixed(2) + ' â‚¬';
                  const gesamtAnzeige = p.isOptional ? `(${gesamtBetrag})` : gesamtBetrag;
                  return (
                  <tr key={p.id} style={{ borderBottom: '1px solid #eee' }}>
                    <td className="no-print" style={{ padding: '3mm 0', textAlign: 'center' }}>
                      <input 
                        type="checkbox" 
                        checked={p.isUeberschrift || false}
                        onChange={e => {
                          const n = [...aktivesDok.positionen];
                          n[i].isUeberschrift = e.target.checked;
                          if (e.target.checked) n[i].isOptional = false; // Ãœberschrift kann nicht optional sein
                          setAktivesDok({...aktivesDok, positionen: n});
                        }}
                        title="Als Ãœberschrift formatieren"
                      />
                    </td>
                    {aktivesDok.typ === "ANGEBOT" && (
                      <td className="no-print" style={{ padding: '3mm 0', textAlign: 'center' }}>
                        <input 
                          type="checkbox" 
                          checked={p.isOptional || false}
                          disabled={p.isUeberschrift}
                          onChange={e => {
                            const n = [...aktivesDok.positionen];
                            n[i].isOptional = e.target.checked;
                            setAktivesDok({...aktivesDok, positionen: n});
                          }}
                          title="Als optionale Position markieren"
                        />
                      </td>
                    )}
                    <td style={{ padding: '3mm 0' }}>{posLabel}</td>
                    <td style={{ padding: '3mm 2mm 3mm 0' }}>
                      <textarea 
                        style={{ width: '100%', border: 'none', outline: 'none', resize: 'vertical', background: 'transparent', minHeight: '40px', fontWeight: p.isUeberschrift ? 'bold' : 'normal' }} 
                        rows={Math.max(2, Math.ceil(p.name.length / 50))} 
                        value={p.name} 
                        onChange={e => {
                          const n = [...aktivesDok.positionen];
                          n[i].name = e.target.value;
                          setAktivesDok({...aktivesDok, positionen: n});
                        }} 
                      />
                    </td>
                    <td style={{ padding: '3mm 0', textAlign: 'right' }}>
                      {!p.isUeberschrift && (
                        <input style={{ width: '100%', textAlign: 'right', border: 'none', outline: 'none', background: 'transparent' }} value={p.menge} onChange={e => {
                          const n = [...aktivesDok.positionen];
                          n[i].menge = e.target.value;
                          setAktivesDok({...aktivesDok, positionen: n});
                        }} />
                      )}
                    </td>
                    <td style={{ padding: '3mm 0', textAlign: 'right' }}>
                      {!p.isUeberschrift && (
                        <input style={{ width: '100%', textAlign: 'right', border: 'none', outline: 'none', background: 'transparent' }} value={p.einheit} onChange={e => {
                          const n = [...aktivesDok.positionen];
                          n[i].einheit = e.target.value;
                          setAktivesDok({...aktivesDok, positionen: n});
                        }} />
                      )}
                    </td>
                    <td style={{ padding: '3mm 0', textAlign: 'right' }}>
                      {!p.isUeberschrift && (
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: '2px' }}>
                          <input style={{ width: '90%', textAlign: 'right', border: 'none', outline: 'none', background: 'transparent' }} value={p.preis} onChange={e => {
                            const n = [...aktivesDok.positionen];
                            n[i].preis = e.target.value;
                            setAktivesDok({...aktivesDok, positionen: n});
                          }} />
                          <span>â‚¬</span>
                        </div>
                      )}
                    </td>
                    <td style={{ padding: '3mm 0', textAlign: 'right', fontWeight: 'bold' }}>
                      {!p.isUeberschrift && gesamtAnzeige}
                    </td>
                    <td className="no-print" style={{ padding: '3mm 0' }}>
                      <div className="flex gap-1 justify-end" style={{ opacity: 0.3 }} onMouseEnter={e => e.currentTarget.style.opacity = 1} onMouseLeave={e => e.currentTarget.style.opacity = 0.3}>
                        <button onClick={() => {
                          if (i > 0) {
                            const n = [...aktivesDok.positionen];
                            [n[i-1], n[i]] = [n[i], n[i-1]];
                            setAktivesDok({...aktivesDok, positionen: n});
                          }
                        }} className="text-teal-600" style={{ fontSize: '18px', fontWeight: 'bold', lineHeight: '1', padding: '2px 4px', cursor: 'pointer' }}>â†‘</button>
                        <button onClick={() => {
                          if (i < aktivesDok.positionen.length - 1) {
                            const n = [...aktivesDok.positionen];
                            [n[i+1], n[i]] = [n[i], n[i+1]];
                            setAktivesDok({...aktivesDok, positionen: n});
                          }
                        }} className="text-teal-600" style={{ fontSize: '18px', fontWeight: 'bold', lineHeight: '1', padding: '2px 4px', cursor: 'pointer' }}>â†“</button>
                        <button onClick={() => {
                          const n = aktivesDok.positionen.filter((_, idx) => idx !== i);
                          setAktivesDok({...aktivesDok, positionen: n});
                        }} className="text-red-600" style={{ fontSize: '20px', fontWeight: 'bold', lineHeight: '1', padding: '2px 4px', cursor: 'pointer' }}>Ã—</button>
                      </div>
                    </td>
                  </tr>
                  );
                })}
              </tbody>
            </table>
            )}

            {/* Summen (nicht bei Leeres Dokument) */}
            {aktivesDok.typ !== "LEERES_DOKUMENT" && (
            <div style={{ marginLeft: 'auto', width: '90mm', fontSize: '10pt' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '2mm 0', borderTop: '1px solid #006666' }}>
                <span>Nettobetrag</span><span>{(netto - abschlagBetrag).toFixed(2)} â‚¬</span>
              </div>
              {rabattBetrag > 0 && (
                <>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1mm 0' }}>
                    <input 
                      type="text" 
                      style={{ width: '180px', padding: '2px 6px', fontSize: '10pt', border: '1px solid #999', borderRadius: '3px', color: '#006666' }}
                      value={aktivesDok.rabattBeschreibung || "Nachlass"}
                      onChange={e => setAktivesDok({...aktivesDok, rabattBeschreibung: e.target.value})}
                      placeholder="z.B. Nachlass fÃ¼r Barzahlung"
                    />
                    <span style={{ marginLeft: '4px' }}>:</span>
                    <input 
                      type="text" 
                      style={{ width: '120px', padding: '2px 6px', fontSize: '10pt', border: '1px solid #999', borderRadius: '3px', textAlign: 'right' }}
                      value={aktivesDok.rabatt || "0"}
                      onChange={e => setAktivesDok({...aktivesDok, rabatt: e.target.value})}
                      placeholder="0,00"
                    />
                    <span style={{ color: '#006666', marginLeft: '4px' }}>â‚¬</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '2mm 0', borderTop: '1px solid #ccc', fontWeight: 'bold' }}>
                    <span>Zwischensumme</span><span>{nettoNachRabatt.toFixed(2)} â‚¬</span>
                  </div>
                </>
              )}
              {rabattBetrag === 0 && (
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1mm 0' }}>
                  <input 
                    type="text" 
                    style={{ width: '180px', padding: '2px 6px', fontSize: '10pt', border: '1px solid #999', borderRadius: '3px', color: '#006666' }}
                    value={aktivesDok.rabattBeschreibung || "Nachlass"}
                    onChange={e => setAktivesDok({...aktivesDok, rabattBeschreibung: e.target.value})}
                    placeholder="z.B. Nachlass fÃ¼r Barzahlung"
                  />
                  <span style={{ marginLeft: '4px' }}>:</span>
                  <input 
                    type="text" 
                    style={{ width: '120px', padding: '2px 6px', fontSize: '10pt', border: '1px solid #999', borderRadius: '3px', textAlign: 'right' }}
                    value={aktivesDok.rabatt || "0"}
                    onChange={e => setAktivesDok({...aktivesDok, rabatt: e.target.value})}
                    placeholder="0,00"
                  />
                  <span style={{ color: '#006666', marginLeft: '4px' }}>â‚¬</span>
                </div>
              )}
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '1mm 0' }}>
                <span>MwSt. 19 %</span><span>{mwst.toFixed(2)} â‚¬</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12pt', fontWeight: 'bold', padding: '4mm 0 0 0', borderTop: '2px solid #006666' }}>
                <span>{aktivesDok.typ === "ANGEBOT" ? "Angebotssumme" : aktivesDok.typ === "ABSCHLAGSRECHNUNG" ? "Abschlagsrechnungsbetrag" : "Rechnungsbetrag"}</span><span>{brutto.toFixed(2)} â‚¬</span>
              </div>
              {aktivesDok.typ === "RECHNUNG" && (
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '3mm 0 0 0' }}>
                  <span style={{ fontSize: '10pt', color: '#006666' }}>Abzgl. Abschlagsrechnung(en):</span>
                  <input 
                    type="text" 
                    style={{ width: '120px', padding: '2px 6px', fontSize: '10pt', border: '1px solid #999', borderRadius: '3px', textAlign: 'right' }}
                    value={aktivesDok.abschlagsrechnungBetrag || "0"}
                    onChange={e => setAktivesDok({...aktivesDok, abschlagsrechnungBetrag: e.target.value})}
                    placeholder="0,00"
                  />
                  <span style={{ fontSize: '10pt', color: '#006666', marginLeft: '4px' }}>â‚¬</span>
                </div>
              )}
              {aktivesDok.typ === "RECHNUNG" && abschlagsrechnungBetrag > 0 && (
                <>
                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '13pt', fontWeight: 'bold', padding: '3mm 0 0 0', borderTop: '1px dashed #006666' }}>
                    <span>Restbetrag</span><span>{restbetragNachAbschlag.toFixed(2)} â‚¬</span>
                  </div>
                </>
              )}
              {abschlagProzent > 0 && (
                <>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '3mm 0 0 0', color: '#006666' }}>
                    <span>Abschlag {abschlagProzent} %</span><span>-{abschlagBetrag.toFixed(2)} â‚¬</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '13pt', fontWeight: 'bold', padding: '2mm 0', borderTop: '1px dashed #006666' }}>
                    <span>Restbetrag</span><span>{restBrutto.toFixed(2)} â‚¬</span>
                  </div>
                </>
              )}
            </div>
            )}
          
            {/* Zahlungsbedingungen/FuÃŸtext (nicht bei Leeres Dokument) */}
            {aktivesDok.typ !== "LEERES_DOKUMENT" && (
            <div style={{ marginTop: '6mm', marginBottom: '6mm', fontSize: '10pt', color: '#444' }}>
              <br/>
              {aktivesDok.typ === "ANGEBOT" ? (
                <>
                  {(firmenDaten.angebotHinweis || "Unvorhergesehene Arbeiten werden mit {stundensatz},- â‚¬/Std. abgerechnet.").replace('{stundensatz}', firmenDaten.stundensatz || 59)}<br/>
                  <br/>
                  Dieses Angebot ist {firmenDaten.angebotsgueltigkeit || 30} Tage ab Ausstellungsdatum gÃ¼ltig.<br/>
                  <br/>
                  Wir freuen uns auf Ihre Auftragserteilung und stehen fÃ¼r RÃ¼ckfragen gerne zur VerfÃ¼gung.<br/>
                </>
              ) : (
                <>
                  Zahlungsbedingungen: Zahlung innerhalb von {firmenDaten.zahlungsziel || 10} Tagen ab Rechnungseingang ohne AbzÃ¼ge.<br/>
                  <br/>
                  {/* Optionales Eingabefeld fÃ¼r zusÃ¤tzlichen Hinweis */}
                  <div className="no-print" style={{ marginBottom: '3mm' }}>
                    <textarea
                      style={{ 
                        width: '100%', 
                        padding: '6px 8px', 
                        fontSize: '10pt', 
                        border: '1px dashed #999', 
                        borderRadius: '4px',
                        backgroundColor: '#f9f9f9',
                        color: '#444',
                        resize: 'vertical',
                        minHeight: '40px'
                      }}
                      value={aktivesDok.rechnungshinweis || ""}
                      onChange={e => setAktivesDok({...aktivesDok, rechnungshinweis: e.target.value})}
                      placeholder="ZusÃ¤tzlicher Hinweis (optional) - z.B. Skonto-Regelung, Lieferhinweise..."
                    />
                  </div>
                  {aktivesDok.rechnungshinweis && (
                    <span className="print-only" style={{ whiteSpace: 'pre-wrap' }}>{aktivesDok.rechnungshinweis}<br/><br/></span>
                  )}
                  Bitte Ã¼berweisen Sie den Rechnungsbetrag unter Angabe der Rechnungsnummer auf das unten angegebene Konto.<br/>
                </>
              )}
              <br/>
              Mit freundlichen GrÃ¼ÃŸen<br/>
              {firmenDaten.inhaberName}
            </div>
            )}

          </div>

          {/* Fixierte FuÃŸzeile â€“ erscheint auf jeder Seite im Druck */}
          <div className="page-footer">
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '8mm', fontSize: '8.5pt' }}>
              <div style={{ textAlign: 'left' }}>
                {firmenDaten.firmenname}<br/>
                {firmenDaten.strasse}<br/>
                {firmenDaten.plz} {firmenDaten.ort}<br/>
                {firmenDaten.land}
              </div>
              <div style={{ textAlign: 'left' }}>
                Tel. {firmenDaten.telefon}<br/>
                E-Mail: {firmenDaten.email}<br/>
                Web: {firmenDaten.website}
              </div>
              <div style={{ textAlign: 'left' }}>
                Steuer-Nr. {firmenDaten.steuernummer}<br/>
                Inhaber: {firmenDaten.inhaberName}
              </div>
              <div style={{ textAlign: 'left' }}>
                Bank: {firmenDaten.bankName}<br/>
                IBAN: {firmenDaten.iban}<br/>
                BIC: {firmenDaten.bic}
              </div>
            </div>
          </div>
        </div>
        </div> {/* Ende Wrapper fÃ¼r Zoom-HÃ¶henberechnung */}

        {/* Privacy Footer - scrollt mit dem A4-Blatt, erscheint nur am Ende */}
        <div className="p-4 md:p-6">
          <div className="privacy-footer no-print">
            {/* Speicher-Warnung bei >90% */}
            {speicherInfo.istKritisch && (
              <div className="bg-red-900/50 border-2 border-red-500 rounded-lg p-4 mb-4 text-center">
                <div className="text-2xl mb-2">âš ï¸</div>
                <strong className="text-red-300 text-sm">Speicher fast voll ({speicherInfo.prozent}%)</strong>
                <p className="text-red-200 text-xs mt-2">
                  Bitte Stammdaten exportieren und mit einem frischen Vault neu starten.
                </p>
              </div>
            )}
            
            {/* Speicher-Ãœbersicht */}
            <div className="bg-slate-800/80 rounded-lg p-3 mb-4 border border-slate-600/30">
              <div className="flex items-center justify-between mb-2 text-xs">
                <span className="text-slate-400 font-semibold">ğŸ’¾ Vault-Speicher</span>
                <span className={speicherInfo.istKritisch ? 'text-red-400' : speicherInfo.istWarnung ? 'text-yellow-400' : 'text-green-400'} style={{fontWeight: 700}}>
                  {speicherInfo.prozent}% belegt ({speicherInfo.belegtKB} KB / {Math.round(speicherInfo.maxDataSize/1024)} KB)
                </span>
              </div>
              <div className="bg-slate-900 rounded h-2 overflow-hidden">
                <div 
                  className={`h-full rounded transition-all ${speicherInfo.istKritisch ? 'bg-red-500' : speicherInfo.istWarnung ? 'bg-yellow-500' : 'bg-green-500'}`}
                  style={{width: `${Math.min(100, speicherInfo.prozent)}%`}}
                />
              </div>
              <div className="flex justify-between mt-1 text-[10px] text-slate-500">
                <span>{appState.kunden?.length || 0} Kunden â€¢ {appState.material?.length || 0} Positionen â€¢ {rechnungen.length} Dokumente</span>
                <span>{speicherInfo.freiKB} KB frei</span>
              </div>
            </div>
            
            <div className="privacy-footer-motto">
              <span className="shield">ğŸ›¡ï¸</span>Wir speichern nichts. Wir sehen nichts.
            </div>
            <p className="privacy-footer-text">
              <strong>Zero-Knowledge-Prinzip:</strong> Ihre Daten werden ausschlieÃŸlich lokal in Ihrem Browser (IndexedDB) gespeichert und Backups mit <strong>AES-256-GCM</strong> verschlÃ¼sselt. Kein Server, keine Cloud, keine Datensammlung â€“ Ihre Rechnungen gehÃ¶ren nur Ihnen.
            </p>
            <div className="privacy-footer-badges">
              <span className="privacy-badge green">âœ“ Lokale Speicherung</span>
              <span className="privacy-badge green">âœ“ Keine Registrierung</span>
              <span className="privacy-badge">ğŸ” MilitÃ¤rgrad-VerschlÃ¼sselung</span>
              <span className="privacy-badge">ğŸ’¾ IndexedDB</span>
              <span className="privacy-badge green">âœ“ DSGVO-konform</span>
            </div>
            <div className="privacy-footer-copyright">
              Â© 2026 Business Suite â€“ Professionelle Rechnungserstellung mit maximaler Datensicherheit
            </div>
          </div>
        </div>
        </div>{/* Ende preview-scroll-area */}
      </div>
      )} {/* Ende activeModule === 'rechnung' Vorschau */}
      
      {/* Zeiterfassungs-Modul Hauptbereich */}
      {activeModule === 'zeit' && (
        <div className="main-content flex-1 pt-14 md:pt-0 pb-20 md:pb-6 flex flex-col bg-slate-100 overflow-y-auto">
          <TimeTrackingModule 
            appState={appState} 
            updateState={updateState} 
            activeProjectId={zeitActiveProjectId}
            onCreateInvoice={(invoiceData) => {
              try {
                // Neues Dokument als Entwurf erstellen
                const neuerEntwurf = {
                  id: null,
                  typ: "RECHNUNG",
                  nummer: "",
                  datum: new Date().toLocaleDateString('de-DE'),
                  leistungszeitraum: invoiceData.leistungszeitraum || { von: "", bis: "" },
                  kunde: { name: "", strasse: "", plz: "", ort: "" },
                  positionen: invoiceData.positionen || [],
                  abschlag: "0",
                  muster: false,
                  arbeitsort: "",
                  abschlagsrechnungBetrag: "0",
                  rabatt: "0",
                  rabattBeschreibung: "Nachlass",
                  betreff: invoiceData.betreff || "",
                  freitext: "",
                  signaturKunde: false,
                  signaturAbsender: false,
                  signaturAbsenderData: "",
                  signaturAbsenderOrt: "",
                  signaturAbsenderDatum: "",
                  rechnungshinweis: "",
                  entwurfId: -Date.now()
                };
                
                // Entwurf speichern
                updateState(prev => ({
                  ...prev,
                  entwuerfe: [...(prev.entwuerfe || []), neuerEntwurf]
                }));
                
                // Dokument setzen und zu Rechnungsmodul wechseln
                setAktivesDok(neuerEntwurf);
                setActiveModule('rechnung');
                
                // Erfolgsbenachrichtigung
                setSuccessMessage(`âœ… Neuer Entwurf mit ${invoiceData.positionen.length} Positionen erstellt!`);
                setTimeout(() => setSuccessMessage(''), 3000);
              } catch (err) {
                console.error('Fehler im onCreateInvoice:', err);
                alert('Fehler beim Erstellen der Rechnung: ' + err.message);
              }
            }}
            speicherInfo={speicherInfo}
          />
        </div>
      )}
      
      {/* Einstellungen-Modul Hauptbereich */}
      {activeModule === 'settings' && (
        <SettingsModule 
          appState={appState} 
          updateState={updateState}
          cloudConfig={cloudConfig}
          setCloudConfig={updateCloudConfig}
          triggerCloudSync={triggerCloudSync}
          restoreFromCloud={restoreFromCloud}
          syncStatus={syncStatus}
          exportFullBackup={exportFullBackup}
          importBackupFile={importBackupFile}
          exportStammdatenFile={() => {
            const stammdaten = {
              kunden: appState.kunden || [],
              material: appState.material || [],
              firmenDaten: appState.firmenDaten || {},
              exportDatum: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(stammdaten, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stammdaten_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
          }}
        />
      )}
      
      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * ACTION BAR - Sticky Bottom (Mobile-First) - Nur bei Rechnungsmodul
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      {activeModule === 'rechnung' && (
      <div className="action-bar-mobile fixed bottom-0 left-0 right-0 md:left-96 z-40 bg-slate-900/95 backdrop-blur border-t border-slate-700 px-3 py-2 no-print">
        <div className="flex items-center gap-2 max-w-4xl mx-auto overflow-x-auto">
          {/* Dokumenttyp Dropdown */}
          <select
            value={aktivesDok.typ}
            onChange={e => setAktivesDok(prev => ({ ...prev, typ: e.target.value }))}
            className="bg-slate-800 text-white text-xs font-bold px-2 py-2.5 rounded-lg border border-slate-600 flex-shrink-0 w-24 sm:w-auto"
          >
            <option value="RECHNUNG">ğŸ“„ RE</option>
            <option value="ANGEBOT">ğŸ“‹ AN</option>
            <option value="ABSCHLAGSRECHNUNG">ğŸ“‘ AR</option>
            <option value="LEERES_DOKUMENT">ğŸ“ LD</option>
          </select>
          
          {/* Neu Button */}
          <button
            onClick={newDok}
            className="bg-teal-600 hover:bg-teal-500 text-white font-bold px-3 py-2.5 rounded-lg text-xs transition-colors"
            title="Neues Dokument"
          >
            â•
          </button>
          
          {/* Spacer */}
          <div className="flex-1" />
          
          {/* Speichern Button (Blau) */}
          <button
            onClick={() => { saveDok(); forceSave(); }}
            className="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-2.5 rounded-lg text-xs flex items-center gap-1.5 transition-colors"
          >
            <span>ğŸ’¾</span>
            <span className="hidden sm:inline">Speichern</span>
          </button>
          
          {/* Drucken Button (Grau) */}
          <button
            onClick={async () => {
              saveDok();
              const loading = showLoadingDialog('ğŸ–¨ï¸ Bereite Druck vor...');
              
              try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                
                const berechnungen = { restNetto, nettoNachRabatt, mwst, brutto, abschlagProzent, abschlagBetrag, restBrutto };
                renderPDFContent(doc, aktivesDok, firmenDaten, berechnungen);
                
                const pdfBlobUrl = doc.output('bloburl');
                
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:0;height:0;border:none;';
                document.body.appendChild(iframe);
                
                iframe.onload = () => {
                  loading.close();
                  setTimeout(() => {
                    try {
                      iframe.contentWindow.focus();
                      iframe.contentWindow.print();
                    } catch (e) {
                      window.open(pdfBlobUrl, '_blank');
                    }
                    setTimeout(() => {
                      document.body.removeChild(iframe);
                      URL.revokeObjectURL(pdfBlobUrl);
                    }, 5000);
                  }, 500);
                };
                
                iframe.src = pdfBlobUrl;
                
              } catch (err) {
                loading.close();
                alert('Druckfehler: ' + err.message);
              }
            }}
            className="bg-slate-600 hover:bg-slate-500 text-white font-bold px-4 py-2.5 rounded-lg text-xs transition-colors"
            title="Drucken"
          >
            ğŸ–¨ï¸
          </button>
          
          {/* Archiv Button (Lila) */}
          <button
            onClick={async () => {
              saveDok();
              const password = await new Promise(resolve => {
                const pw = prompt('ğŸ”’ Archiv-Passwort eingeben:\n\n(Zum EntschlÃ¼sseln benÃ¶tigt)');
                resolve(pw);
              });
              if (!password) return;
              
              const loading = showLoadingDialog('ğŸ”’ Erstelle verschlÃ¼sseltes Archiv...');
              
              try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                
                const berechnungen = { restNetto, nettoNachRabatt, mwst, brutto, abschlagProzent, abschlagBetrag, restBrutto };
                renderPDFContent(doc, aktivesDok, firmenDaten, berechnungen);
                
                const pdfArrayBuffer = doc.output('arraybuffer');
                
                const zugferdXML = generateZUGFeRDXML(aktivesDok, firmenDaten);
                const xmlBytes = new TextEncoder().encode(zugferdXML);
                
                const pdfLength = pdfArrayBuffer.byteLength;
                const xmlLength = xmlBytes.length;
                const headerSize = 8;
                const dataSize = headerSize + pdfLength + xmlLength;
                
                const PADDING_BLOCK = 512 * 1024;
                const paddedSize = Math.ceil(dataSize / PADDING_BLOCK) * PADDING_BLOCK;
                
                const combinedBuffer = new ArrayBuffer(paddedSize);
                const view = new DataView(combinedBuffer);
                const bytes = new Uint8Array(combinedBuffer);
                
                view.setUint32(0, pdfLength, true);
                view.setUint32(4, xmlLength, true);
                bytes.set(new Uint8Array(pdfArrayBuffer), headerSize);
                bytes.set(xmlBytes, headerSize + pdfLength);
                
                const paddingStart = headerSize + pdfLength + xmlLength;
                const paddingSize = paddedSize - dataSize;
                for (let i = 0; i < paddingSize; i += 65536) {
                  const chunk = new Uint8Array(Math.min(65536, paddingSize - i));
                  crypto.getRandomValues(chunk);
                  bytes.set(chunk, paddingStart + i);
                }
                
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                
                const keyMaterial = await crypto.subtle.importKey(
                  'raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                  { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
                  keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
                );
                
                const encrypted = await crypto.subtle.encrypt(
                  { name: 'AES-GCM', iv, tagLength: 128 }, key, combinedBuffer
                );
                
                const finalBuffer = new ArrayBuffer(28 + encrypted.byteLength);
                const finalBytes = new Uint8Array(finalBuffer);
                finalBytes.set(salt, 0);
                finalBytes.set(iv, 16);
                finalBytes.set(new Uint8Array(encrypted), 28);
                
                const fullName = aktivesDok.kunde?.name || 'Unbekannt';
                const cleanName = fullName.replace(/^(Herr|Herrn|Frau|FrÃ¤ulein)\s+/i, '').trim();
                const lastName = cleanName.split(' ').pop().replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼ÃŸ-]/g, '');
                const filename = `${aktivesDok.nummer || 'archiv'}-${lastName}.dat`;
                
                const blob = new Blob([finalBuffer], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                loading.close();
                alert(`âœ… Archiv erstellt!\n\nğŸ“¦ ${filename}\nğŸ“Š ${Math.round(finalBuffer.byteLength / 1024)} KB\nğŸ” AES-256-GCM`);
                
              } catch (err) {
                loading.close();
                alert('Fehler: ' + err.message);
              }
            }}
            className="bg-purple-700 hover:bg-purple-600 text-white font-bold px-4 py-2.5 rounded-lg text-xs transition-colors"
            title="Archivieren"
          >
            ğŸ”’
          </button>
          
          {/* E-Rechnung Button (Indigo) - Nur bei Rechnungen und Abschlagsrechnungen sichtbar */}
          {['RECHNUNG', 'ABSCHLAGSRECHNUNG'].includes(aktivesDok.typ) && (
            <button
              onClick={async () => {
                saveDok();
                const loading = showLoadingDialog('ğŸ“„ Generiere E-Rechnung...');
                
                try {
                  const { jsPDF } = window.jspdf;
                  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                  
                  const berechnungen = { restNetto, nettoNachRabatt, mwst, brutto, abschlagProzent, abschlagBetrag, restBrutto };
                  renderPDFContent(doc, aktivesDok, firmenDaten, berechnungen);
                  
                  const zugferdXML = generateZUGFeRDXML(aktivesDok, firmenDaten);
                  
                  const fullName = aktivesDok.kunde?.name || 'Unbekannt';
                  const cleanName = fullName.replace(/^(Herr|Herrn|Frau|FrÃ¤ulein)\s+/i, '').trim();
                  const lastName = cleanName.split(' ').pop().replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼ÃŸ-]/g, '');
                  const baseName = `${aktivesDok.nummer || 'ENTWURF'}-${lastName}`;
                  
                  doc.save(`${baseName}_ZUGFeRD.pdf`);
                  
                  setTimeout(() => {
                    const xmlBlob = new Blob([zugferdXML], { type: 'application/xml' });
                    const xmlUrl = URL.createObjectURL(xmlBlob);
                    const xmlLink = document.createElement('a');
                    xmlLink.href = xmlUrl;
                    xmlLink.download = `${baseName}_factur-x.xml`;
                    xmlLink.click();
                    URL.revokeObjectURL(xmlUrl);
                  }, 500);
                  
                  loading.close();
                  alert(`âœ… E-Rechnung erstellt!\n\nğŸ“„ ${baseName}_ZUGFeRD.pdf\nğŸ“‹ ${baseName}_factur-x.xml`);
                  
                } catch (err) {
                  loading.close();
                  alert('Fehler: ' + err.message);
                }
              }}
              className="bg-amber-600 hover:bg-amber-500 text-white font-bold px-4 py-2.5 rounded-lg text-xs flex items-center gap-1.5 transition-colors"
              title="E-Rechnung (ZUGFeRD)"
            >
              <span>ğŸ“‹</span>
              <span className="hidden sm:inline">ZUGFeRD</span>
            </button>
          )}
          
          {/* PDF Button (GrÃ¼n) */}
          <button
            onClick={createPDF}
            className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-4 py-2.5 rounded-lg text-xs flex items-center gap-1.5 transition-colors"
            title="PDF erstellen"
          >
            <span>ğŸ“„</span>
            <span className="hidden sm:inline">PDF</span>
          </button>
        </div>
      </div>
      )} {/* Ende activeModule === 'rechnung' Action Bar */}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP WRAPPER MIT VAULT AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function App() {
  return (
    <VaultProvider>
      <VaultApp />
    </VaultProvider>
  );
}

function VaultApp() {
  const { isUnlocked, isLoading } = useVault();
  
  if (isLoading) {
    return (
      <div style={{
        position: 'fixed',
        top: 0, left: 0, right: 0, bottom: 0,
        background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexDirection: 'column',
        color: 'white'
      }}>
        <div style={{ fontSize: '60px', marginBottom: '20px', animation: 'pulse 2s infinite' }}>ğŸ”</div>
        <h1 style={{ fontSize: '20px', color: '#94a3b8' }}>Lade Secure Vault...</h1>
      </div>
    );
  }
  
  if (!isUnlocked) {
    return <LoginScreen />;
  }
  
  return <MainApp />;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
